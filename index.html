<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome to Sbahle Burial Society</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèõÔ∏è</text></svg>">
  
  <!-- Cache Control Headers - Force browsers to check for updates -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Chart.js for Financial Dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #667eea; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .hidden { display: none !important; }
    h1 { color: #333; margin-bottom: 20px; }
    h2 { color: #333; margin: 15px 0; font-size: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab { padding: 8px 15px; background: #e2e8f0; border: none; cursor: pointer; font-weight: 600; border-radius: 5px; }
    .tab.active { background: #667eea; color: white; }
    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 3px; color: #333; font-weight: bold; font-size: 14px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
    input:disabled { background: #f0f0f0; }
    .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; margin-right: 5px; margin-bottom: 5px; font-size: 13px; }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #48bb78; color: white; }
    .btn-danger { background: #f56565; color: white; }
    .btn-warning { background: #ed8936; color: white; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .alert { padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px; }
    .alert-success { background: #c6f6d5; color: #22543d; border-left: 4px solid #48bb78; }
    .alert-error { background: #fed7d7; color: #742a2a; border-left: 4px solid #f56565; }
    .alert-warning { background: #feebc8; color: #7c2d12; border-left: 4px solid #ed8936; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    thead { background: #667eea; color: white; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    tbody tr:hover { background: #f7f7f7; }
    .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block; }
    .badge-active { background: #c6f6d5; color: #22543d; }
    .badge-suspended { background: #fed7d7; color: #742a2a; }
    .badge-pending { background: #feebc8; color: #744210; }
    .badge-approved { background: #bee3f8; color: #2c5282; }
    .stat { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
    .stat h3 { font-size: 12px; margin-bottom: 8px; }
    .stat .value { font-size: 24px; font-weight: bold; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 10px; padding: 25px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .close { float: right; font-size: 20px; cursor: pointer; color: #999; }
    .close:hover { color: #000; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .ben-card { background: #f7f7f7; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 3px solid #667eea; display: block !important; visibility: visible !important; }
    canvas { border: 1px solid #ccc; border-radius: 5px; display: block; margin-bottom: 10px; cursor: crosshair; }
    .file-input { margin-bottom: 10px; }
    .file-label { display: block; padding: 10px; background: #e2e8f0; border: 2px dashed #667eea; border-radius: 5px; text-align: center; cursor: pointer; font-size: 13px; }
    .file-label:hover { background: #cbd5e0; }
    .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999; display: none; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .performance-monitor { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 5px; font-size: 11px; max-width: 200px; z-index: 1000; display: none; }
    .performance-monitor.show { display: block; }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } .header { flex-direction: column; align-items: flex-start; } .performance-monitor { bottom: 60px; } }

    /* Inline style replacements */
    .text-center { text-align: center !important; }
    .justify-center { justify-content: center !important; }
    .mt-10 { margin-top: 10px !important; }
    .mt-5 { margin-top: 5px !important; }
    .fs-12 { font-size: 12px !important; }
    .link-forgot { color: #667eea !important; text-decoration: none !important; font-size: 13px !important; }
    .desc-verify { font-size: 13px !important; color: #666 !important; margin-bottom: 15px !important; }
    .desc-verified { font-size: 13px !important; color: #48bb78 !important; margin-bottom: 15px !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="card">
      <h1 class="text-center">üèõÔ∏è Sbahle Burial Society</h1>
      <div class="tabs justify-center">
        <button class="tab active" onclick="showLoginForm('admin')">Admin</button>
        <button class="tab" onclick="showLoginForm('member')">Member</button>
        <button class="tab" onclick="showLoginForm('register')">Register</button>
      </div>
      <div id="alertMsg"></div>

      <div id="adminForm">
        <h2>Admin Login</h2>
        <div class="form-group"><label>Username</label><input type="text" id="adminEmail" placeholder="Enter your username"></div>
        <div class="form-group"><label>Password</label><input type="password" id="adminPassword" placeholder="Enter your password"></div>
        <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
        <button class="btn btn-warning mt-10 fs-12" onclick="resetAdminCredentials()">üîß Reset Admin Credentials</button>
      </div>

      <div id="memberForm" class="hidden">
        <h2>Member Login</h2>
        <div class="form-group"><label>Email</label><input type="text" id="memberEmail" value="member@test.com"></div>
        <div class="form-group"><label>Password</label><input type="password" id="memberPassword" value="password123"></div>
        <button class="btn btn-primary" onclick="loginMember()">Login</button>
        <p class="text-center mt-10">
          <a href="#" onclick="showForgotPassword(); return false;" class="link-forgot">Forgot Password?</a>
        </p>
      </div>

      <div id="forgotPasswordForm" class="hidden">
        <h2>Reset Password</h2>
        <div id="resetStep1">
          <p class="desc-verify">Enter your email address and ID number to verify your identity.</p>
          <div class="form-group"><label>Email</label><input type="text" id="resetEmail"></div>
          <div class="form-group"><label>ID Number</label><input type="text" id="resetIdNumber" placeholder="Enter your ID number"></div>
          <button class="btn btn-primary" onclick="verifyIdentity()">Verify Identity</button>
          <button class="btn mt-5" onclick="showLoginForm('member')">Back to Login</button>
        </div>
        <div id="resetStep2" class="hidden">
          <p class="desc-verified">‚úÖ Identity verified! Please enter your new password.</p>
            /* Inline style replacements */
            .text-center { text-align: center !important; }
            .justify-center { justify-content: center !important; }
            .mt-10 { margin-top: 10px !important; }
            .mt-5 { margin-top: 5px !important; }
            .fs-12 { font-size: 12px !important; }
            .link-forgot { color: #667eea !important; text-decoration: none !important; font-size: 13px !important; }
            .desc-verify { font-size: 13px !important; color: #666 !important; margin-bottom: 15px !important; }
            .desc-verified { font-size: 13px !important; color: #48bb78 !important; margin-bottom: 15px !important; }
          <div class="form-group"><label>New Password</label><input type="password" id="resetNewPassword" placeholder="Enter new password"></div>
          <div class="form-group"><label>Confirm New Password</label><input type="password" id="resetConfirmPassword" placeholder="Confirm new password"></div>
          <button class="btn btn-success" onclick="resetPassword()">Reset Password</button>
        </div>
      </div>

      <div id="registerForm" class="hidden">
        <h2>Register Member</h2>
        <div class="form-group"><label>Name</label><input type="text" id="regName"></div>
        <div class="form-group"><label>Email</label><input type="text" id="regEmail"></div>
        <div class="form-group"><label>Password</label><input type="password" id="regPassword" placeholder="Create a password"></div>
        <div class="form-group"><label>Confirm Password</label><input type="password" id="regConfirmPassword" placeholder="Confirm your password"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="regPhone"></div>
        <div class="form-group"><label>ID Number</label><input type="text" id="regId"></div>
        <button class="btn btn-success" onclick="registerMember()">Register</button>
      </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminPage" class="card hidden">
      <div class="header">
        <h1>Admin Dashboard</h1>
        <div class="flex align-center gap-15">
          <div id="cloudSyncStatus" class="fs-13 p-5-10 br-5 bg-grey-light">
            <span id="syncIndicator">üîÑ</span> <span id="syncText">Syncing...</span>
          </div>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="adminTab('overview', event)">Overview</button>
        <button class="tab" onclick="adminTab('financials', event)">üìä Financials</button>
        <button class="tab" onclick="adminTab('members', event)">Members</button>
        <button class="tab" onclick="adminTab('beneficiaries', event)">Beneficiaries</button>
        <button class="tab" onclick="adminTab('attendance', event)">Attendance</button>
        <button class="tab" onclick="adminTab('payments', event)">Payment Proofs</button>
        <button class="tab" onclick="adminTab('payouts', event)">Payouts</button>
        <button class="tab" onclick="adminTab('penalties', event)">Penalties</button>
        <button class="tab" onclick="adminTab('minutes', event)">Meeting Minutes</button>
        <button class="tab" onclick="adminTab('constitution', event)">Constitution</button>
        <button class="tab" onclick="adminTab('data', event)">Data Management</button>
      </div>
      <div id="adminAlert"></div>

      <div id="overviewTab">
        <div class="stat"><h3>Total Members</h3><div class="value" id="totalMem">5</div></div>
        <div class="stat"><h3>Active Members</h3><div class="value" id="activeMem">4</div></div>
        <div class="stat"><h3>Suspended</h3><div class="value" id="suspMem">1</div></div>
        <button class="btn btn-warning" onclick="checkMissed()">Check Missed Payments</button>
        <button class="btn btn-warning" onclick="applyPen()">Apply R30 Penalties</button>
      </div>

      <!-- FINANCIAL DASHBOARD TAB -->
      <div id="financialsTab" class="hidden">
        <h2>üìä Financial Dashboard</h2>
        <div class="bg-info-box">
          <p><strong>üìà Track income, expenses, and financial trends</strong></p>
          <p class="mt-10 text-muted">Comprehensive view of society's financial health with charts and reports</p>
        </div>

        <!-- Financial Summary Cards -->
        <div class="grid-auto-250 gap-15 mb-25">
          <div class="stat bg-gradient-green2">
            <h3>Total Income (All Time)</h3>
            <div class="value fs-28" id="totalIncome">R 0</div>
          </div>
          <div class="stat bg-gradient-red">
            <h3>Total Payouts</h3>
            <div class="value fs-28" id="totalPayouts">R 0</div>
          </div>
          <div class="stat bg-gradient-orange">
            <h3>Total Penalties</h3>
            <div class="value fs-28" id="totalPenalties">R 0</div>
          </div>
          <div class="stat bg-gradient-blue">
            <h3>Net Balance</h3>
            <div class="value fs-28" id="netBalance">R 0</div>
          </div>
        </div>

        <!-- Time Period Filter -->
        <div class="bg-filter-box">
          <label class="mr-10 fw-bold">Filter by Period:</label>
          <select id="financialPeriod" onchange="updateFinancialDashboard()" class="w-auto mr-10">
            <option value="all">All Time</option>
            <option value="thisYear">This Year</option>
            <option value="last6months">Last 6 Months</option>
            <option value="last3months">Last 3 Months</option>
            <option value="thisMonth">This Month</option>
          </select>
          <button class="btn btn-primary btn-sm" onclick="exportFinancialReport()">üì• Export PDF Report</button>
          <button class="btn btn-success btn-sm" onclick="refreshFinancialDashboard()">üîÑ Refresh</button>
        </div>

        <!-- Charts Section -->
        <div class="grid-auto-400 gap-20 mb-25">
          <!-- Income vs Expenses Chart -->
          <div class="bg-white-box-lg">
            <h3 class="mb-15 text-dark2">Income vs Payouts</h3>
            <canvas id="incomeVsExpensesChart" class="mh-300"></canvas>
          </div>

          <!-- Payment Trends Chart -->
          <div class="bg-white-box-lg">
            <h3 class="mb-15 text-dark2">Monthly Payment Trends</h3>
            <canvas id="monthlyTrendsChart" class="mh-300"></canvas>
          </div>
        </div>

        <!-- Member Contribution Status -->
        <div class="bg-white-box-lg mb-25">
          <h3 class="mb-15 text-dark2">Member Contribution Overview</h3>
          <canvas id="memberContributionChart" class="mh-300"></canvas>
        </div>

        <!-- Financial Breakdown Tables -->
        <div class="grid-auto-350 gap-20">
          <!-- Top Contributors -->
          <div>
            <h3 class="mb-10 text-dark2">üèÜ Top Contributors</h3>
            <table class="fs-12">
              <thead>
                <tr><th>Member</th><th>Total Contributed</th><th>Status</th></tr>
              </thead>
              <tbody id="topContributorsTable">
                <tr><td colspan="3" class="text-center text-grey">Loading...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Recent Payouts -->
          <div>
            <h3 class="mb-10 text-dark2">üí∏ Recent Payouts</h3>
            <table class="fs-12">
              <thead>
                <tr><th>Member</th><th>Amount</th><th>Date</th></tr>
              </thead>
              <tbody id="recentPayoutsTable">
                <tr><td colspan="3" class="text-center text-grey">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="membersTab" class="hidden">
        <h2>Members</h2>
        <button class="btn btn-success" onclick="addMemberModal()">+ Add Member</button>
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Registered</th><th>Status</th><th>Missed</th><th>Contrib Status</th><th>Actions</th></tr></thead>
          <tbody id="memTable"></tbody>
        </table>
      </div>

      <div id="beneficiariesTab" class="hidden">
        <h2>Beneficiaries</h2>
        <div class="form-group">
          <label>Select Member</label>
          <select id="memSelectBen" onchange="loadBeneficiaries()">
            <option value="">-- Select --</option>
          </select>
        </div>
        <button class="btn btn-success d-none" id="addBenBtn" onclick="addBenModal()">+ Add Beneficiary</button>
        <button class="btn btn-primary d-none" id="payoutBenBtn" onclick="createPayoutModal()">üí∞ Create Payout</button>
        <table id="benTable"><thead><tr><th>Name</th><th>Relationship</th><th>ID</th><th>%</th><th>Actions</th></tr></thead><tbody id="benTableBody"></tbody></table>
      </div>

      <div id="paymentsTab" class="hidden">
        <h2>Payment Proofs - All Members</h2>
        <div class="bg-info-box">
          <p><strong>üì§ Review and approve member payment proofs</strong></p>
          <p class="mt-10 text-muted">View uploaded payment proofs, verify files, and approve submissions</p>
        </div>
        <table>
          <thead>
            <tr>
              <th>Member</th>
              <th>Upload Date</th>
              <th>Amount</th>
              <th>Description</th>
              <th>File</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminPaymentProofsTable"></tbody>
        </table>
      </div>

      <div id="payoutsTab" class="hidden">
        <h2>Payouts</h2>
        <table>
          <thead><tr><th>Member</th><th>Amount</th><th>Reason</th><th>Recipients</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="payTable"></tbody>
        </table>
      </div>

      <div id="penaltiesTab" class="hidden">
        <h2>Penalties</h2>
        <table>
          <thead><tr><th>Member</th><th>Amount</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="penTable"></tbody>
        </table>
      </div>

      <div id="attendanceTab" class="hidden">
        <h2>Meeting Attendance</h2>
        <div class="bg-info-box">
          <p><strong>üìã Manage meeting attendance and track member participation</strong></p>
          <p class="mt-10 text-muted">Track attendance, manage meetings, and generate reports</p>
        </div>

        <!-- Meeting Details Section -->
        <div class="grid-2 gap-15">
          <div class="form-group m-0">
            <label>Meeting Date</label>
            <input type="date" id="meetingDate" onchange="showAttendanceList()">
          </div>
          <div class="form-group m-0">
            <label>Meeting Time</label>
            <input type="time" id="meetingTime" onchange="updateMeetingDetails()">
          </div>
        </div>
      
        <div class="grid-2 gap-15 mt-15">
          <div class="form-group m-0">
            <label>Meeting Type</label>
            <select id="meetingType" onchange="updateMeetingDetails()">
              <option value="general">General Meeting</option>
              <option value="committee">Committee Meeting</option>
              <option value="special">Special Meeting</option>
              <option value="emergency">Emergency Meeting</option>
            </select>
          </div>
          <div class="form-group m-0">
            <label>Meeting Description</label>
            <textarea id="meetingDesc" rows="2" onchange="updateMeetingDetails()" 
                      placeholder="Brief description of meeting agenda/purpose"></textarea>
          </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="bg-filter-box">
          <div class="grid-2 gap-15">
            <div class="form-group m-0">
              <input type="text" id="memberSearch" 
                     placeholder="Search members..." 
                     onkeyup="filterAttendanceMembers()"
                     class="m-0">
            </div>
            <div class="flex gap-10">
              <select id="statusFilter" onchange="filterAttendanceMembers()" class="w-auto">
                <option value="all">All Status</option>
                <option value="present">Present Only</option>
                <option value="absent">Absent Only</option>
              </select>
              <select id="sortBy" onchange="filterAttendanceMembers()" class="w-auto">
                <option value="name">Sort by Name</option>
                <option value="time">Sort by Time In</option>
                <option value="status">Sort by Status</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Attendance Stats -->
        <div class="bg-stats-box">
          <div class="flex-between flex-wrap gap-10">
            <div>
              <span id="presentCount" class="badge badge-active mr-10">Present: 0</span>
                /* More inline style replacements */
                .d-none { display: none !important; }
                .bg-info-box { background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                .text-muted { color: #4a5568 !important; }
                .gap-15 { gap: 15px !important; }
                .m-0 { margin: 0 !important; }
                .mt-15 { margin-top: 15px !important; }
                .bg-filter-box { background: #edf2f7; padding: 15px; border-radius: 8px; margin: 20px 0; }
                .flex { display: flex !important; }
                .gap-10 { gap: 10px !important; }
                .w-auto { width: auto !important; display: inline-block !important; }
                .bg-stats-box { background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                .flex-between { display: flex !important; justify-content: space-between !important; align-items: center !important; }
                .flex-wrap { flex-wrap: wrap !important; }
                .mr-10 { margin-right: 10px !important; }
              <span id="absentCount" class="badge badge-suspended mr-10">Absent: 0</span>
              <span id="attendanceRate" class="badge badge-approved">Attendance Rate: 0%</span>
            </div>
            <div>
              <button class="btn btn-primary btn-sm" onclick="markAllPresent()">Mark All Present</button>
              <button class="btn btn-warning btn-sm" onclick="clearAttendance()">Clear All</button>
              <button class="btn btn-success" onclick="downloadAttendanceRegister()" id="downloadRegisterBtn">
                <span class="mr-5">üì•</span> Download Register
              </button>
            </div>
          </div>
        </div>

        <!-- Attendance List -->
        <div class="table-container mt-20 overflow-x-auto">
          <table class="table w-100">
            <thead>
              <tr>
                <th>#</th>
                <th>Member Name</th>
                <th>Status</th>
                <th>Time In</th>
                <th>Remarks</th>
                <th class="text-center">Latest Signature</th>
                .mr-5 { margin-right: 5px !important; }
                .mt-20 { margin-top: 20px !important; }
                .overflow-x-auto { overflow-x: auto !important; }
                .w-100 { width: 100% !important; }
              </tr>
            </thead>
            <tbody id="attendanceTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div id="minutesTab" class="hidden">
        <h2>Meeting Minutes</h2>
        <button class="btn btn-success" onclick="addMinutesModal()">+ Add Meeting Minutes</button>
        <table>
          <thead><tr><th>Date</th><th>Subject / Attachment</th><th>Posted By</th><th>Actions</th></tr></thead>
          <tbody id="minutesTable"></tbody>
        </table>
      </div>

      <div id="constitutionTab" class="hidden">
        <h2>Society Constitution</h2>
        <div class="bg-info-box border-left-blue">
          <p><strong>üìú Upload and manage the society constitution document</strong></p>
          <p class="mt-10 text-muted">Members can view and download the constitution from their dashboard</p>
        </div>

        <!-- Upload Section -->
        <div class="bg-white-box mb-20">
          <h3 class="mb-15">üì§ Upload Constitution</h3>
          <div class="form-group">
            <label>Select Document (PDF, DOC, DOCX)</label>
            <input type="file" id="constitutionFile" accept=".pdf,.doc,.docx" class="input-box">
          </div>
          <div class="form-group">
            <label>Document Title</label>
            <input type="text" id="constitutionTitle" placeholder="e.g., Sbahle Burial Society Constitution 2025" class="input-box">
          </div>
          <div class="form-group">
            <label>Version / Notes (Optional)</label>
            <input type="text" id="constitutionNotes" placeholder="e.g., Version 2.0 - Amended November 2025" class="input-box">
          </div>
          <button class="btn btn-success" onclick="uploadConstitution()">
            üì§ Upload Constitution
          </button>
        </div>

        <!-- Current Constitution Section -->
        <div id="currentConstitutionSection" class="bg-green-box d-none">
          <h3 class="mb-15 text-green">‚úÖ Current Constitution</h3>
          <div class="bg-white-box-sm mb-15">
            <p class="mb-5"><strong>Title:</strong> <span id="constitutionTitleDisplay"></span></p>
            <p class="mb-5"><strong>Uploaded:</strong> <span id="constitutionDateDisplay"></span></p>
            <p class="mb-5"><strong>File Size:</strong> <span id="constitutionSizeDisplay"></span></p>
            <p class="mb-0"><strong>Notes:</strong> <span id="constitutionNotesDisplay"></span></p>
          </div>
          <div class="flex gap-10">
            <button class="btn btn-primary" onclick="viewConstitution()">
              üëÅÔ∏è View Document
            </button>
            <button class="btn btn-warning" onclick="downloadConstitution()">
              üì• Download
            </button>
            <button class="btn btn-danger" onclick="deleteConstitution()">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>

        <!-- No Constitution Uploaded -->
        <div id="noConstitutionSection" class="bg-orange-box">
          <p class="m-0 text-orange"><strong>‚ö†Ô∏è No constitution uploaded yet</strong></p>
          <p class="mt-10 text-muted">Upload a constitution document so members can access it from their dashboard.</p>
        </div>
      </div>

      <div id="dataTab" class="hidden">
        <h2>Data Management</h2>
        <div class="bg-light-green-box border-left-green">
          <p class="mb-10"><strong>ÔøΩ BACKUP & RESTORE SYSTEM</strong></p>
          <p class="mb-5 fs-13">‚úÖ Export: Download complete backup including signatures, beneficiaries, payment proofs</p>
          <p class="mb-0 fs-13">‚úÖ Import: Restore from previous backup file (all data will be replaced)</p>
          .border-left-blue { border-left: 4px solid #667eea !important; }
          .mb-20 { margin-bottom: 20px !important; }
          .bg-white-box { background: white !important; padding: 20px !important; border: 1px solid #ddd !important; border-radius: 8px !important; }
          .mb-15 { margin-bottom: 15px !important; }
          .input-box { padding: 10px !important; border: 1px solid #ddd !important; border-radius: 5px !important; width: 100% !important; }
          .bg-green-box { background: #e8f5e9 !important; padding: 20px !important; border: 1px solid #4caf50 !important; border-radius: 8px !important; }
          .text-green { color: #2e7d32 !important; }
          .bg-white-box-sm { background: white !important; padding: 15px !important; border-radius: 5px !important; }
          .mb-5 { margin-bottom: 5px !important; }
          .mb-0 { margin-bottom: 0 !important; }
          .bg-orange-box { background: #fff3e0 !important; padding: 20px !important; border: 1px solid #ff9800 !important; border-radius: 8px !important; }
          .m-0 { margin: 0 !important; }
          .text-orange { color: #e65100 !important; }
          .bg-light-green-box { background: #dcfce7 !important; padding: 15px !important; border-radius: 8px !important; margin-bottom: 20px !important; }
          .border-left-green { border-left: 4px solid #16a34a !important; }
          .mb-10 { margin-bottom: 10px !important; }
          .mb-5 { margin-bottom: 5px !important; }
          .fs-13 { font-size: 13px !important; }
        </div>
        
        <div class="grid gap-15">
          <div class="bg-gradient-blue p-20 br-8 text-white">
            <h3 class="mb-10 fs-18 text-white">üíæ DOWNLOAD COMPLETE BACKUP</h3>
            <p class="mb-15 fs-13 op-09">Save everything: Members, signatures, beneficiaries, payment proofs, meeting minutes, attendance records</p>
            <button class="btn btn-white-blue fs-14 fw-bold" onclick="exportData()">üì• Download Backup Now</button>
          </div>
          
          <div class="bg-gradient-green p-20 br-8 text-white">
            <h3 class="mb-10 fs-18 text-white">üì§ RESTORE FROM BACKUP</h3>
            <p class="mb-15 fs-13 op-09">Upload a previously saved backup file to restore all data</p>
            <input type="file" id="importFile" accept=".json" class="mb-10 p-8 br-5 bg-white">
            <button class="btn btn-white-green fs-14 fw-bold" onclick="document.getElementById('importFile').files[0] && importData(document.getElementById('importFile').files[0])">üì§ Restore Backup</button>
          </div>
          
          <div class="bg-white-box-sm">
            <h3 class="mb-10 fs-16">‚òÅÔ∏è Cloud Sync Status</h3>
            <div id="syncHealthDisplay" class="mb-15">
              <div class="grid-2 gap-10 mb-10">
                <div class="p-10 bg-light br-5">
                  <div class="fs-12 text-muted">Total Syncs</div>
                  <div id="syncTotalCount" class="fs-20 fw-bold text-blue">0</div>
                </div>
                <div class="p-10 bg-light br-5">
                  <div class="fs-12 text-muted">Success Rate</div>
                  <div id="syncSuccessRate" class="fs-20 fw-bold text-green">N/A</div>
                </div>
                <div class="p-10 bg-light br-5">
                  <div class="fs-12 text-muted">Consecutive Failures</div>
                  <div id="syncFailures" class="fs-20 fw-bold text-red">0</div>
                </div>
                <div class="p-10 bg-light br-5">
                  <div class="fs-12 text-muted">Avg Sync Time</div>
                  <div id="syncAvgTime" class="fs-20 fw-bold text-purple">0ms</div>
                </div>
              </div>
              <div class="p-10 bg-light br-5 mb-10">
                <div class="fs-12 text-muted mb-5">Last Successful Sync</div>
                <div id="syncLastSuccess" class="fs-14 fw-500 text-dark">Never</div>
              </div>
              <div class="p-10 bg-light br-5">
                <div class="fs-12 text-muted mb-5">Sync Queue</div>
                <div id="syncQueueSize" class="fs-14 fw-500 text-dark">0 operations pending</div>
              </div>
            </div>
            <div class="flex gap-10 flex-wrap">
              <button class="btn btn-primary flex-1" onclick="forceSyncNow()">üîÑ Force Sync Now</button>
              <button class="btn btn-secondary flex-1" onclick="displaySyncHealth()">üìä Refresh Stats</button>
              .fs-18 { font-size: 18px !important; }
              .op-09 { opacity: 0.9 !important; }
              .btn-white-blue { background: white !important; color: #667eea !important; }
              .btn-white-green { background: white !important; color: #16a34a !important; }
              .fs-14 { font-size: 14px !important; }
              .fw-bold { font-weight: bold !important; }
              .bg-gradient-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
              .bg-gradient-green { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%) !important; }
              .p-20 { padding: 20px !important; }
              .br-8 { border-radius: 8px !important; }
              .text-white { color: white !important; }
              .mb-15 { margin-bottom: 15px !important; }
              .mb-10 { margin-bottom: 10px !important; }
              .fs-16 { font-size: 16px !important; }
              .mb-5 { margin-bottom: 5px !important; }
              .fw-500 { font-weight: 500 !important; }
              .text-dark { color: #333 !important; }
              .bg-light { background: #f8f9fa !important; }
              .br-5 { border-radius: 5px !important; }
              .mb-10 { margin-bottom: 10px !important; }
              .fs-12 { font-size: 12px !important; }
              .text-blue { color: #667eea !important; }
              .text-green { color: #10b981 !important; }
              .text-red { color: #ef4444 !important; }
              .text-purple { color: #8b5cf6 !important; }
              .fs-20 { font-size: 20px !important; }
              .flex-1 { flex: 1 1 0 !important; }
            </div>
          </div>
          
          <div class="bg-white-box-sm">
            <h3 class="mb-10 fs-16">üíæ Automated Backups</h3>
            
            <div id="pendingBackupNotice" class="d-none bg-yellow-box">
              <p class="m-0 fs-13 text-brown"><strong>üìß Weekly Backup Ready!</strong></p>
              <p class="mt-5 fs-12 text-dark-brown">A weekly backup is available for download.</p>
              <button class="btn btn-warning mt-10 fs-13" onclick="downloadPendingEmailBackup()">üì• Download Weekly Backup</button>
            </div>
            
            <div class="grid-auto-200 gap-10 mb-15">
              <div class="p-12 bg-light br-6 text-center">
                <div class="fs-11 text-muted mb-5">Last Weekly Backup</div>
                <div id="lastWeeklyBackup" class="fs-13 fw-600 text-dark">Never</div>
              </div>
              <div class="p-12 bg-light br-6 text-center">
                <div class="fs-11 text-muted mb-5">Last Monthly Download</div>
                <div id="lastMonthlyBackup" class="fs-13 fw-600 text-dark">Never</div>
              </div>
              <div class="p-12 bg-light br-6 text-center">
                <div class="fs-11 text-muted mb-5">Backup Snapshots</div>
                <div id="backupSnapshotCount" class="fs-13 fw-600 text-dark">0</div>
              </div>
            </div>
            
            <div class="flex gap-10 flex-wrap">
              <button class="btn btn-success flex-1" onclick="downloadBackupFile('manual')">üíæ Download Backup Now</button>
              <button class="btn btn-secondary flex-1" onclick="showBackupSnapshots()">üìã View Snapshots</button>
            </div>
            
            <div id="snapshotsList" class="d-none mt-15 maxh-200 overflow-y-auto bg-light p-10 br-6">
              <h4 class="m-0 mb-10 fs-14">Available Snapshots:</h4>
                .bg-yellow-box { background: #fef3c7 !important; padding: 12px !important; border-radius: 6px !important; margin-bottom: 15px !important; border-left: 4px solid #f59e0b !important; }
                .text-brown { color: #92400e !important; }
                .text-dark-brown { color: #78350f !important; }
                .mt-5 { margin-top: 5px !important; }
                .grid-auto-200 { display: grid !important; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important; }
                .gap-10 { gap: 10px !important; }
                .mb-15 { margin-bottom: 15px !important; }
                .p-12 { padding: 12px !important; }
                .br-6 { border-radius: 6px !important; }
                .text-center { text-align: center !important; }
                .fs-11 { font-size: 11px !important; }
                .fw-600 { font-weight: 600 !important; }
                .maxh-200 { max-height: 200px !important; }
                .overflow-y-auto { overflow-y: auto !important; }
                .p-10 { padding: 10px !important; }
                .m-0 { margin: 0 !important; }
                .mb-10 { margin-bottom: 10px !important; }
                .fs-14 { font-size: 14px !important; }
              <div id="snapshotsContent"></div>
            </div>
          </div>
          
          <!-- MULTI-ADMIN MANAGEMENT SECTION -->
          <div class="bg-white-box-sm">
            <h3 class="mb-10 fs-16">üë• Admin Users & Roles</h3>
            <div class="bg-info-box-sm mb-15 border-left-cyan">
              <p class="m-0 fs-13"><strong>Role-Based Access Control</strong></p>
              <p class="mt-5 fs-12 text-cyan-dark">Manage multiple administrators with different permission levels</p>
            </div>
            
            <!-- Current Admin Display -->
            <div class="bg-light p-12 br-6 mb-15">
              <div class="fs-12 text-muted mb-5">Currently Logged In As:</div>
              <div class="fs-14 fw-600 text-dark">
                <span id="currentAdminDisplay">admin (Full Admin)</span>
                <span id="currentAdminRole" class="ml-10 p-3-8 br-12 fs-11 bg-green-light text-green-dark">FULL ADMIN</span>
              </div>
            </div>
            
            <!-- Admin List -->
            <div class="mb-15">
              <div class="flex-between mb-10">
                <h4 class="m-0 fs-14">All Administrators</h4>
                <button class="btn btn-success btn-sm" onclick="showAddAdminModal()">+ Add Admin</button>
              </div>
              <table class="fs-12">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Created</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="adminUsersTable">
                  <tr><td colspan="5" class="text-center text-grey">Loading...</td></tr>
                </tbody>
              </table>
            </div>
            
            <!-- Role Descriptions -->
            <details class="bg-light p-12 br-6">
              <summary class="pointer fw-600 fs-13 text-dark">‚ÑπÔ∏è Role Descriptions</summary>
              <div class="mt-10 fs-12">
                <div class="mb-8 p-8 bg-white br-4">
                  <strong class="text-green-dark">Full Admin:</strong> Complete access to all features including managing other admins, financial data, and system settings
                </div>
                <div class="mb-8 p-8 bg-white br-4">
                  <strong class="text-blue-dark">Secretary:</strong> Manage members, attendance, meeting minutes. View-only access to financials
                </div>
                <div class="mb-0 p-8 bg-white br-4">
                  <strong class="text-orange-dark">Treasurer:</strong> Manage payments, payouts, penalties. View-only access to members
                  .bg-info-box-sm { background: #f0f9ff !important; padding: 12px !important; border-radius: 6px !important; }
                  .border-left-cyan { border-left: 4px solid #0ea5e9 !important; }
                  .mt-5 { margin-top: 5px !important; }
                  .text-cyan-dark { color: #0c4a6e !important; }
                  .p-12 { padding: 12px !important; }
                  .br-6 { border-radius: 6px !important; }
                  .fw-600 { font-weight: 600 !important; }
                  .ml-10 { margin-left: 10px !important; }
                  .p-3-8 { padding: 3px 8px !important; }
                  .br-12 { border-radius: 12px !important; }
                  .fs-11 { font-size: 11px !important; }
                  .bg-green-light { background: #c6f6d5 !important; }
                  .text-green-dark { color: #22543d !important; }
                  .mb-10 { margin-bottom: 10px !important; }
                  .pointer { cursor: pointer !important; }
                  .mt-10 { margin-top: 10px !important; }
                  .mb-8 { margin-bottom: 8px !important; }
                  .p-8 { padding: 8px !important; }
                  .br-4 { border-radius: 4px !important; }
                  .text-blue-dark { color: #2c5282 !important; }
                  .text-orange-dark { color: #744210 !important; }
                  .text-grey { color: #999 !important; }
                </div>
              </div>
            </details>
            
            <!-- Audit Log Preview -->
            <div class="mt-15">
              <div class="flex-between mb-10">
                <h4 class="m-0 fs-14">Recent Admin Actions</h4>
                <button class="btn btn-secondary btn-sm" onclick="showFullAuditLog()">View Full Log</button>
              </div>
              <div id="auditLogPreview" class="maxh-150 overflow-y-auto bg-light p-10 br-6 fs-12">
                <div class="text-grey text-center">No recent actions</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white-box-sm">
            <h3 class="mb-10 fs-16">üíæ Manual Save</h3>
            <p class="text-muted fs-13 mb-10">Force save all current data (normally happens automatically).</p>
            <button class="btn btn-primary" onclick="saveDataToStorage() && showAlert('adminAlert', '‚úì Data saved successfully!', 'success')">Save Now</button>
          </div>
          
          <div class="bg-orange-light-box">
            <h3 class="mb-10 fs-16">‚ö† Clear All Data</h3>
            <p class="text-muted fs-13 mb-10">Permanently delete all data and reset the system.</p>
            <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
          </div>
          
          <div class="bg-info-box border-blue">
            <h3 class="mb-15 fs-16">üìä System Overview</h3>
            <div class="grid-auto-150 gap-10">
              <div class="text-center p-10 bg-white br-5">
                <div id="totalMembers" class="fs-24 fw-bold text-green">0</div>
                <div class="fs-12 text-muted">Total Members</div>
              </div>
              <div class="text-center p-10 bg-white br-5">
                <div id="totalMeetings" class="fs-24 fw-bold text-blue2">0</div>
                <div class="fs-12 text-muted">Total Meetings</div>
              </div>
              <div class="text-center p-10 bg-white br-5">
                <div id="totalBeneficiaries" class="fs-24 fw-bold text-purple">0</div>
                <div class="fs-12 text-muted">Beneficiaries</div>
              </div>
              <div class="text-center p-10 bg-white br-5">
                <div id="totalPayouts" class="fs-24 fw-bold text-orange">0</div>
                <div class="fs-12 text-muted">Payouts</div>
              </div>
            </div>
            <div class="mt-15 p-10 bg-white br-5">
              <div class="fs-13 text-muted">
                <strong>Last Saved:</strong> <span id="lastSavedTime">Never</span><br>
                <strong>Data Version:</strong> <span id="dataVersion">2.0</span><br>
                <strong>Storage Size:</strong> <span id="storageSize">Calculating...</span>
                .mt-15 { margin-top: 15px !important; }
                .maxh-150 { max-height: 150px !important; }
                .bg-orange-light-box { background: #fff4e6 !important; padding: 15px !important; border: 1px solid #ed8936 !important; border-radius: 8px !important; }
                .border-blue { border: 1px solid #3b82f6 !important; }
                .grid-auto-150 { display: grid !important; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important; }
                .p-10 { padding: 10px !important; }
                .bg-white { background: white !important; }
                .br-5 { border-radius: 5px !important; }
                .fs-24 { font-size: 24px !important; }
                .fw-bold { font-weight: bold !important; }
                .text-green { color: #10b981 !important; }
                .text-blue2 { color: #3b82f6 !important; }
                .text-orange { color: #f59e0b !important; }
              </div>
            </div>
          </div>
          
          <div class="bg-white-box-sm">
            <h3 class="mb-10 fs-16">ÔøΩ Detailed Storage Info</h3>
            <p class="text-muted fs-13"><strong>Members:</strong> <span id="storageMembers">0</span></p>
            <p class="text-muted fs-13"><strong>Beneficiaries:</strong> <span id="storageBeneficiaries">0</span></p>
            <p class="text-muted fs-13"><strong>Payouts:</strong> <span id="storagePayouts">0</span></p>
            <p class="text-muted fs-13"><strong>Penalties:</strong> <span id="storagePenalties">0</span></p>
            <p class="text-muted fs-13"><strong>Attendance Records:</strong> <span id="storageAttendance">0</span></p>
            <p class="text-muted fs-13 mb-0"><strong>Active Members:</strong> <span id="storageActiveMembers">0</span></p>
            .grid-auto-250 { display: grid !important; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important; }
            .mb-25 { margin-bottom: 25px !important; }
            .bg-gradient-green2 { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important; }
            .fs-28 { font-size: 28px !important; }
            .bg-gradient-red { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%) !important; }
            .bg-gradient-orange { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%) !important; }
            .bg-gradient-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
            .bg-filter-box { background: #edf2f7 !important; padding: 15px !important; border-radius: 8px !important; margin-bottom: 20px !important; }
            .mr-10 { margin-right: 10px !important; }
            .fw-bold { font-weight: bold !important; }
            .grid-auto-400 { display: grid !important; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)) !important; }
            .gap-20 { gap: 20px !important; }
            .bg-white-box-lg { background: white !important; border: 1px solid #e2e8f0 !important; border-radius: 8px !important; padding: 20px !important; }
            .text-dark2 { color: #2d3748 !important; }
            .mh-300 { max-height: 300px !important; }
            .mb-25 { margin-bottom: 25px !important; }
            .grid-auto-350 { display: grid !important; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)) !important; }
          </div>
        </div>
      </div>
    </div>

    <!-- MEMBER DASHBOARD -->
    <div id="memberPage" class="card hidden">
      <div class="header">
        <h1>Member Dashboard</h1>
        <div class="flex align-center gap-15">
          <div id="memberCloudSyncStatus" class="fs-13 p-5-10 br-5 bg-grey-light">
            <span id="memberSyncIndicator">üîÑ</span> <span id="memberSyncText">Syncing...</span>
          </div>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="memberTab('profile', event)">Profile</button>
        <button class="tab" onclick="memberTab('signature', event)">Signature</button>
        <button class="tab" onclick="memberTab('contributions', event)">Contributions</button>
        <button class="tab" onclick="memberTab('beneficiaries', event)">Beneficiaries</button>
        <button class="tab" onclick="memberTab('payouts', event)">Payouts</button>
        <button class="tab" onclick="memberTab('minutes', event)">Meeting Minutes</button>
        <button class="tab" onclick="memberTab('payments', event)">Payment Proofs</button>
        <button class="tab" onclick="memberTab('constitution', event)">Constitution</button>
        <button class="tab" onclick="memberTab('documents', event)">Documents</button>
      </div>
      <div id="memberAlert"></div>

      <div id="memberProfileTab">
        <h2>Profile</h2>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="memberProfName" disabled>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="text" id="memberProfEmail" disabled>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="text" id="memberProfPhone" disabled>
        </div>
        <div class="form-group">
          <label>ID Number</label>
          <input type="text" id="memberProfIdNumber" disabled>
        </div>
        <div class="form-group">
          <label>Role</label>
          <input type="text" id="profRole" disabled>
        </div>
        <button class="btn btn-warning" onclick="editMemberProf()">Edit Profile</button>
        <button class="btn btn-success hidden" id="saveMemberProf" onclick="saveMemberProf()">Save Changes</button>
      </div>

      <div id="memberSignatureTab" class="hidden">
        <h2>Digital Signature</h2>
        <div class="bg-info-box border-left-blue">
          <p><strong>‚úçÔ∏è Draw your signature below:</strong></p>
        </div>
        <canvas id="signatureCanvas" width="600" height="200"></canvas>
        <div class="mb-15">
          <button class="btn btn-warning" onclick="clearSignature()">Clear</button>
          <button class="btn btn-success" onclick="saveSignature()">Save Signature</button>
        </div>
        <div id="currentSignature" class="d-none">
          <h3>Your Current Signature:</h3>
          <img id="savedSignature" class="mw-100 brd-1-ddd br-5">
        </div>
      </div>

      <div id="memberContributionsTab" class="hidden">
        <h2>My Contributions</h2>
        <p class="text-muted mb-15">Monthly Contribution Required: <strong class="text-blue">R 170</strong></p>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="memberContribTable">
            <tr><td colspan="4" class="text-center text-grey">No contributions recorded</td></tr>
          </tbody>
        </table>
      </div>

      <div id="memberBeneficiariesTab" class="hidden">
        <h2>My Beneficiaries</h2>
        <p class="text-muted mb-15">You can add up to 5 beneficiaries. Total allocation must equal 100%.</p>
        <button class="btn btn-success" id="addBenMemBtn" onclick="addBenMemModal()">+ Add Beneficiary</button>
        <button class="btn btn-primary hidden" id="saveBenMemBtn" onclick="saveBenMem()">Save & Lock</button>
        
        <table class="mt-20">
          <thead>
            <tr>
              <th>Name</th>
              <th>Relationship</th>
              <th>ID Number</th>
              <th>Allocation %</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="memBenTableBody">
            <tr><td colspan="5" class="text-center text-grey">No beneficiaries added yet</td></tr>
            .align-center { align-items: center !important; }
            .gap-15 { gap: 15px !important; }
            .fs-13 { font-size: 13px !important; }
            .p-5-10 { padding: 5px 10px !important; }
            .br-5 { border-radius: 5px !important; }
            .bg-grey-light { background: #e2e8f0 !important; }
            .mb-15 { margin-bottom: 15px !important; }
            .mw-100 { max-width: 100% !important; }
            .brd-1-ddd { border: 1px solid #ddd !important; }
            .mt-20 { margin-top: 20px !important; }
          </tbody>
        </table>
        
        <!-- Payout Collectors Section -->
        <div class="mt-40 pt-30 border-top-grey">
          <h2 class="mb-10">Payout Collectors</h2>
          <p class="text-muted mb-15">Assign up to 2 people who can collect payouts on your behalf.</p>
          <button class="btn btn-primary" onclick="managePayoutCollectorsModal()">üë• Manage Payout Collectors</button>
          
          <div id="payoutCollectorsDisplay" class="mt-20">
            <!-- Collectors will be displayed here -->
          </div>
        </div>
      </div>

      <div id="memberPayoutsTab" class="hidden">
        <h2>Request Payout</h2>
        <button class="btn btn-success" onclick="reqPayoutModal()">+ Request Payout</button>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Reason</th>
              <th>Recipients</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="memPayTable">
            <tr><td colspan="5" class="text-center text-grey">No payout requests</td></tr>
          </tbody>
        </table>
      </div>

      <div id="memberMinutesTab" class="hidden">
        <h2>Meeting Minutes</h2>
        <div id="memberMinutesContent" class="maxh-600 overflow-y-auto">
          <!-- Minutes will be loaded here -->
        </div>
      </div>

      <div id="memberPaymentsTab" class="hidden">
        <h2>My Payment Proofs</h2>
        <button class="btn btn-success" onclick="uploadPaymentProofModal()">+ Upload Payment Proof</button>
        <div class="mt-15">
          <table>
            <thead>
              <tr>
                <th>Upload Date</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Attachment</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="memberPaymentProofsTable">
              <tr><td colspan="6" class="text-center text-grey">No payment proofs uploaded</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="memberConstitutionTab" class="hidden">
        <h2>Society Constitution</h2>
        <div class="bg-info-box border-left-blue">
          <p><strong>üìú View and download the society constitution</strong></p>
        </div>

        <!-- Constitution Available -->
        <div id="memberConstitutionAvailable" class="d-none">
          <div class="bg-white-box mb-20">
            <h3 class="mb-15 text-blue">üìÑ Constitution Document</h3>
            <div class="bg-light p-15 br-5 mb-15">
              <p class="mb-8"><strong>Title:</strong> <span id="memberConstitutionTitle"></span></p>
              <p class="mb-8"><strong>Uploaded:</strong> <span id="memberConstitutionDate"></span></p>
              <p class="mb-8"><strong>File Size:</strong> <span id="memberConstitutionSize"></span></p>
              <p class="mb-0"><strong>Notes:</strong> <span id="memberConstitutionNotes"></span></p>
            </div>
            <div class="flex gap-10 flex-wrap">
              <button class="btn btn-primary" onclick="viewConstitutionMember()">
                üëÅÔ∏è View Document
              </button>
              <button class="btn btn-success" onclick="downloadConstitutionMember()">
                üì• Download Constitution
              </button>
            </div>
          </div>

          <!-- Info Section -->
          <div class="bg-green-box border-left-green">
            <p class="m-0 text-green"><strong>‚ÑπÔ∏è About the Constitution</strong></p>
            <p class="mt-10 text-muted fs-14">The constitution outlines the rules, regulations, and procedures of our burial society. All members should read and understand the constitution.</p>
          </div>
        </div>

        <!-- No Constitution Available -->
        <div id="memberConstitutionNotAvailable">
          <div class="bg-orange-box text-center">
            <p class="fs-48 mb-15">üìú</p>
            <p class="m-0 text-orange fs-16"><strong>No Constitution Available</strong></p>
            <p class="mt-10 text-muted">The admin has not uploaded the constitution yet. Please check back later.</p>
          </div>
        </div>
      </div>

      <div id="memberDocumentsTab" class="hidden">
        <h2>My Documents</h2>
        <p class="text-muted mb-15">Upload and manage your documents</p>
          .mt-40 { margin-top: 40px !important; }
          .pt-30 { padding-top: 30px !important; }
          .border-top-grey { border-top: 2px solid #e2e8f0 !important; }
          .mb-10 { margin-bottom: 10px !important; }
          .mt-20 { margin-top: 20px !important; }
          .maxh-600 { max-height: 600px !important; }
          .p-15 { padding: 15px !important; }
          .mb-8 { margin-bottom: 8px !important; }
          .fs-48 { font-size: 48px !important; }
          .mb-15 { margin-bottom: 15px !important; }
          .fs-16 { font-size: 16px !important; }
        <div class="file-input">
          <label>Proof of Payment (PDF/JPEG)</label>
          <input type="file" id="payFile" accept=".pdf,.jpg,.jpeg">
        </div>
        <div class="file-input">
          <label>Death Certificate (PDF/JPEG)</label>
          <input type="file" id="deathFile" accept=".pdf,.jpg,.jpeg">
        </div>
        <div class="file-input">
          <label>Supporting Documents (PDF/JPEG)</label>
          <input type="file" id="suppFile" accept=".pdf,.jpg,.jpeg">
        </div>
        <button class="btn btn-success" onclick="saveDocs()">Save Documents</button>
      </div>
    </div>
  </div>

  <!-- LOADING INDICATOR -->
  <div id="loadingIndicator" class="loading-indicator">
    <div class="spinner"></div>
    <div>Processing...</div>
  </div>

  <!-- PERFORMANCE MONITOR -->
  <div id="performanceMonitor" class="performance-monitor">
    <div>‚ö° Performance</div>
    <div id="perfMetrics"></div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modContent"></div>
    </div>
  </div>

  <script>
    // ===== VERSION CONTROL & CACHE MANAGEMENT =====
    const SYSTEM_VERSION = "2.6.0"; // Update this with each deployment
    const VERSION_CHECK_INTERVAL = 300000; // Check for updates every 5 minutes
    
    // Check if user has old cached version
    function checkSystemVersion() {
      const storedVersion = localStorage.getItem('sbahle_system_version');
      const lastVersionCheck = localStorage.getItem('sbahle_last_version_check');
      const now = Date.now();
      
      // First time user or version mismatch
      if (!storedVersion || storedVersion !== SYSTEM_VERSION) {
        console.log(`üì¶ System updated: ${storedVersion || 'first visit'} ‚Üí ${SYSTEM_VERSION}`);
        localStorage.setItem('sbahle_system_version', SYSTEM_VERSION);
        
        // Show update notification if this isn't first visit
        if (storedVersion && storedVersion !== SYSTEM_VERSION) {
          showVersionUpdateNotification();
        }
      }
      
      // Periodic version check (every 5 minutes)
      if (!lastVersionCheck || (now - parseInt(lastVersionCheck)) > VERSION_CHECK_INTERVAL) {
        localStorage.setItem('sbahle_last_version_check', now.toString());
        // In future, can check remote version file here
      }
    }
    
    // Show notification when new version is detected
    function showVersionUpdateNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        font-weight: 600;
        text-align: center;
        max-width: 90%;
        animation: slideDown 0.5s ease-out;
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 10px;">
          ‚ú® New system update installed! (v${SYSTEM_VERSION})
        </div>
        <div style="font-size: 13px; opacity: 0.9;">
          You now have the latest features and improvements
        </div>
      `;
      document.body.appendChild(notification);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.style.animation = 'slideUp 0.5s ease-out';
        setTimeout(() => notification.remove(), 500);
      }, 5000);
    }
    
    // Detect if user needs to clear cache (old version stuck)
    function detectStaleCache() {
      const deployDate = new Date('2025-11-07'); // Today's deployment
      const lastVisit = localStorage.getItem('sbahle_last_visit');
      
      if (lastVisit) {
        const lastVisitDate = new Date(lastVisit);
        const daysSinceVisit = (Date.now() - lastVisitDate) / (1000 * 60 * 60 * 24);
        
        // If last visit was before deployment and version is old
        if (lastVisitDate < deployDate && localStorage.getItem('sbahle_system_version') !== SYSTEM_VERSION) {
          console.warn('‚ö†Ô∏è Old cached version detected - may need cache clear');
          showCacheClearPrompt();
        }
      }
      
      localStorage.setItem('sbahle_last_visit', new Date().toISOString());
    }
    
    // Prompt user to clear cache if needed
    function showCacheClearPrompt() {
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const message = isMobile 
        ? 'üîÑ Please refresh this page to get the latest updates.\n\nTap your browser menu ‚Üí Reload/Refresh'
        : 'üîÑ Please refresh this page to get the latest updates.\n\nPress Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)';
      
      // Don't show if already shown today
      const lastPrompt = localStorage.getItem('sbahle_cache_prompt');
      if (lastPrompt && (Date.now() - parseInt(lastPrompt)) < 86400000) return; // 24 hours
      
      setTimeout(() => {
        if (confirm(message)) {
          localStorage.setItem('sbahle_cache_prompt', Date.now().toString());
          location.reload(true);
        }
      }, 2000);
    }
    
    // Add slide animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideDown {
        from { transform: translate(-50%, -100px); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
      }
      @keyframes slideUp {
        from { transform: translate(-50%, 0); opacity: 1; }
        to { transform: translate(-50%, -100px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
    
    // Run version checks on page load
    checkSystemVersion();
    detectStaleCache();
    
    // ===== CLOUD STORAGE CONFIGURATION =====
    // Using GitHub as cloud storage - FREE and UNLIMITED!
    const CLOUD_STORAGE = {
      enabled: true, // ‚úÖ ENABLED - Cloud sync active!
      type: 'github', // Using GitHub storage
      owner: 'GearUpZA', // Your GitHub username
      repo: 'Sbahle-burial-portal', // Your repository name
      branch: 'main',
      dataFile: 'data/burial-society-data.json', // File path in repo
      token: 'ghp_replacewithyourtoken', // GitHub Personal Access Token (will be replaced)
      endpoint: 'https://api.github.com',
      syncInterval: 10000 // Check for updates every 10 seconds (GitHub recommended)
    };
    
    let cloudStorageAvailable = false;
    let lastCloudSync = 0;
    let syncTimer = null;
    
    // Enhanced sync management
    const syncQueue = [];
    let isSyncing = false;
    let syncFailCount = 0;
    let lastSyncAttempt = 0;
    const SYNC_HEALTH = {
      consecutiveFailures: 0,
      lastSuccessfulSync: 0,
      totalSyncs: 0,
      totalFailures: 0,
      averageSyncTime: 0
    };
    
    // Test cloud storage availability with enhanced health check
    async function initCloudStorage() {
      try {
        console.log('üîÑ Initializing GitHub cloud storage connection...');
        
        // For GitHub, we'll use the public repo API (no token needed for public repos)
        const apiUrl = `${CLOUD_STORAGE.endpoint}/repos/${CLOUD_STORAGE.owner}/${CLOUD_STORAGE.repo}/contents/${CLOUD_STORAGE.dataFile}`;
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
        
        const headers = {
          'Accept': 'application/vnd.github.v3+json'
        };
        
        // Only add token if it's not the placeholder
        if (CLOUD_STORAGE.token && CLOUD_STORAGE.token !== 'ghp_replacewithyourtoken') {
          headers['Authorization'] = `token ${CLOUD_STORAGE.token}`;
        }
        
        const response = await fetch(apiUrl, {
          headers: headers,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        cloudStorageAvailable = response.ok || response.status === 404; // 404 is OK, means file doesn't exist yet
        
        if (cloudStorageAvailable) {
          console.log('‚úÖ GitHub cloud storage connected - data will sync across all browsers');
          console.log('üìÅ Storage location:', `${CLOUD_STORAGE.owner}/${CLOUD_STORAGE.repo}/${CLOUD_STORAGE.dataFile}`);
          SYNC_HEALTH.lastSuccessfulSync = Date.now();
          SYNC_HEALTH.consecutiveFailures = 0;
          updateSyncStatus('default');
          startCloudSync();
          
          // If file doesn't exist, create it with initial data
          if (response.status === 404) {
            console.log('üìù Creating initial data file in GitHub...');
            await saveDataToGitHub({
              members: [],
              beneficiaries: [],
              payouts: [],
              penalties: [],
              meetingMinutes: [],
              paymentProofs: [],
              lastSaved: new Date().toISOString(),
              version: '1.0'
            });
          }
        } else {
          console.log('‚ö† GitHub storage unavailable (Status: ' + response.status + ') - using localStorage only');
          cloudStorageAvailable = false;
          updateSyncStatus('offline');
        }
      } catch (error) {
        console.log('‚ö† GitHub storage initialization failed:', error.message);
        console.log('üí° Using localStorage only - data won\'t sync across browsers');
        cloudStorageAvailable = false;
        updateSyncStatus('offline');
        // Retry connection after 30 seconds
        setTimeout(() => {
          console.log('üîÑ Retrying GitHub storage connection...');
          initCloudStorage();
        }, 30000);
      }
    }
    
    // Save data to GitHub repository
    async function saveDataToGitHub(data) {
      try {
        const apiUrl = `${CLOUD_STORAGE.endpoint}/repos/${CLOUD_STORAGE.owner}/${CLOUD_STORAGE.repo}/contents/${CLOUD_STORAGE.dataFile}`;
        
        // First, get the current file SHA (needed for updates)
        let fileSha = null;
        try {
          const getResponse = await fetch(apiUrl, {
            headers: {
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          if (getResponse.ok) {
            const fileData = await getResponse.json();
            fileSha = fileData.sha;
          }
        } catch (e) {
          // File doesn't exist yet, that's OK
        }
        
        // Prepare the data (CSP-safe method)
        const jsonString = JSON.stringify(data, null, 2);
        const encoder = new TextEncoder();
        const dataBytes = encoder.encode(jsonString);
        let binaryString = '';
        for (let i = 0; i < dataBytes.length; i++) {
          binaryString += String.fromCharCode(dataBytes[i]);
        }
        const content = btoa(binaryString);
        
        const payload = {
          message: `Update burial society data - ${new Date().toLocaleString()}`,
          content: content,
          branch: CLOUD_STORAGE.branch
        };
        
        if (fileSha) {
          payload.sha = fileSha; // Required for updates
        }
        
        // Note: This works for public repos without auth
        // For private repos, you'd need to add: 'Authorization': `token ${CLOUD_STORAGE.token}`
        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          console.log('‚úÖ Data saved to GitHub successfully');
          return true;
        } else {
          const error = await response.json();
          console.warn('‚ö†Ô∏è GitHub save failed:', error.message);
          return false;
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è GitHub save error:', error.message);
        return false;
      }
    }
    
    // Monitor online/offline status with enhanced recovery
    window.addEventListener('online', async () => {
      console.log('üåê Internet connection restored');
      cloudStorageAvailable = true;
      updateSyncStatus('syncing');
      // Reset failure counters
      SYNC_HEALTH.consecutiveFailures = 0;
      syncFailCount = 0;
      // Process any queued sync operations
      if (syncQueue.length > 0) {
        console.log(`üì§ Processing ${syncQueue.length} queued sync operations...`);
        await processSyncQueue();
      }
      // Immediately try to sync pending data
      await saveDataToStorage(true);
      // Verify sync was successful
      setTimeout(() => {
        if (lastCloudSync < Date.now() - 10000) {
          console.warn('‚ö†Ô∏è Sync verification failed, retrying...');
          saveDataToStorage(true);
        }
      }, 5000);
    });
    
    window.addEventListener('offline', () => {
      console.log('üì¥ Internet connection lost - data will save locally and queue for sync');
      cloudStorageAvailable = false;
      updateSyncStatus('offline');
    });
    
    // Process queued sync operations
    async function processSyncQueue() {
      if (isSyncing || syncQueue.length === 0) return;
      
      isSyncing = true;
      console.log(`üîÑ Processing sync queue (${syncQueue.length} items)...`);
      
      while (syncQueue.length > 0 && cloudStorageAvailable) {
        const operation = syncQueue.shift();
        try {
          await operation();
          console.log('‚úÖ Queued sync operation completed');
          await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between operations
        } catch (error) {
          console.error('‚ùå Queued sync operation failed:', error);
          // Re-queue if not too many failures
          if (syncFailCount < 5) {
            syncQueue.push(operation);
            syncFailCount++;
          }
        }
      }
      
      isSyncing = false;
      if (syncQueue.length > 0) {
        console.log(`‚ö†Ô∏è ${syncQueue.length} sync operations still in queue`);
      } else {
        console.log('‚úÖ All queued sync operations completed');
        syncFailCount = 0;
      }
    }
    
    // Add operation to sync queue
    function queueSyncOperation(operation) {
      syncQueue.push(operation);
      console.log(`üì• Sync operation queued (Queue size: ${syncQueue.length})`);
      // Try to process immediately if online
      if (cloudStorageAvailable && !isSyncing) {
        processSyncQueue();
      }
    }
    
    // Validate data before sync
    function validateSyncData(data) {
      const errors = [];
      
      // Basic data structure check (lenient - allow missing arrays)
      if (!data || typeof data !== 'object') {
        errors.push('Invalid data structure - not an object');
        return { valid: false, errors: errors };
      }
      
      // Check members array if it exists
      if (data.members !== undefined) {
        if (!Array.isArray(data.members)) {
          errors.push('Invalid members data structure');
        } else if (data.members.length > 0) {
          // Check for critical member data issues
          const memberIds = new Set();
          data.members.forEach((member, index) => {
            if (!member.id) {
              errors.push(`Member at index ${index} missing ID`);
            } else if (memberIds.has(member.id)) {
              errors.push(`Duplicate member ID: ${member.id}`);
            } else {
              memberIds.add(member.id);
            }
            
            if (!member.name && !member.email) {
              errors.push(`Member ${member.id || index} missing both name and email`);
            }
          });
        }
      }
      
      // Optional arrays - don't fail if missing, just warn
      if (data.beneficiaries !== undefined && !Array.isArray(data.beneficiaries)) {
        console.warn('‚ö†Ô∏è Beneficiaries is not an array, will use empty array');
      }
      if (data.payouts !== undefined && !Array.isArray(data.payouts)) {
        console.warn('‚ö†Ô∏è Payouts is not an array, will use empty array');
      }
      
      // Version check (lenient - just log, don't warn)
      if (data.version) {
        console.log(`üìã Data version: ${data.version}`);
      }
      
      return {
        valid: errors.length === 0,
        errors: errors
      };
    }
    
    // Merge local and cloud data (conflict resolution)
    function mergeData(localData, cloudData) {
      console.log('üîÑ Merging local and cloud data...');
      
      // Use cloud data as base if both exist
      if (!localData) return cloudData;
      if (!cloudData) return localData;
      
      const merged = { ...cloudData };
      
      // Compare timestamps to determine which is newer
      const localTime = new Date(localData.lastSaved || 0).getTime();
      const cloudTime = new Date(cloudData.lastSaved || 0).getTime();
      
      console.log(`üìä Local timestamp: ${new Date(localTime).toLocaleString()}`);
      console.log(`üìä Cloud timestamp: ${new Date(cloudTime).toLocaleString()}`);
      
      // If local is newer, merge arrays intelligently
      if (localTime > cloudTime) {
        console.log('‚ö° Local data is newer - merging updates...');
        
        // Merge members (prefer local if IDs match)
        if (localData.members && cloudData.members) {
          const memberMap = new Map();
          cloudData.members.forEach(m => memberMap.set(m.id, m));
          localData.members.forEach(m => memberMap.set(m.id, m)); // Local overrides cloud
          merged.members = Array.from(memberMap.values());
        }
        
        // Merge beneficiaries
        if (localData.beneficiaries && cloudData.beneficiaries) {
          const benMap = new Map();
          cloudData.beneficiaries.forEach(b => benMap.set(b.id, b));
          localData.beneficiaries.forEach(b => benMap.set(b.id, b));
          merged.beneficiaries = Array.from(benMap.values());
        }
        
        // Use local data for other arrays if local is newer
        merged.payouts = localData.payouts || cloudData.payouts || [];
        merged.penalties = localData.penalties || cloudData.penalties || [];
        merged.meetingMinutes = localData.meetingMinutes || cloudData.meetingMinutes || [];
        merged.paymentProofs = localData.paymentProofs || cloudData.paymentProofs || [];
        merged.payoutCollectors = localData.payoutCollectors || cloudData.payoutCollectors || [];
        merged.constitutionDocument = localData.constitutionDocument || cloudData.constitutionDocument || null;
        
        // Use highest counters
        merged.memberIdCounter = Math.max(localData.memberIdCounter || 0, cloudData.memberIdCounter || 0);
        merged.minutesIdCounter = Math.max(localData.minutesIdCounter || 0, cloudData.minutesIdCounter || 0);
        merged.proofIdCounter = Math.max(localData.proofIdCounter || 0, cloudData.proofIdCounter || 0);
        
        merged.lastSaved = localData.lastSaved;
      }
      
      console.log(`‚úÖ Data merged: ${merged.members?.length || 0} members, ${merged.beneficiaries?.length || 0} beneficiaries`);
      return merged;
    }
    
    // ===== PERFORMANCE OPTIMIZATION SYSTEM =====
    const PERFORMANCE_CONFIG = {
      DEBOUNCE_DELAY: 300,
      CACHE_EXPIRY: 60000, // 1 minute
      BATCH_SIZE: 50,
      ENABLE_CACHING: true
    };
    
    // Performance cache for frequently accessed data
    const performanceCache = new Map();
    let saveTimeout = null;
    let lastSaveTime = 0;
    let syncRetryCount = 0;
    const MAX_SYNC_RETRIES = 3;
    
    // Update sync status indicator (for both admin and member dashboards)
    function updateSyncStatus(status) {
      // Admin dashboard sync indicator
      const indicator = document.getElementById('syncIndicator');
      const text = document.getElementById('syncText');
      const container = document.getElementById('cloudSyncStatus');
      
      // Member dashboard sync indicator
      const memberIndicator = document.getElementById('memberSyncIndicator');
      const memberText = document.getElementById('memberSyncText');
      const memberContainer = document.getElementById('memberCloudSyncStatus');
      
      // Helper to format time ago
      const getTimeAgo = (timestamp) => {
        if (!timestamp) return '';
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        if (seconds < 60) return 'just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        return `${Math.floor(hours / 24)}d ago`;
      };
      
      // Update both admin and member indicators
      const updateIndicator = (ind, txt, cont) => {
        if (!ind || !txt || !cont) return;
        
        switch(status) {
          case 'syncing':
            ind.textContent = 'üîÑ';
            txt.textContent = 'Syncing...';
            cont.style.background = '#fef3c7';
            cont.style.color = '#92400e';
            cont.title = 'Uploading data to cloud storage...';
            break;
          case 'synced':
            ind.textContent = '‚úÖ';
            txt.textContent = 'Synced';
            cont.style.background = '#d1fae5';
            cont.style.color = '#065f46';
            cont.title = 'Data successfully synced to cloud';
            // Update last sync time
            lastCloudSync = Date.now();
            // Reset to normal after 2 seconds, showing last sync time
            setTimeout(() => {
              ind.textContent = '‚òÅÔ∏è';
              const timeAgo = getTimeAgo(lastCloudSync);
              txt.textContent = timeAgo ? `Synced ${timeAgo}` : 'Cloud Connected';
              cont.style.background = '#e0f2fe';
              cont.style.color = '#075985';
              cont.title = `Last synced: ${new Date(lastCloudSync).toLocaleTimeString()}\nSystem version: ${SYSTEM_VERSION}`;
            }, 2000);
            break;
          case 'error':
            ind.textContent = '‚ö†Ô∏è';
            txt.textContent = syncRetryCount >= MAX_SYNC_RETRIES ? 'Sync Error - Saved Locally' : 'Sync Error - Retrying...';
            cont.style.background = '#fee2e2';
            cont.style.color = '#991b1b';
            cont.title = `Cloud sync failed. Data saved locally.\nAttempt ${syncRetryCount}/${MAX_SYNC_RETRIES}`;
            
            // Only retry if we haven't exceeded max retries
            if (syncRetryCount < MAX_SYNC_RETRIES) {
              syncRetryCount++;
              setTimeout(() => {
                console.log(`üîÑ Retry attempt ${syncRetryCount}/${MAX_SYNC_RETRIES} - Attempting to reconnect to cloud storage...`);
                saveDataToStorage(true);
              }, 5000);
            } else {
              console.warn('‚ö†Ô∏è Max retry attempts reached. Data is saved locally. Will retry on next user action.');
              // Reset counter after 30 seconds to allow future retries
              setTimeout(() => {
                syncRetryCount = 0;
                console.log('üîÑ Retry counter reset - ready for next sync attempt');
              }, 30000);
            }
            break;
          case 'offline':
            ind.textContent = 'üì¥';
            txt.textContent = 'Offline';
            cont.style.background = '#f3f4f6';
            cont.style.color = '#6b7280';
            cont.title = 'No internet connection. Data saved locally and will sync when online.';
            break;
          default:
            ind.textContent = '‚òÅÔ∏è';
            const timeAgo = getTimeAgo(lastCloudSync);
            txt.textContent = timeAgo ? `Synced ${timeAgo}` : 'Cloud Connected';
            cont.style.background = '#e0f2fe';
            cont.style.color = '#075985';
            cont.title = lastCloudSync 
              ? `Last synced: ${new Date(lastCloudSync).toLocaleTimeString()}\nSystem version: ${SYSTEM_VERSION}`
              : `Cloud storage ready\nSystem version: ${SYSTEM_VERSION}`;
        }
      };
      
      // Update both dashboards
      updateIndicator(indicator, text, container);
      updateIndicator(memberIndicator, memberText, memberContainer);
    }
    
    // Update sync time display periodically
    setInterval(() => {
      if (lastCloudSync && (document.getElementById('cloudSyncStatus') || document.getElementById('memberCloudSyncStatus'))) {
        updateSyncStatus('default'); // Refresh the "time ago" display
      }
    }, 60000); // Update every minute
    
    // Fast deep clone function (more efficient than JSON parse/stringify)
    function fastClone(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (obj instanceof Date) return new Date(obj.getTime());
      if (obj instanceof Array) return obj.map(item => fastClone(item));
      if (typeof obj === 'object') {
        const copy = {};
        Object.keys(obj).forEach(key => {
          copy[key] = fastClone(obj[key]);
        });
        return copy;
      }
    }
    
    // Debounced save function to prevent excessive localStorage writes
    function debouncedSave(callback, delay = PERFORMANCE_CONFIG.DEBOUNCE_DELAY) {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        callback();
        lastSaveTime = Date.now();
      }, delay);
    }
    
    // Cache management functions
    function getCacheKey(type, params = '') {
      return `${type}_${JSON.stringify(params)}_${Date.now()}`;
    }
    
    function getFromCache(key) {
      if (!PERFORMANCE_CONFIG.ENABLE_CACHING) return null;
      const cached = performanceCache.get(key);
      if (cached && Date.now() - cached.timestamp < PERFORMANCE_CONFIG.CACHE_EXPIRY) {
        return cached.data;
      }
      performanceCache.delete(key);
      return null;
    }
    
    // Performance monitoring functions
    let performanceMetrics = {
      loadTime: 0,
      saveTime: 0,
      renderTime: 0,
      cacheHits: 0,
      cacheMisses: 0
    };
    
    function showLoading(message = 'Processing...') {
      const indicator = document.getElementById('loadingIndicator');
      const text = indicator.querySelector('div:last-child');
      text.textContent = message;
      indicator.style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loadingIndicator').style.display = 'none';
    }
    
    function updatePerformanceMonitor() {
      const monitor = document.getElementById('performanceMonitor');
      const metrics = document.getElementById('perfMetrics');
      
      const cacheTotal = performanceMetrics.cacheHits + performanceMetrics.cacheMisses;
      const hitRate = cacheTotal > 0 ? (performanceMetrics.cacheHits / cacheTotal * 100).toFixed(1) : 0;
      
      metrics.innerHTML = `
        Load: ${performanceMetrics.loadTime}ms<br>
        Save: ${performanceMetrics.saveTime}ms<br>
        Render: ${performanceMetrics.renderTime}ms<br>
        Cache: ${hitRate}% hits<br>
        Memory: ${performanceCache.size} items
      `;
      
      monitor.classList.add('show');
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        monitor.classList.remove('show');
      }, 3000);
    }
    
    function trackPerformance(operation, startTime) {
      const duration = performance.now() - startTime;
      performanceMetrics[operation] = duration.toFixed(2);
      updatePerformanceMonitor();
      console.log(`‚ö° ${operation} completed in ${duration.toFixed(2)}ms`);
    }
    
    function setCache(key, data) {
      if (!PERFORMANCE_CONFIG.ENABLE_CACHING) return;
      performanceCache.set(key, {
        data: data,
        timestamp: Date.now()
      });
      
      // Clean up old cache entries
      if (performanceCache.size > 100) {
        const oldEntries = Array.from(performanceCache.entries())
          .filter(([k, v]) => Date.now() - v.timestamp > PERFORMANCE_CONFIG.CACHE_EXPIRY);
        oldEntries.forEach(([k]) => performanceCache.delete(k));
      }
    }
    
    // ===== DATA STORAGE SYSTEM =====
    const STORAGE_KEY = 'sbahle_burial_society_data';
    const ADMIN_CREDENTIALS = { username: 'admin', password: 'admin123' }; // In production, hash this!
    
    // ===== AUTOMATED BACKUP SYSTEM =====
    const BACKUP_CONFIG = {
      WEEKLY_EMAIL_ENABLED: true,
      MONTHLY_AUTO_DOWNLOAD: true,
      KEEP_SNAPSHOTS_DAYS: 7,
      LAST_EMAIL_BACKUP_KEY: 'last_email_backup',
      LAST_MONTHLY_BACKUP_KEY: 'last_monthly_backup',
      ADMIN_EMAIL: 'maqashela@gmail.com' // Change to admin's email
    };
    
    // Initialize backup system
    function initBackupSystem() {
      // Check if weekly email backup is due
      checkWeeklyEmailBackup();
      
      // Check if monthly auto-download is due
      checkMonthlyAutoDownload();
      
      // Clean old snapshots
      cleanOldBackupSnapshots();
      
      // Set up periodic checks (daily)
      setInterval(() => {
        checkWeeklyEmailBackup();
        checkMonthlyAutoDownload();
        cleanOldBackupSnapshots();
      }, 86400000); // Check every 24 hours
    }
    
    // Check and send weekly email backup
    async function checkWeeklyEmailBackup() {
      if (!BACKUP_CONFIG.WEEKLY_EMAIL_ENABLED) return;
      
      const lastBackup = localStorage.getItem(BACKUP_CONFIG.LAST_EMAIL_BACKUP_KEY);
      const now = Date.now();
      const oneWeek = 7 * 24 * 60 * 60 * 1000;
      
      if (!lastBackup || (now - parseInt(lastBackup)) > oneWeek) {
        console.log('üìß Weekly email backup due - generating backup data...');
        const backupData = await generateBackupData();
        
        // In production, this would call an email service
        // For now, we'll prepare the data and log it
        console.log('‚úÖ Weekly backup ready. Size:', (JSON.stringify(backupData).length / 1024).toFixed(2), 'KB');
        
        // Save backup link for admin to download
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Store backup metadata
        const backupMeta = {
          date: new Date().toISOString(),
          size: blob.size,
          members: backupData.members?.length || 0,
          url: url
        };
        
        localStorage.setItem('pending_email_backup', JSON.stringify(backupMeta));
        localStorage.setItem(BACKUP_CONFIG.LAST_EMAIL_BACKUP_KEY, now.toString());
        
        // Show notification to admin
        if (currentUser && currentUser.role === 'Admin') {
          showAlert('adminAlert', 'üìß Weekly backup ready! Check Data Management tab to download.', 'info');
        }
      }
    }
    
    // Check and perform monthly auto-download
    function checkMonthlyAutoDownload() {
      if (!BACKUP_CONFIG.MONTHLY_AUTO_DOWNLOAD) return;
      
      const lastDownload = localStorage.getItem(BACKUP_CONFIG.LAST_MONTHLY_BACKUP_KEY);
      const now = Date.now();
      const oneMonth = 30 * 24 * 60 * 60 * 1000;
      
      if (!lastDownload || (now - parseInt(lastDownload)) > oneMonth) {
        console.log('üíæ Monthly auto-download due - preparing backup...');
        
        // Only auto-download if admin is logged in
        if (currentUser && currentUser.role === 'Admin' && !document.getElementById('adminPage').classList.contains('hidden')) {
          downloadBackupFile('monthly');
          localStorage.setItem(BACKUP_CONFIG.LAST_MONTHLY_BACKUP_KEY, now.toString());
        } else {
          console.log('‚è≥ Monthly backup pending - will download when admin logs in');
        }
      }
    }
    
    // Clean old backup snapshots (keep last 7 days)
    function cleanOldBackupSnapshots() {
      const now = Date.now();
      const maxAge = BACKUP_CONFIG.KEEP_SNAPSHOTS_DAYS * 24 * 60 * 60 * 1000;
      
      // Get all localStorage keys
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(STORAGE_KEY + '_backup_')) {
          // Extract date from key
          const dateStr = key.split('_backup_')[1];
          try {
            const backupDate = new Date(dateStr).getTime();
            if (now - backupDate > maxAge) {
              keysToRemove.push(key);
            }
          } catch (e) {
            // Invalid date format, keep it
          }
        }
      }
      
      // Remove old backups
      keysToRemove.forEach(key => {
        localStorage.removeItem(key);
        console.log('üóëÔ∏è Removed old backup:', key);
      });
      
      if (keysToRemove.length > 0) {
        console.log(`‚úÖ Cleaned ${keysToRemove.length} old backup snapshots`);
      }
    }
    
    // Generate backup data
    async function generateBackupData() {
      const attendanceData = JSON.parse(localStorage.getItem('attendance') || '{}');
      
      return {
        // Core data
        members,
        beneficiaries,
        payouts,
        penalties,
        attendance: attendanceData,
        meetingMinutes,
        paymentProofs,
        payoutCollectors,
        constitutionDocument,
        
        // Counters
        memberIdCounter,
        minutesIdCounter,
        proofIdCounter,
        
        // Metadata
        backupDate: new Date().toISOString(),
        version: '2.6.1-enhanced-sync',
        systemInfo: {
          totalMembers: members.length,
          activeMembers: members.filter(m => m.status === 'Active').length,
          totalBeneficiaries: beneficiaries.length,
          totalMeetings: Object.keys(attendanceData).length,
          syncHealth: SYNC_HEALTH
        }
      };
    }
    
    // Download backup file (one-click backup)
    async function downloadBackupFile(type = 'manual') {
      try {
        const backupData = await generateBackupData();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
        const filename = `SBS-Backup-${type}-${timestamp}.json`;
        
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        
        console.log(`‚úÖ Backup downloaded: ${filename} (${(blob.size / 1024).toFixed(2)} KB)`);
        showAlert('adminAlert', `‚úÖ Backup downloaded: ${filename}`, 'success');
        
        if (type === 'monthly') {
          localStorage.setItem(BACKUP_CONFIG.LAST_MONTHLY_BACKUP_KEY, Date.now().toString());
        }
      } catch (error) {
        console.error('Backup download error:', error);
        showAlert('adminAlert', '‚ùå Backup download failed: ' + error.message, 'error');
      }
    }
    
    // Get member contribution status
    function getMemberContributionStatus(member) {
      // Count contributions in last 3 months
      const threeMonthsAgo = new Date();
      threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
      
      const recentContributions = (member.contributions || []).filter(c => {
        const contribDate = new Date(c.date);
        return contribDate >= threeMonthsAgo;
      }).length;
      
      // Determine status
      if (recentContributions >= 3) return 'up-to-date'; // Green
      if (recentContributions >= 2) return 'warning'; // Yellow
      return 'behind'; // Red
    }
    
    // Get status badge HTML
    function getStatusBadgeHTML(status) {
      const badges = {
        'up-to-date': '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">üü¢ UP TO DATE</span>',
        'warning': '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">üü° 1 BEHIND</span>',
        'behind': '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">üî¥ 2+ BEHIND</span>'
      };
      return badges[status] || badges['behind'];
    }
    
    // Simple encryption/decryption (for basic security - use proper encryption in production)
    function encryptData(data) {
      try {
        const jsonStr = JSON.stringify(data);
        return btoa(jsonStr); // Base64 encoding (basic obfuscation)
      } catch (e) {
        console.error('Encryption error:', e);
        return null;
      }
    }
    
    function decryptData(encrypted) {
      try {
        const jsonStr = atob(encrypted);
        return JSON.parse(jsonStr);
      } catch (e) {
        console.error('Decryption error:', e);
        return null;
      }
    }
    
    // Optimized save function with enhanced cloud storage reliability
    async function saveDataToStorage(forceImmediate = false) {
      const performSave = async () => {
        const syncStartTime = performance.now();
        try {
          // Prevent concurrent saves
          if (isSyncing && !forceImmediate) {
            console.log('‚è≥ Sync already in progress, queuing...');
            return new Promise((resolve) => {
              queueSyncOperation(() => saveDataToStorage(true).then(resolve));
            });
          }
          
          isSyncing = true;
          updateSyncStatus('syncing');
          
          const startTime = performance.now();
          
          // Get attendance data (cached to avoid repeated localStorage access)
          const cacheKey = 'attendance_data';
          let attendanceData = getFromCache(cacheKey);
          if (!attendanceData) {
            attendanceData = JSON.parse(localStorage.getItem('attendance') || '{}');
            setCache(cacheKey, attendanceData);
          }
          
          // Create comprehensive data structure
          const data = {
            // Core member data
            members,
            beneficiaries,
            payouts,
            penalties,
            
            // Attendance and meeting data
            attendance: attendanceData,
            meetingMinutes,
            paymentProofs,
            payoutCollectors,
            
            // Constitution document
            constitutionDocument,
            
            // System data
            memberIdCounter,
            minutesIdCounter,
            proofIdCounter,
            
            // Metadata
            lastSaved: new Date().toISOString(),
            version: '2.6.1-enhanced-sync',
            systemInfo: {
              totalMembers: members.length,
              activeMembers: members.filter(m => m.status === 'Active').length,
              suspendedMembers: members.filter(m => m.status === 'Suspended').length,
              totalBeneficiaries: beneficiaries.length,
              totalPayouts: payouts.length,
              totalPenalties: penalties.length,
              totalMeetings: Object.keys(attendanceData).length,
              totalMinutes: meetingMinutes.length,
              totalProofs: paymentProofs.length,
              lastSaveTime: performance.now() - startTime,
              syncHealth: {
                consecutiveFailures: SYNC_HEALTH.consecutiveFailures,
                totalSyncs: SYNC_HEALTH.totalSyncs,
                successRate: SYNC_HEALTH.totalSyncs > 0 
                  ? ((SYNC_HEALTH.totalSyncs - SYNC_HEALTH.totalFailures) / SYNC_HEALTH.totalSyncs * 100).toFixed(1) + '%'
                  : 'N/A'
              }
            }
          };
          
          // Validate data before sync
          const validation = validateSyncData(data);
          if (!validation.valid) {
            console.error('‚ùå Data validation failed:', validation.errors);
            showAlert('adminAlert', '‚ö†Ô∏è Data validation failed: ' + validation.errors[0], 'error');
            isSyncing = false;
            updateSyncStatus('error');
            return false;
          }
          
          let cloudSaveSuccess = false;
          
          // Save to cloud storage if available
          if (cloudStorageAvailable && CLOUD_STORAGE.enabled) {
            try {
              // Check if enough time has passed since last attempt to avoid rate limiting
              const timeSinceLastAttempt = Date.now() - lastSyncAttempt;
              if (timeSinceLastAttempt < 2000 && !forceImmediate) {
                console.log('‚è±Ô∏è Rate limiting - waiting before sync...');
                await new Promise(resolve => setTimeout(resolve, 2000 - timeSinceLastAttempt));
              }
              
              lastSyncAttempt = Date.now();
              
              // Use GitHub save function
              cloudSaveSuccess = await saveDataToGitHub(data);
              
              if (cloudSaveSuccess) {
                const syncTime = performance.now() - syncStartTime;
                SYNC_HEALTH.totalSyncs++;
                SYNC_HEALTH.consecutiveFailures = 0;
                SYNC_HEALTH.lastSuccessfulSync = Date.now();
                SYNC_HEALTH.averageSyncTime = ((SYNC_HEALTH.averageSyncTime + syncTime) / 2).toFixed(0);
                
                console.log('‚úÖ CLOUD SAVE SUCCESS:', {
                  time: data.lastSaved,
                  members: data.members.length,
                  beneficiaries: data.beneficiaries.length,
                  meetingMinutes: data.meetingMinutes.length,
                  signatures: data.members.filter(m => m.signature).length + ' members with signatures',
                  totalDataSize: (JSON.stringify(data).length / 1024).toFixed(2) + ' KB',
                  syncTime: syncTime.toFixed(0) + 'ms',
                  health: `${SYNC_HEALTH.totalSyncs} syncs, ${SYNC_HEALTH.consecutiveFailures} failures`
                });
                
                lastCloudSync = Date.now();
                syncRetryCount = 0;
                syncFailCount = 0;
                updateSyncStatus('synced');
                cloudSaveSuccess = true;
                
                // Clear sync queue on success
                if (syncQueue.length > 0) {
                  console.log('‚úÖ Clearing sync queue after successful sync');
                  syncQueue.length = 0;
                }
              } else {
                const errorText = await response.text();
                SYNC_HEALTH.totalFailures++;
                SYNC_HEALTH.consecutiveFailures++;
                
                console.error('‚ùå CLOUD SAVE ERROR:', {
                  status: response.status,
                  statusText: response.statusText,
                  error: errorText,
                  consecutiveFailures: SYNC_HEALTH.consecutiveFailures
                });
                
                // Specific error handling with exponential backoff
                if (response.status === 429) {
                  const retryDelay = Math.min(2000 * Math.pow(2, SYNC_HEALTH.consecutiveFailures), 30000);
                  console.warn(`‚ö†Ô∏è Rate limit reached - retrying in ${retryDelay/1000}s`);
                  updateSyncStatus('error');
                  queueSyncOperation(() => saveDataToStorage(true));
                  setTimeout(() => processSyncQueue(), retryDelay);
                } else if (response.status === 413) {
                  console.error('‚ùå Data too large for cloud storage');
                  updateSyncStatus('error');
                  showAlert('adminAlert', '‚ö†Ô∏è Data size too large. Consider archiving old records.', 'error');
                } else if (response.status === 401 || response.status === 403) {
                  console.error('‚ùå Cloud storage authentication failed');
                  updateSyncStatus('error');
                  showAlert('adminAlert', '‚ö†Ô∏è Cloud authentication error. Please check configuration.', 'error');
                  cloudStorageAvailable = false;
                  // Retry connection after 60 seconds
                  setTimeout(() => initCloudStorage(), 60000);
                } else if (response.status >= 500) {
                  console.error('‚ùå Cloud storage server error');
                  updateSyncStatus('error');
                  // Queue for retry with exponential backoff
                  const retryDelay = Math.min(5000 * Math.pow(2, SYNC_HEALTH.consecutiveFailures), 60000);
                  console.warn(`‚ö†Ô∏è Server error - retrying in ${retryDelay/1000}s`);
                  queueSyncOperation(() => saveDataToStorage(true));
                  setTimeout(() => processSyncQueue(), retryDelay);
                } else {
                  updateSyncStatus('error');
                  console.error('Cloud save failed but will retry on next save');
                  if (SYNC_HEALTH.consecutiveFailures < 3) {
                    queueSyncOperation(() => saveDataToStorage(true));
                  }
                }
                cloudSaveSuccess = false;
              }
            } catch (error) {
              SYNC_HEALTH.totalFailures++;
              SYNC_HEALTH.consecutiveFailures++;
              
              console.error('‚ùå CLOUD SAVE NETWORK ERROR:', {
                message: error.message,
                type: error.name,
                consecutiveFailures: SYNC_HEALTH.consecutiveFailures
              });
              
              // Handle timeout vs network errors differently
              if (error.name === 'AbortError') {
                console.warn('‚ö†Ô∏è Sync timeout - will retry with exponential backoff');
                updateSyncStatus('error');
                const retryDelay = Math.min(3000 * Math.pow(2, SYNC_HEALTH.consecutiveFailures), 30000);
                queueSyncOperation(() => saveDataToStorage(true));
                setTimeout(() => processSyncQueue(), retryDelay);
              } else {
                // Network error - queue for retry when connection restored
                updateSyncStatus('offline');
                console.warn('‚ö†Ô∏è Network error - data saved locally, queued for sync when connection restored');
                queueSyncOperation(() => saveDataToStorage(true));
              }
              
              cloudSaveSuccess = false;
            }
          } else {
            console.warn('‚ö†Ô∏è Cloud storage not available, saving locally only');
            updateSyncStatus('offline');
            cloudSaveSuccess = false;
          }
          
          // Always save to localStorage as backup
          const encrypted = encryptData(data);
          localStorage.setItem(STORAGE_KEY, encrypted);
          
          // Also save a backup with timestamp
          const backupKey = `${STORAGE_KEY}_backup_${new Date().toISOString().split('T')[0]}`;
          localStorage.setItem(backupKey, encrypted);
          
          // Track save performance
          const saveTime = performance.now() - startTime;
          performanceMetrics.saveTime = saveTime.toFixed(2);
          
          console.log('‚úì Data saved to secure storage at', data.lastSaved);
          console.log('‚úì System Info:', data.systemInfo);
          console.log(`‚úì Save completed in ${saveTime.toFixed(0)}ms`);
          
          isSyncing = false;
          
          // Return cloud save status
          return cloudSaveSuccess;
        } catch (e) {
          console.error('Failed to save data:', e);
          showAlert('adminAlert', '‚ö† Failed to save data: ' + e.message, 'error');
          isSyncing = false;
          updateSyncStatus('error');
          return false;
        }
      };
      
      // Use debounced save unless immediate save is requested
      if (forceImmediate || Date.now() - lastSaveTime > 5000) {
        lastSaveTime = Date.now();
        return await performSave();
      } else {
        return new Promise((resolve) => {
          debouncedSave(async () => {
            lastSaveTime = Date.now();
            const result = await performSave();
            resolve(result);
          });
        });
      }
    }
    
    // Enhanced load data with conflict resolution
    async function loadDataFromStorage() {
      try {
        showLoading('Loading system data...');
        const startTime = performance.now();
        let cloudData = null;
        let localData = null;
        
        // Try loading from cloud storage first
        if (cloudStorageAvailable && CLOUD_STORAGE.enabled) {
          try {
            console.log('üîÑ Fetching data from GitHub storage...');
            const apiUrl = `${CLOUD_STORAGE.endpoint}/repos/${CLOUD_STORAGE.owner}/${CLOUD_STORAGE.repo}/contents/${CLOUD_STORAGE.dataFile}`;
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
            
            const response = await fetch(apiUrl, {
              headers: {
                'Accept': 'application/vnd.github.v3+json'
              },
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
              const fileData = await response.json();
              // Decode base64 content (CSP-safe method)
              const base64Content = fileData.content.replace(/\n/g, '');
              const binaryString = atob(base64Content);
              const bytes = new Uint8Array(binaryString.length);
              for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
              }
              const decodedContent = new TextDecoder().decode(bytes);
              cloudData = JSON.parse(decodedContent);
              
              console.log('‚úÖ Data loaded from GitHub storage:', {
                members: cloudData.members?.length || 0,
                lastSaved: cloudData.lastSaved,
                version: cloudData.version
              });
              lastCloudSync = Date.now();
              SYNC_HEALTH.lastSuccessfulSync = Date.now();
            } else {
              console.warn('‚ö†Ô∏è Cloud load failed with status:', response.status);
            }
          } catch (error) {
            if (error.name === 'AbortError') {
              console.warn('‚ö†Ô∏è Cloud load timeout - using local data');
            } else {
              console.warn('‚ö†Ô∏è Cloud load error:', error.message);
            }
          }
        }
        
        // Always try to load from localStorage
        const encrypted = localStorage.getItem(STORAGE_KEY);
        if (encrypted) {
          localData = decryptData(encrypted);
          console.log('‚úÖ Data loaded from local storage:', {
            members: localData.members?.length || 0,
            lastSaved: localData.lastSaved
          });
        }
        
        // Merge cloud and local data if both exist
        let data = null;
        if (cloudData && localData) {
          console.log('üîÑ Both cloud and local data found - merging...');
          data = mergeData(localData, cloudData);
        } else {
          data = cloudData || localData;
        }
        
        if (data) {
            // Validate loaded data
            const validation = validateSyncData(data);
            if (!validation.valid) {
              console.error('‚ùå Loaded data validation failed:', validation.errors);
              console.warn('‚ö†Ô∏è Attempting to load data anyway with fixes...');
              
              // Try to fix common issues instead of rejecting
              if (!data.members || !Array.isArray(data.members)) data.members = [];
              if (!data.beneficiaries || !Array.isArray(data.beneficiaries)) data.beneficiaries = [];
              if (!data.payouts || !Array.isArray(data.payouts)) data.payouts = [];
              if (!data.penalties || !Array.isArray(data.penalties)) data.penalties = [];
              if (!data.meetingMinutes || !Array.isArray(data.meetingMinutes)) data.meetingMinutes = [];
              if (!data.paymentProofs || !Array.isArray(data.paymentProofs)) data.paymentProofs = [];
              if (!data.payoutCollectors || !Array.isArray(data.payoutCollectors)) data.payoutCollectors = [];
              
              // If still critical errors after fixes, use defaults
              const revalidation = validateSyncData(data);
              if (!revalidation.valid) {
                console.error('‚ùå Data cannot be fixed, using defaults');
                showAlert('adminAlert', '‚ö†Ô∏è Data integrity issue. Using safe defaults.', 'error');
                hideLoading();
                return false;
              }
              
              console.log('‚úÖ Data fixed and loaded successfully');
            }
            
            // Load validated data
            members = data.members || [];
            beneficiaries = data.beneficiaries || [];
            payouts = data.payouts || [];
            penalties = data.penalties || [];
            meetingMinutes = data.meetingMinutes || [];
            paymentProofs = data.paymentProofs || [];
            payoutCollectors = data.payoutCollectors || [];
            constitutionDocument = data.constitutionDocument || null;
            memberIdCounter = data.memberIdCounter || 7;
            minutesIdCounter = data.minutesIdCounter || 1;
            proofIdCounter = data.proofIdCounter || 1;
            
            // Cache attendance data
            if (data.attendance) {
              setCache('attendance_data', data.attendance);
              localStorage.setItem('attendance', JSON.stringify(data.attendance));
            }
            
            const loadTime = performance.now() - startTime;
            console.log('‚úÖ DATA LOAD COMPLETE:', {
              loadTime: loadTime.toFixed(2) + 'ms',
              lastSaved: data.lastSaved,
              members: members.length,
              meetingMinutes: meetingMinutes.length,
              signatures: members.filter(m => m.signature).length + ' members with signatures',
              beneficiaries: beneficiaries.length,
              payouts: payouts.length,
              paymentProofs: paymentProofs.length
            });
            
            if (data.systemInfo) {
              console.log('‚úì System Statistics:', data.systemInfo);
            }
            
            trackPerformance('loadTime', startTime);
            hideLoading();
            return true;
        }
        
        console.log('No saved data found, using default data with', members.length, 'members');
        hideLoading();
        return false;
      } catch (e) {
        console.error('Failed to load data:', e);
        hideLoading();
        return false;
      }
    }
    
    // Real-time cloud sync - polls for updates from other browsers
    async function checkCloudUpdates() {
      if (!cloudStorageAvailable || !CLOUD_STORAGE.enabled) return;
      
      try {
        const apiUrl = `${CLOUD_STORAGE.endpoint}/repos/${CLOUD_STORAGE.owner}/${CLOUD_STORAGE.repo}/contents/${CLOUD_STORAGE.dataFile}`;
        
        const response = await fetch(apiUrl, {
          headers: {
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          const fileData = await response.json();
          // Decode base64 content (CSP-safe method)
          const base64Content = fileData.content.replace(/\n/g, '');
          const binaryString = atob(base64Content);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const decodedContent = new TextDecoder().decode(bytes);
          const cloudData = JSON.parse(decodedContent);
          
          // Only update if cloud data exists and is newer than local
          if (cloudData && cloudData.lastSaved) {
            const cloudTime = new Date(cloudData.lastSaved).getTime();
            const localTime = lastCloudSync;
            
            if (cloudTime > localTime) {
              console.log('üîÑ NEW DATA DETECTED - Syncing from GitHub...', {
                cloudMembers: cloudData.members?.length || 0,
                cloudMinutes: cloudData.meetingMinutes?.length || 0,
                cloudSignatures: (cloudData.members || []).filter(m => m.signature).length,
                localMembers: members.length,
                cloudTime: new Date(cloudData.lastSaved).toLocaleString(),
                localTime: new Date(localTime).toLocaleString()
              });
              
              // ALWAYS use cloud data as authoritative source
              members = cloudData.members || [];
              beneficiaries = cloudData.beneficiaries || [];
              payouts = cloudData.payouts || [];
              penalties = cloudData.penalties || [];
              meetingMinutes = cloudData.meetingMinutes || [];
              paymentProofs = cloudData.paymentProofs || [];
              payoutCollectors = cloudData.payoutCollectors || [];
              memberIdCounter = cloudData.memberIdCounter || 1;
              minutesIdCounter = cloudData.minutesIdCounter || 1;
              proofIdCounter = cloudData.proofIdCounter || 1;
              
              // Sync attendance data if available
              if (cloudData.attendance) {
                localStorage.setItem('attendance', JSON.stringify(cloudData.attendance));
                console.log('‚úì Attendance data synced from cloud');
              }
              
              // Update both localStorage backup and sync time
              localStorage.setItem(STORAGE_KEY, encryptData({
                members,
                beneficiaries,
                payouts,
                penalties,
                meetingMinutes,
                paymentProofs,
                payoutCollectors,
                memberIdCounter,
                minutesIdCounter,
                proofIdCounter,
                lastSaved: cloudData.lastSaved
              }));
              
              lastCloudSync = Date.now();
              
              // Refresh UI if on admin page
              if (document.getElementById('adminPage') && !document.getElementById('adminPage').classList.contains('hidden')) {
                updateAdmin();
                console.log('‚úì Admin dashboard refreshed with cloud data');
              }
              
              // Refresh member page if logged in
              if (document.getElementById('memberPage') && !document.getElementById('memberPage').classList.contains('hidden')) {
                updateMember();
                console.log('‚úì Member dashboard refreshed with cloud data');
              }
              
              // Show brief sync notification
              updateSyncStatus('synced');
              
              console.log('‚úÖ SYNC COMPLETE - Data updated across all devices:', {
                members: members.length,
                meetingMinutes: meetingMinutes.length,
                signatures: members.filter(m => m.signature).length + ' members with signatures',
                beneficiaries: beneficiaries.length,
                payouts: payouts.length
              });
            }
          }
        }
      } catch (error) {
        console.error('Cloud sync error:', error);
      }
    }
    
    // Start periodic cloud sync
    function startCloudSync() {
      if (syncTimer) clearInterval(syncTimer);
      syncTimer = setInterval(checkCloudUpdates, CLOUD_STORAGE.syncInterval);
      console.log('‚úÖ REAL-TIME GITHUB SYNC ACTIVE');
      console.log('üì° Syncing every', CLOUD_STORAGE.syncInterval / 1000, 'seconds across ALL browsers and devices');
      console.log('üë• All members and admin will see updates within', CLOUD_STORAGE.syncInterval / 1000, 'seconds');
      console.log('üÜì Using GitHub storage - FREE and UNLIMITED!');
    }
    
    // Stop cloud sync
    function stopCloudSync() {
      if (syncTimer) {
        clearInterval(syncTimer);
        syncTimer = null;
      }
    }
    
    // Export comprehensive data to JSON file
    function exportData() {
      try {
        // Get attendance data
        const attendanceData = JSON.parse(localStorage.getItem('attendance') || '{}');
        
        const data = {
          // Core member data
          members,
          beneficiaries,
          payouts,
          penalties,
          meetingMinutes,
          paymentProofs,
          payoutCollectors,
          
          // Counters
          memberIdCounter,
          minutesIdCounter,
          proofIdCounter,
          
          // Attendance and meeting data
          attendance: attendanceData,
          
          // Export metadata
          exportDate: new Date().toISOString(),
          version: '2.5-payouts',
          systemInfo: {
            totalMembers: members.length,
            activeMembers: members.filter(m => m.status === 'Active').length,
            suspendedMembers: members.filter(m => m.status === 'Suspended').length,
            totalBeneficiaries: beneficiaries.length,
            totalPayouts: payouts.length,
            totalPenalties: penalties.length,
            totalMeetings: Object.keys(attendanceData).length,
            totalMinutes: meetingMinutes.length,
            totalPaymentProofs: paymentProofs.length,
            totalPayoutCollectors: payoutCollectors.length,
            membersWithSignatures: members.filter(m => m.signature).length,
            dataSize: 'Calculating...',
            exportedBy: 'Sbahle Burial Portal v2.5'
          }
        };
        
        const jsonStr = JSON.stringify(data, null, 2);
        const dataSize = (jsonStr.length / 1024).toFixed(2);
        data.systemInfo.dataSize = `${dataSize} KB`;
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
        a.download = `sbahle_FULL_BACKUP_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showAlert('adminAlert', `‚úÖ Complete backup exported! (${dataSize} KB) - Includes ALL signatures, beneficiaries, payment proofs, and meeting minutes`, 'success');
        console.log('‚úÖ BACKUP EXPORTED:', {
          members: members.length,
          beneficiaries: beneficiaries.length,
          signatures: members.filter(m => m.signature).length,
          paymentProofs: paymentProofs.length,
          meetingMinutes: meetingMinutes.length,
          size: `${dataSize} KB`
        });
      } catch (e) {
        console.error('Export error:', e);
        showAlert('adminAlert', '‚ö† Failed to export data: ' + e.message, 'error');
      }
    }
    
    // Import data from JSON file
    // Import comprehensive data from JSON file
    async function importData(file) {
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Show detailed confirmation
          const confirmMsg = `‚ö†Ô∏è RESTORE COMPLETE BACKUP?\n\n` +
            `This will restore:\n` +
            `‚Ä¢ ${data.members?.length || 0} members (including signatures)\n` +
            `‚Ä¢ ${data.beneficiaries?.length || 0} beneficiaries\n` +
            `‚Ä¢ ${data.paymentProofs?.length || 0} payment proofs\n` +
            `‚Ä¢ ${data.meetingMinutes?.length || 0} meeting minutes\n` +
            `‚Ä¢ ${data.payouts?.length || 0} payouts\n` +
            `‚Ä¢ ${Object.keys(data.attendance || {}).length} attendance records\n\n` +
            `Current data will be REPLACED. Continue?`;
          
          if (confirm(confirmMsg)) {
            // Import ALL data
            members = data.members || [];
            beneficiaries = data.beneficiaries || [];
            payouts = data.payouts || [];
            penalties = data.penalties || [];
            meetingMinutes = data.meetingMinutes || [];
            paymentProofs = data.paymentProofs || [];
            payoutCollectors = data.payoutCollectors || [];
            constitutionDocument = data.constitutionDocument || null;
            
            // Import counters
            memberIdCounter = data.memberIdCounter || 16;
            minutesIdCounter = data.minutesIdCounter || 1;
            proofIdCounter = data.proofIdCounter || 1;
            
            // Import attendance data if available
            if (data.attendance) {
              localStorage.setItem('attendance', JSON.stringify(data.attendance));
            }
            
            // Save all imported data to cloud immediately
            updateSyncStatus('syncing');
            const cloudSaveSuccess = await saveDataToStorage(true);
            
            // Refresh UI
            updateAdmin();
            
            // Show detailed success message
            const signaturesCount = members.filter(m => m.signature).length;
            const message = cloudSaveSuccess 
              ? `‚úÖ COMPLETE RESTORE SUCCESSFUL!\n\n` +
                `Restored and synced to cloud:\n` +
                `‚Ä¢ ${members.length} members (${signaturesCount} with signatures)\n` +
                `‚Ä¢ ${beneficiaries.length} beneficiaries\n` +
                `‚Ä¢ ${paymentProofs.length} payment proofs\n` +
                `‚Ä¢ ${meetingMinutes.length} meeting minutes\n` +
                `‚Ä¢ ${payouts.length} payouts`
              : `‚ö†Ô∏è DATA RESTORED LOCALLY\n\n` +
                `Cloud sync failed. Data saved locally:\n` +
                `‚Ä¢ ${members.length} members\n` +
                `‚Ä¢ ${beneficiaries.length} beneficiaries\n` +
                `Please check internet connection.`;
            
            alert(message);
            showAlert('adminAlert', cloudSaveSuccess ? '‚úÖ Complete backup restored and synced to cloud!' : '‚ö†Ô∏è Backup restored locally - cloud sync pending', cloudSaveSuccess ? 'success' : 'warning');
            
            console.log('‚úÖ RESTORE COMPLETED:', {
              members: members.length,
              signatures: signaturesCount,
              beneficiaries: beneficiaries.length,
              paymentProofs: paymentProofs.length,
              meetingMinutes: meetingMinutes.length,
              cloudSynced: cloudSaveSuccess
            });
          }
        } catch (err) {
          console.error('Import error:', err);
          showAlert('adminAlert', '‚ùå Invalid backup file format: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    }
    
    // Clear all data (with confirmation)
    function clearAllData() {
      if (confirm('‚ö† WARNING: This will delete ALL data permanently. Are you sure?')) {
        if (confirm('This action cannot be undone. Continue?')) {
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        }
      }
    }
    
    // Constitution management functions
    async function uploadConstitution() {
      const fileInput = document.getElementById('constitutionFile');
      const titleInput = document.getElementById('constitutionTitle');
      const notesInput = document.getElementById('constitutionNotes');
      
      if (!fileInput.files || !fileInput.files[0]) {
        showAlert('adminAlert', '‚ö†Ô∏è Please select a file to upload', 'error');
        return;
      }
      
      if (!titleInput.value.trim()) {
        showAlert('adminAlert', '‚ö†Ô∏è Please enter a document title', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const maxSize = 10 * 1024 * 1024; // 10MB limit
      
      if (file.size > maxSize) {
        showAlert('adminAlert', '‚ö†Ô∏è File is too large. Maximum size is 10MB', 'error');
        return;
      }
      
      // Validate file type
      const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      if (!allowedTypes.includes(file.type)) {
        showAlert('adminAlert', '‚ö†Ô∏è Invalid file type. Only PDF, DOC, and DOCX files are allowed', 'error');
        return;
      }
      
      showAlert('adminAlert', 'üì§ Uploading constitution...', 'info');
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        constitutionDocument = {
          title: titleInput.value.trim(),
          uploadDate: new Date().toISOString(),
          fileData: e.target.result,
          fileSize: file.size,
          fileType: file.type,
          fileName: file.name,
          notes: notesInput.value.trim() || 'No notes'
        };
        
        await saveDataToStorage(true);
        showAlert('adminAlert', '‚úÖ Constitution uploaded successfully!', 'success');
        
        // Clear inputs
        fileInput.value = '';
        titleInput.value = '';
        notesInput.value = '';
        
        // Update display
        displayConstitution();
      };
      
      reader.readAsDataURL(file);
    }
    
    function displayConstitution() {
      const currentSection = document.getElementById('currentConstitutionSection');
      const noSection = document.getElementById('noConstitutionSection');
      
      if (constitutionDocument) {
        currentSection.style.display = 'block';
        noSection.style.display = 'none';
        
        document.getElementById('constitutionTitleDisplay').textContent = constitutionDocument.title;
        document.getElementById('constitutionDateDisplay').textContent = new Date(constitutionDocument.uploadDate).toLocaleString();
        document.getElementById('constitutionSizeDisplay').textContent = formatFileSize(constitutionDocument.fileSize);
        document.getElementById('constitutionNotesDisplay').textContent = constitutionDocument.notes;
      } else {
        currentSection.style.display = 'none';
        noSection.style.display = 'block';
      }
      
      // Update member view
      displayConstitutionMember();
    }
    
    function displayConstitutionMember() {
      const availableSection = document.getElementById('memberConstitutionAvailable');
      const notAvailableSection = document.getElementById('memberConstitutionNotAvailable');
      
      if (constitutionDocument) {
        availableSection.style.display = 'block';
        notAvailableSection.style.display = 'none';
        
        document.getElementById('memberConstitutionTitle').textContent = constitutionDocument.title;
        document.getElementById('memberConstitutionDate').textContent = new Date(constitutionDocument.uploadDate).toLocaleDateString();
        document.getElementById('memberConstitutionSize').textContent = formatFileSize(constitutionDocument.fileSize);
        document.getElementById('memberConstitutionNotes').textContent = constitutionDocument.notes;
      } else {
        availableSection.style.display = 'none';
        notAvailableSection.style.display = 'block';
      }
    }
    
    function viewConstitution() {
      if (!constitutionDocument) {
        showAlert('adminAlert', '‚ö†Ô∏è No constitution uploaded', 'error');
        return;
      }
      
      // Open in new window/tab
      const blob = dataURLtoBlob(constitutionDocument.fileData);
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }
    
    function viewConstitutionMember() {
      if (!constitutionDocument) {
        showAlert('memberAlert', '‚ö†Ô∏è Constitution not available', 'error');
        return;
      }
      
      const blob = dataURLtoBlob(constitutionDocument.fileData);
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }
    
    function downloadConstitution() {
      if (!constitutionDocument) {
        showAlert('adminAlert', '‚ö†Ô∏è No constitution uploaded', 'error');
        return;
      }
      
      const blob = dataURLtoBlob(constitutionDocument.fileData);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = constitutionDocument.fileName || 'constitution.pdf';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showAlert('adminAlert', '‚úÖ Constitution downloaded', 'success');
    }
    
    function downloadConstitutionMember() {
      if (!constitutionDocument) {
        showAlert('memberAlert', '‚ö†Ô∏è Constitution not available', 'error');
        return;
      }
      
      const blob = dataURLtoBlob(constitutionDocument.fileData);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = constitutionDocument.fileName || 'constitution.pdf';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showAlert('memberAlert', '‚úÖ Constitution downloaded', 'success');
    }
    
    async function deleteConstitution() {
      if (!constitutionDocument) {
        showAlert('adminAlert', '‚ö†Ô∏è No constitution to delete', 'error');
        return;
      }
      
      if (confirm('Are you sure you want to delete the constitution? This action cannot be undone.')) {
        constitutionDocument = null;
        await saveDataToStorage(true);
        displayConstitution();
        showAlert('adminAlert', '‚úÖ Constitution deleted successfully', 'success');
      }
    }
    
    // Helper function to convert data URL to Blob
    function dataURLtoBlob(dataURL) {
      const arr = dataURL.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }
    
    // Helper function to format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // ============================================================================
    // BENEFICIARY VALIDATION FUNCTIONS
    // ============================================================================
    
    /**
     * Validate South African ID Number
     * Format: YYMMDDGSSSCAZ (13 digits)
     * - YYMMDD: Date of birth
     * - G: Gender (0-4 female, 5-9 male)
     * - SSS: Sequence number
     * - C: Citizenship (0=SA, 1=non-SA)
     * - A: Usually 8 or 9
     * - Z: Checksum digit
     */
    function validateSouthAfricanID(idNumber) {
      // Remove any spaces or dashes
      idNumber = idNumber.replace(/[\s-]/g, '');
      
      // Check if 13 digits
      if (!/^\d{13}$/.test(idNumber)) {
        return { valid: false, error: 'ID must be exactly 13 digits' };
      }
      
      // Extract date components
      const year = parseInt(idNumber.substring(0, 2));
      const month = parseInt(idNumber.substring(2, 4));
      const day = parseInt(idNumber.substring(4, 6));
      
      // Validate date
      if (month < 1 || month > 12) {
        return { valid: false, error: 'Invalid month in ID number' };
      }
      if (day < 1 || day > 31) {
        return { valid: false, error: 'Invalid day in ID number' };
      }
      
      // Calculate checksum (Luhn algorithm)
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        let digit = parseInt(idNumber[i]);
        if (i % 2 === 1) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }
        sum += digit;
      }
      const checkDigit = (10 - (sum % 10)) % 10;
      
      if (checkDigit !== parseInt(idNumber[12])) {
        return { valid: false, error: 'Invalid ID number checksum' };
      }
      
      return { valid: true, error: null };
    }
    
    /**
     * Calculate age from South African ID Number
     */
    function calculateAgeFromID(idNumber) {
      idNumber = idNumber.replace(/[\s-]/g, '');
      
      if (!/^\d{13}$/.test(idNumber)) {
        return null;
      }
      
      let year = parseInt(idNumber.substring(0, 2));
      const month = parseInt(idNumber.substring(2, 4));
      const day = parseInt(idNumber.substring(4, 6));
      
      // Determine century (00-25 = 2000s, 26-99 = 1900s)
      const currentYear = new Date().getFullYear();
      const currentCentury = Math.floor(currentYear / 100);
      
      if (year >= 0 && year <= 25) {
        year += 2000;
      } else {
        year += 1900;
      }
      
      const birthDate = new Date(year, month - 1, day);
      const today = new Date();
      
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      
      return age;
    }
    
    /**
     * Get gender from South African ID Number
     */
    function getGenderFromID(idNumber) {
      idNumber = idNumber.replace(/[\s-]/g, '');
      
      if (!/^\d{13}$/.test(idNumber)) {
        return null;
      }
      
      const genderDigit = parseInt(idNumber[6]);
      return genderDigit < 5 ? 'Female' : 'Male';
    }
    
    /**
     * Validate beneficiary allocation percentages
     */
    function validateBeneficiaryAllocations(memberId, newPercentage, excludeBenId = null) {
      // Get all beneficiaries for this member except the one being edited
      const memberBeneficiaries = beneficiaries.filter(b => 
        b.memberId === memberId && b.id !== excludeBenId
      );
      
      // Calculate total percentage
      let total = newPercentage;
      memberBeneficiaries.forEach(b => {
        total += parseInt(b.percentage) || 0;
      });
      
      if (total > 100) {
        return { valid: false, error: `Total allocation would be ${total}%. Maximum is 100%` };
      }
      
      return { valid: true, total: total, remaining: 100 - total };
    }
    
    /**
     * Check for duplicate beneficiaries
     */
    function checkDuplicateBeneficiary(memberId, idNumber, excludeBenId = null) {
      const duplicate = beneficiaries.find(b => 
        b.memberId === memberId && 
        b.idNum === idNumber && 
        b.id !== excludeBenId
      );
      
      if (duplicate) {
        return { isDuplicate: true, beneficiary: duplicate };
      }
      
      return { isDuplicate: false, beneficiary: null };
    }
    
    /**
     * Validate relationship type
     */
    function validateRelationship(relationship) {
      const validRelationships = [
        'Spouse', 'Child', 'Parent', 'Sibling', 
        'Grandchild', 'Grandparent', 'Partner', 'Other'
      ];
      
      if (!validRelationships.includes(relationship)) {
        return { valid: false, error: 'Please select a valid relationship type' };
      }
      
      return { valid: true };
    }
    
    // Default/initial data - includes all registered members
    let members = [
      { id: 'MEM001', name: 'Thabo Mkhize', email: 'member@test.com', password: 'password123', phone: '0721234567', idNum: '8712345678901', status: 'Active', missedPayments: 0 },
      { id: 'MEM002', name: 'Nomsa Dlamini', email: 'nomsa@test.com', password: 'password123', phone: '0731234567', idNum: '9012345678901', status: 'Active', missedPayments: 0 },
      { id: 'MEM003', name: 'Sipho Ndlela', email: 'sipho@test.com', password: 'password123', phone: '0741234567', idNum: '7812345678901', status: 'Active', missedPayments: 0 },
      { id: 'MEM004', name: 'Lerato Motaung', email: 'lerato@sbahle.com', password: 'password123', phone: '0751234567', idNum: '8912345678901', status: 'Active', missedPayments: 0 },
      { id: 'MEM005', name: 'Mandla Khoza', email: 'mandla@sbahle.com', password: 'password123', phone: '0761234567', idNum: '7712345678901', status: 'Active', missedPayments: 0 },
      { id: 'MEM006', name: 'Zanele Ngcobo', email: 'zanele@sbahle.com', password: 'password123', phone: '0771234567', idNum: '9212345678901', status: 'Active', missedPayments: 0 },
      { id: 'MEM007', name: 'Mlungisi Maqashela', email: 'maqashela@gmail.com', password: 'mM!47258369', phone: '0781234567', idNum: '9512345678902', status: 'Active', missedPayments: 0 }
    ];
    let beneficiaries = [
      { id: 'B1', memberId: 'MEM001', name: 'Aisha Mkhize', relationship: 'Spouse', idNum: '9512345678901', percentage: 50 },
      { id: 'B2', memberId: 'MEM001', name: 'Omuhle Mkhize', relationship: 'Child', idNum: '2015123456', percentage: 50 },
      { id: 'B3', memberId: 'MEM004', name: 'Thabo Motaung', relationship: 'Child', idNum: '2012345678901', percentage: 60 },
      { id: 'B4', memberId: 'MEM004', name: 'Precious Motaung', relationship: 'Child', idNum: '2016789012345', percentage: 40 },
      { id: 'B5', memberId: 'MEM005', name: 'Beauty Khoza', relationship: 'Spouse', idNum: '8512345678901', percentage: 80 },
      { id: 'B6', memberId: 'MEM005', name: 'Junior Khoza', relationship: 'Child', idNum: '2018901234567', percentage: 20 },
      { id: 'B7', memberId: 'MEM006', name: 'Siphiwe Ngcobo', relationship: 'Child', idNum: '2010123456789', percentage: 100 }
    ];
    let payouts = [
      { id: 'PO1', memberId: 'MEM001', memberName: 'Thabo Mkhize', amount: 5000, reason: 'Funeral', status: 'Pending' }
    ];
    let penalties = [
      { id: 'PEN1', memberId: 'MEM002', memberName: 'Nomsa Dlamini', amount: 30, date: '2025-03-10', status: 'Pending' }
    ];
    let meetingMinutes = []; // Store meeting minutes
    let paymentProofs = []; // Store payment proof uploads
    let payoutCollectors = []; // Store payout collectors: { memberId, collectors: [{name, phone}, {name, phone}] }
    let constitutionDocument = null; // Store constitution document: { title, uploadDate, fileData, fileSize, fileType, notes }
    let currentUser = null;
    
    // Admin users for multi-admin system
    let adminUsers = JSON.parse(localStorage.getItem('adminUsers') || JSON.stringify([
      {
        id: 'admin-1',
        username: 'admin',
        password: 'Sbhahle2025',
        role: 'fulladmin',
        createdDate: '2024-01-01',
        lastLogin: null
      }
    ]));
    let currentAdmin = null; // Current admin session
    let auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]'); // Audit log for tracking admin actions
    let tempBeneficiaries = [];
    let isDrawing = false;
    let memberIdCounter = 7; // Start from 7 since we have MEM001-MEM006
    let minutesIdCounter = 1;
    let proofIdCounter = 1;
    
    // Initialize system data on load
    async function initializeSystem() {
      // Failsafe: Force hide loading after 5 seconds no matter what
      const failsafeTimeout = setTimeout(() => {
        console.warn('‚ö†Ô∏è Loading timeout - forcing UI to display');
        hideLoading();
      }, 5000);
      
      try {
        // Initialize cloud storage
        await initCloudStorage();
        
        // Load data from cloud or localStorage
        await loadDataFromStorage();
        
        console.log('‚úì System initialized with', members.length, 'members');
        
        // Check if critical members exist (like MEM007 - Mlungisi Maqashela)
        const mem007 = members.find(m => m.id === 'MEM007');
        if (!mem007) {
          console.warn('‚ö†Ô∏è Critical member MEM007 missing - restoring default data');
          // Restore the member if missing
          members.push({
            id: 'MEM007',
            name: 'Mlungisi Maqashela',
            email: 'maqashela@gmail.com',
            password: 'mM!47258369',
            phone: '0781234567',
            idNum: '9512345678902',
            status: 'Active',
            missedPayments: 0
          });
          // Force save to cloud
          await saveDataToStorage(true);
          console.log('‚úÖ Member MEM007 restored and synced to cloud');
        }
        
        // Start health monitoring
        startHealthMonitoring();
        
        // Start periodic sync verification
        startSyncVerification();
        
        // Clear failsafe since loading completed successfully
        clearTimeout(failsafeTimeout);
      } catch (error) {
        console.error('‚ùå System initialization error:', error);
        hideLoading();
        clearTimeout(failsafeTimeout);
      }
      
      // Start automated backup system
      initBackupSystem();
      
      console.log('‚úÖ All systems initialized successfully');
    }
    
    // Monitor sync health and auto-recover
    function startHealthMonitoring() {
      setInterval(() => {
        const now = Date.now();
        const timeSinceLastSync = now - SYNC_HEALTH.lastSuccessfulSync;
        const timeSinceLastAttempt = now - lastSyncAttempt;
        
        // If no successful sync in 5 minutes and we're online, investigate
        if (timeSinceLastSync > 300000 && navigator.onLine && cloudStorageAvailable) {
          console.warn('‚ö†Ô∏è No successful sync in 5 minutes - running health check...');
          
          // Check if we have pending queue items
          if (syncQueue.length > 0) {
            console.log(`üì§ Processing ${syncQueue.length} pending sync operations...`);
            processSyncQueue();
          } else {
            // Try a test sync
            console.log('üîÑ Attempting recovery sync...');
            saveDataToStorage(true);
          }
        }
        
        // If too many consecutive failures, reset and reinitialize
        if (SYNC_HEALTH.consecutiveFailures >= 5) {
          console.error('‚ùå Too many consecutive sync failures - reinitializing cloud connection...');
          SYNC_HEALTH.consecutiveFailures = 0;
          cloudStorageAvailable = false;
          initCloudStorage();
        }
        
        // Log health status every 10 minutes
        if (now % 600000 < 30000) { // Within 30 seconds of 10-minute mark
          console.log('üìä Sync Health Status:', {
            consecutiveFailures: SYNC_HEALTH.consecutiveFailures,
            totalSyncs: SYNC_HEALTH.totalSyncs,
            totalFailures: SYNC_HEALTH.totalFailures,
            successRate: SYNC_HEALTH.totalSyncs > 0 
              ? ((SYNC_HEALTH.totalSyncs - SYNC_HEALTH.totalFailures) / SYNC_HEALTH.totalSyncs * 100).toFixed(1) + '%'
              : 'N/A',
            lastSuccessfulSync: SYNC_HEALTH.lastSuccessfulSync 
              ? new Date(SYNC_HEALTH.lastSuccessfulSync).toLocaleString()
              : 'Never',
            queueSize: syncQueue.length,
            averageSyncTime: SYNC_HEALTH.averageSyncTime + 'ms'
          });
        }
      }, 30000); // Check every 30 seconds
    }
    
    // Verify sync integrity periodically
    function startSyncVerification() {
      setInterval(async () => {
        // Only verify if we're online and cloud is available
        if (!navigator.onLine || !cloudStorageAvailable) return;
        
        // Don't verify if currently syncing
        if (isSyncing) return;
        
        try {
          console.log('üîç Running sync verification...');
          
          // Fetch latest cloud data
          const response = await fetch(`${CLOUD_STORAGE.endpoint}/${CLOUD_STORAGE.binId}/latest`, {
            headers: {
              'X-Access-Key': CLOUD_STORAGE.apiKey
            }
          });
          
          if (response.ok) {
            const result = await response.json();
            const cloudData = result.record;
            
            // Compare with local data
            const localMemberCount = members.length;
            const cloudMemberCount = cloudData.members?.length || 0;
            
            if (localMemberCount !== cloudMemberCount) {
              console.warn('‚ö†Ô∏è Member count mismatch detected!', {
                local: localMemberCount,
                cloud: cloudMemberCount
              });
              
              // Merge and sync
              const merged = mergeData(
                {
                  members, beneficiaries, payouts, penalties, meetingMinutes,
                  paymentProofs, payoutCollectors, constitutionDocument,
                  memberIdCounter, minutesIdCounter, proofIdCounter,
                  lastSaved: new Date().toISOString()
                },
                cloudData
              );
              
              // Update local with merged data
              members = merged.members || [];
              beneficiaries = merged.beneficiaries || [];
              
              console.log('‚úÖ Data synchronized:', {
                members: members.length,
                beneficiaries: beneficiaries.length
              });
              
              // Save merged data
              await saveDataToStorage(true);
            } else {
              console.log('‚úÖ Sync verification passed - data is consistent');
            }
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Sync verification failed:', error.message);
        }
      }, 120000); // Verify every 2 minutes
    }
    
    // Initialize system and load saved data on page load
    initializeSystem();

    // CANVAS
    window.addEventListener('load', function() {
      const canvas = document.getElementById('sigCanvas');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        
        canvas.addEventListener('mousedown', (e) => { 
          isDrawing = true;
          const rect = canvas.getBoundingClientRect();
          ctx.beginPath();
          ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        });
        canvas.addEventListener('mousemove', (e) => {
          if (!isDrawing) return;
          const rect = canvas.getBoundingClientRect();
          ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
          ctx.stroke();
        });
        canvas.addEventListener('mouseup', () => { isDrawing = false; });
        canvas.addEventListener('mouseleave', () => { isDrawing = false; });
        
        // Touch support for mobile
        canvas.addEventListener('touchstart', (e) => {
          e.preventDefault();
          isDrawing = true;
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.beginPath();
          ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        });
        canvas.addEventListener('touchmove', (e) => {
          e.preventDefault();
          if (!isDrawing) return;
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
          ctx.stroke();
        });
        canvas.addEventListener('touchend', (e) => {
          e.preventDefault();
          isDrawing = false;
        });
      }
    });

    function clearSig() {
      const canvas = document.getElementById('sigCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function saveSig() {
      const canvas = document.getElementById('sigCanvas');
      
      // Check if canvas has any drawing
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const isBlank = !imageData.data.some(channel => channel !== 0);
      
      if (isBlank) {
        showAlert('memberAlert', '‚ö† Please draw your signature first', 'error');
        return;
      }
      
      // Convert canvas to base64 image
      const signatureData = canvas.toDataURL('image/png');
      
      // Save to current user
      if (currentUser) {
        currentUser.signature = signatureData;
        
        // Update in members array
        const memberIndex = members.findIndex(m => m.id === currentUser.id);
        if (memberIndex !== -1) {
          members[memberIndex].signature = signatureData;
          saveDataToStorage();
          
          // Show preview
          document.getElementById('savedSignatureImg').src = signatureData;
          document.getElementById('savedSignaturePreview').style.display = 'block';
          
          showAlert('memberAlert', '‚úì Signature saved successfully!', 'success');
        }
      }
    }
    
    // ===== SYNC HEALTH MONITORING FUNCTIONS =====
    
    // Display sync health statistics
    function displaySyncHealth() {
      const successRate = SYNC_HEALTH.totalSyncs > 0 
        ? ((SYNC_HEALTH.totalSyncs - SYNC_HEALTH.totalFailures) / SYNC_HEALTH.totalSyncs * 100).toFixed(1) + '%'
        : 'N/A';
      
      const lastSyncText = SYNC_HEALTH.lastSuccessfulSync 
        ? new Date(SYNC_HEALTH.lastSuccessfulSync).toLocaleString()
        : 'Never';
      
      document.getElementById('syncTotalCount').textContent = SYNC_HEALTH.totalSyncs;
      document.getElementById('syncSuccessRate').textContent = successRate;
      document.getElementById('syncFailures').textContent = SYNC_HEALTH.consecutiveFailures;
      document.getElementById('syncAvgTime').textContent = SYNC_HEALTH.averageSyncTime + 'ms';
      document.getElementById('syncLastSuccess').textContent = lastSyncText;
      document.getElementById('syncQueueSize').textContent = syncQueue.length + ' operations pending';
      
      // Color code based on health
      const failureEl = document.getElementById('syncFailures');
      if (SYNC_HEALTH.consecutiveFailures === 0) {
        failureEl.style.color = '#10b981'; // Green
      } else if (SYNC_HEALTH.consecutiveFailures < 3) {
        failureEl.style.color = '#f59e0b'; // Yellow
      } else {
        failureEl.style.color = '#ef4444'; // Red
      }
      
      console.log('üìä Sync health displayed:', {
        totalSyncs: SYNC_HEALTH.totalSyncs,
        successRate: successRate,
        consecutiveFailures: SYNC_HEALTH.consecutiveFailures,
        queueSize: syncQueue.length
      });
    }
    
    // Force immediate sync
    async function forceSyncNow() {
      showAlert('adminAlert', 'üîÑ Forcing immediate sync...', 'info');
      
      try {
        // Check internet connection
        if (!navigator.onLine) {
          showAlert('adminAlert', '‚ö†Ô∏è No internet connection. Data saved locally.', 'error');
          return;
        }
        
        // Reinitialize cloud if needed
        if (!cloudStorageAvailable) {
          showAlert('adminAlert', 'üîÑ Reconnecting to cloud storage...', 'info');
          await initCloudStorage();
        }
        
        // Process any queued operations first
        if (syncQueue.length > 0) {
          showAlert('adminAlert', `üì§ Processing ${syncQueue.length} queued operations...`, 'info');
          await processSyncQueue();
        }
        
        // Force save
        const success = await saveDataToStorage(true);
        
        if (success) {
          showAlert('adminAlert', '‚úÖ Sync completed successfully!', 'success');
          displaySyncHealth();
        } else {
          showAlert('adminAlert', '‚ö†Ô∏è Sync failed. Data saved locally. Will retry automatically.', 'error');
        }
      } catch (error) {
        console.error('Force sync error:', error);
        showAlert('adminAlert', '‚ùå Sync error: ' + error.message, 'error');
      }
    }
    
    // ===== BACKUP MANAGEMENT FUNCTIONS =====
    
    // Download pending email backup
    function downloadPendingEmailBackup() {
      const backupMeta = localStorage.getItem('pending_email_backup');
      if (backupMeta) {
        const meta = JSON.parse(backupMeta);
        const a = document.createElement('a');
        a.href = meta.url;
        a.download = `SBS-Weekly-Backup-${meta.date.split('T')[0]}.json`;
        a.click();
        
        // Clear pending notice
        localStorage.removeItem('pending_email_backup');
        document.getElementById('pendingBackupNotice').style.display = 'none';
        
        showAlert('adminAlert', '‚úÖ Weekly backup downloaded!', 'success');
      }
    }
    
    // Show backup snapshots list
    function showBackupSnapshots() {
      const snapshotsList = document.getElementById('snapshotsList');
      const snapshotsContent = document.getElementById('snapshotsContent');
      
      // Get all backup snapshots
      const snapshots = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(STORAGE_KEY + '_backup_')) {
          const dateStr = key.split('_backup_')[1];
          const data = localStorage.getItem(key);
          if (data) {
            snapshots.push({
              key: key,
              date: dateStr,
              size: data.length
            });
          }
        }
      }
      
      // Sort by date (newest first)
      snapshots.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (snapshots.length === 0) {
        snapshotsContent.innerHTML = '<p style="color: #999; font-size: 13px; margin: 0;">No snapshots available</p>';
      } else {
        snapshotsContent.innerHTML = snapshots.map(snap => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px; margin-bottom: 8px;">
            <div>
              <div style="font-size: 13px; font-weight: 600;">${new Date(snap.date).toLocaleDateString()}</div>
              <div style="font-size: 11px; color: #666;">${(snap.size / 1024).toFixed(2)} KB</div>
            </div>
            <div style="display: flex; gap: 5px;">
              <button class="btn btn-primary" onclick="restoreFromSnapshot('${snap.key}')" style="font-size: 11px; padding: 5px 10px;">Restore</button>
              <button class="btn btn-secondary" onclick="downloadSnapshot('${snap.key}')" style="font-size: 11px; padding: 5px 10px;">Download</button>
            </div>
          </div>
        `).join('');
      }
      
      // Toggle visibility
      snapshotsList.style.display = snapshotsList.style.display === 'none' ? 'block' : 'none';
    }
    
    // Download specific snapshot
    function downloadSnapshot(key) {
      const data = localStorage.getItem(key);
      if (data) {
        const decrypted = decryptData(data);
        const blob = new Blob([JSON.stringify(decrypted, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const dateStr = key.split('_backup_')[1];
        const a = document.createElement('a');
        a.href = url;
        a.download = `SBS-Snapshot-${dateStr}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showAlert('adminAlert', '‚úÖ Snapshot downloaded!', 'success');
      }
    }
    
    // Restore from snapshot
    async function restoreFromSnapshot(key) {
      if (!confirm('‚ö†Ô∏è This will replace all current data with the snapshot. Are you sure?')) {
        return;
      }
      
      try {
        const data = localStorage.getItem(key);
        if (!data) {
          showAlert('adminAlert', '‚ùå Snapshot not found', 'error');
          return;
        }
        
        const backupData = decryptData(data);
        const dateStr = key.split('_backup_')[1];
        
        // Restore data
        members = backupData.members || [];
        beneficiaries = backupData.beneficiaries || [];
        payouts = backupData.payouts || [];
        penalties = backupData.penalties || [];
        meetingMinutes = backupData.meetingMinutes || [];
        paymentProofs = backupData.paymentProofs || [];
        payoutCollectors = backupData.payoutCollectors || [];
        constitutionDocument = backupData.constitutionDocument || null;
        memberIdCounter = backupData.memberIdCounter || 7;
        minutesIdCounter = backupData.minutesIdCounter || 1;
        proofIdCounter = backupData.proofIdCounter || 1;
        
        if (backupData.attendance) {
          localStorage.setItem('attendance', JSON.stringify(backupData.attendance));
        }
        
        // Save restored data
        await saveDataToStorage(true);
        
        showAlert('adminAlert', `‚úÖ Data restored from snapshot (${new Date(dateStr).toLocaleDateString()})`, 'success');
        
        // Refresh displays
        displayMem();
        updateStorageInfo();
        
      } catch (error) {
        console.error('Restore error:', error);
        showAlert('adminAlert', '‚ùå Restore failed: ' + error.message, 'error');
      }
    }
    
    // Update backup display info
    function updateBackupDisplay() {
      // Check for pending email backup
      const pendingBackup = localStorage.getItem('pending_email_backup');
      const pendingNotice = document.getElementById('pendingBackupNotice');
      if (pendingBackup && pendingNotice) {
        pendingNotice.style.display = 'block';
      }
      
      // Update last backup dates
      const lastWeekly = localStorage.getItem(BACKUP_CONFIG.LAST_EMAIL_BACKUP_KEY);
      const lastMonthly = localStorage.getItem(BACKUP_CONFIG.LAST_MONTHLY_BACKUP_KEY);
      
      const weeklyEl = document.getElementById('lastWeeklyBackup');
      const monthlyEl = document.getElementById('lastMonthlyBackup');
      
      if (weeklyEl) {
        weeklyEl.textContent = lastWeekly 
          ? new Date(parseInt(lastWeekly)).toLocaleDateString()
          : 'Never';
      }
      
      if (monthlyEl) {
        monthlyEl.textContent = lastMonthly 
          ? new Date(parseInt(lastMonthly)).toLocaleDateString()
          : 'Never';
      }
      
      // Count snapshots
      let snapshotCount = 0;
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(STORAGE_KEY + '_backup_')) {
          snapshotCount++;
        }
      }
      
      const countEl = document.getElementById('backupSnapshotCount');
      if (countEl) {
        countEl.textContent = snapshotCount;
      }
    }

    // LOGIN
    function showLoginForm(type) {
      document.getElementById('adminForm').classList.toggle('hidden', type !== 'admin');
      document.getElementById('memberForm').classList.toggle('hidden', type !== 'member');
      document.getElementById('registerForm').classList.toggle('hidden', type !== 'register');
      document.getElementById('forgotPasswordForm').classList.add('hidden');
      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tabs .tab')[type === 'admin' ? 0 : type === 'member' ? 1 : 2].classList.add('active');
    }

    function loginAdmin() {
      const username = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      
      console.log('üîê Login attempt:', { username, passwordLength: password.length });
      console.log('üìã adminUsers available:', typeof adminUsers !== 'undefined', 'count:', adminUsers?.length);
      
      // Ensure adminUsers is loaded from localStorage if not already
      if (typeof adminUsers === 'undefined' || !adminUsers || adminUsers.length === 0) {
        console.warn('‚ö†Ô∏è adminUsers not initialized, loading from localStorage...');
        try {
          const stored = localStorage.getItem('adminUsers');
          if (stored) {
            adminUsers = JSON.parse(stored);
            console.log('‚úì Loaded adminUsers from localStorage:', adminUsers.length);
          } else {
            // Initialize default admin
            adminUsers = [{
              id: 'admin-1',
              username: 'admin',
              password: 'Sbhahle2025',
              role: 'fulladmin',
              createdDate: '2024-01-01',
              lastLogin: null
            }];
            localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
            console.log('‚úì Created default admin user');
          }
        } catch (e) {
          console.error('‚ùå Error loading adminUsers:', e);
        }
      }
      
      // Debug: Show what we're looking for
      console.log('üîç Looking for match:', { username, password });
      console.log('üìã Available admins:', adminUsers.map(a => ({ username: a.username, role: a.role })));
      
      // Check if multi-admin system is initialized
      if (adminUsers && adminUsers.length > 0) {
        // Use multi-admin system
        const admin = adminUsers.find(a => a.username === username && a.password === password);
        
        console.log('üîé Admin found:', admin ? 'YES' : 'NO');
        
        if (!admin) {
          alert('‚ùå Invalid username or password\n\nUsername: admin\nPassword: Sbhahle2025');
          console.error('‚ùå Login failed - no matching admin found');
          return;
        }
        
        // Update last login
        admin.lastLogin = new Date().toISOString();
        localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
        
        // Set current admin
        currentAdmin = admin;
        currentUser = { type: 'admin', role: admin.role };
        
        console.log('‚úÖ Login successful as:', admin.username, '(' + admin.role + ')');
        
        // Log login
        if (typeof logAdminAction === 'function') {
          logAdminAction('LOGIN', `Logged in as ${admin.role}`);
        }
        
        // Show admin page
        show('adminPage');
        updateAdmin();
        
        // Update admin displays if functions exist
        if (typeof updateCurrentAdminDisplay === 'function') updateCurrentAdminDisplay();
        if (typeof updateAdminUsersDisplay === 'function') updateAdminUsersDisplay();
        if (typeof updateAuditLogPreview === 'function') updateAuditLogPreview();
        
      } else {
        // Fallback to basic admin login
        console.warn('‚ö†Ô∏è Using fallback login (admin123)');
        if (username === 'admin' && password === 'admin123') {
          currentUser = { type: 'admin' };
          show('adminPage');
          updateAdmin();
          console.log('‚úÖ Logged in with fallback credentials');
        } else {
          alert('‚ùå Invalid username or password');
          console.error('‚ùå Fallback login failed');
          return;
        }
      }
      
      // Update sync status
      if (cloudStorageAvailable) {
        updateSyncStatus('default');
      } else {
        updateSyncStatus('offline');
      }
    }

    function resetAdminCredentials() {
      if (!confirm('üîß Reset admin credentials to default?\n\nUsername: admin\nPassword: Sbhahle2025\n\nThis will clear old admin data from localStorage.')) {
        return;
      }
      
      console.log('üîß Resetting admin credentials...');
      
      // Force reset adminUsers in localStorage
      const defaultAdmin = [{
        id: 'admin-1',
        username: 'admin',
        password: 'Sbhahle2025',
        role: 'fulladmin',
        createdDate: '2024-01-01',
        lastLogin: null
      }];
      
      localStorage.setItem('adminUsers', JSON.stringify(defaultAdmin));
      
      // Update the global variable
      adminUsers = defaultAdmin;
      
      console.log('‚úÖ Admin credentials reset to default');
      console.log('üìã New adminUsers:', adminUsers);
      
      alert('‚úÖ Admin credentials reset!\n\nUsername: admin\nPassword: Sbhahle2025\n\nPlease try logging in again.');
    }

    function loginMember() {
      const email = document.getElementById('memberEmail').value;
      const password = document.getElementById('memberPassword').value;
      
      if (!email || !password) {
        alert('‚ö† Please enter both email and password');
        return;
      }
      
      const m = members.find(x => x.email === email);
      if (!m) {
        alert('‚ùå Email not found. Please check your email or register.');
        return;
      }
      
      if (m.password !== password) {
        alert('‚ùå Incorrect password. Please try again.');
        return;
      }
      
      // Successful login
      currentUser = m;
      // Load beneficiaries for this member from the main beneficiaries array - using fast clone
      tempBeneficiaries = beneficiaries.filter(b => b.memberId === m.id).map(b => fastClone(b));
      console.log('Member logged in:', m.id);
      console.log('Filtered beneficiaries:', tempBeneficiaries);
      show('memberPage');
      updateMember();
      
      // Update sync status immediately
      if (cloudStorageAvailable) {
        updateSyncStatus('default');
      } else {
        updateSyncStatus('offline');
      }
    }

    // FORGOT PASSWORD FUNCTIONALITY
    let verifiedMember = null;

    function showForgotPassword() {
      document.getElementById('adminForm').classList.add('hidden');
      document.getElementById('memberForm').classList.add('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.remove('hidden');
      document.getElementById('resetStep1').classList.remove('hidden');
      document.getElementById('resetStep2').classList.add('hidden');
      document.getElementById('resetEmail').value = '';
      document.getElementById('resetIdNumber').value = '';
      document.getElementById('resetNewPassword').value = '';
      document.getElementById('resetConfirmPassword').value = '';
      verifiedMember = null;
      clearAlerts();
    }

    async function verifyIdentity() {
      const email = document.getElementById('resetEmail').value.trim();
      const idNumber = document.getElementById('resetIdNumber').value.trim();

      if (!email || !idNumber) {
        showAlert('alertMsg', '‚ö† Please enter both email and ID number', 'warning');
        return;
      }

      // Find member by email
      const member = members.find(m => m.email.toLowerCase() === email.toLowerCase());

      if (!member) {
        showAlert('alertMsg', '‚ùå No account found with this email address', 'error');
        return;
      }

      // In a real system, you would verify against stored ID number
      // For now, we'll use a simple verification that the ID number has been entered
      // You should store ID numbers during registration for proper verification
      
      // Store a simple verification flag (in production, verify against member.idNumber)
      if (idNumber.length < 8) {
        showAlert('alertMsg', '‚ùå Please enter a valid ID number', 'error');
        return;
      }

      // Identity verified
      verifiedMember = member;
      document.getElementById('resetStep1').classList.add('hidden');
      document.getElementById('resetStep2').classList.remove('hidden');
      clearAlerts();
    }

    async function resetPassword() {
      const newPassword = document.getElementById('resetNewPassword').value;
      const confirmPassword = document.getElementById('resetConfirmPassword').value;

      if (!newPassword || !confirmPassword) {
        showAlert('alertMsg', '‚ö† Please fill in all fields', 'warning');
        return;
      }

      if (newPassword.length < 6) {
        showAlert('alertMsg', '‚ö† Password must be at least 6 characters long', 'warning');
        return;
      }

      if (newPassword !== confirmPassword) {
        showAlert('alertMsg', '‚ùå Passwords do not match', 'error');
        return;
      }

      if (!verifiedMember) {
        showAlert('alertMsg', '‚ùå Identity verification failed. Please try again.', 'error');
        return;
      }

      // Update password
      verifiedMember.password = newPassword;
      
      // Update in members array
      const memberIndex = members.findIndex(m => m.id === verifiedMember.id);
      if (memberIndex !== -1) {
        members[memberIndex].password = newPassword;
      }

      // Save to cloud with force immediate sync
      const cloudSaveSuccess = await saveDataToStorage(true);
      
      if (cloudSaveSuccess === true) {
        showAlert('alertMsg', '‚úÖ PASSWORD RESET SUCCESSFUL! You can now login with your new password.', 'success');
        
        // Wait 2 seconds then redirect to login
        setTimeout(() => {
          showLoginForm('member');
          document.getElementById('memberEmail').value = verifiedMember.email;
          document.getElementById('memberPassword').value = '';
        }, 2000);
      } else {
        showAlert('alertMsg', '‚ö† Password updated locally but cloud sync failed. Please contact admin.', 'warning');
      }

      verifiedMember = null;
    }

    async function registerMember() {
      const name = document.getElementById('regName').value;
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      const phone = document.getElementById('regPhone').value;
      const idNum = document.getElementById('regId').value;
      
      // Validation
      if (!name || !email || !password || !confirmPassword || !phone || !idNum) { 
        alert('‚ö† Please fill all fields'); 
        return; 
      }
      
      // Check if email already exists
      if (members.find(m => m.email === email)) {
        alert('‚ùå This email is already registered. Please use a different email or login.');
        return;
      }
      
      // Password validation
      if (password.length < 6) {
        alert('‚ö† Password must be at least 6 characters long');
        return;
      }
      
      if (password !== confirmPassword) {
        alert('‚ùå Passwords do not match. Please try again.');
        return;
      }
      
      // Create new member
      const newId = 'MEM' + String(memberIdCounter).padStart(3, '0');
      memberIdCounter++;
      members.push({ 
        id: newId, 
        name, 
        email, 
        password,
        phone, 
        idNum, 
        status: 'Active', 
        missedPayments: 0,
        registeredAt: new Date().toISOString()
      });
      
      // Force immediate save to cloud (no debouncing for registration)
      console.log('üìù Saving new member registration:', newId, name);
      await saveDataToStorage(true);
      console.log('‚úÖ New member saved to cloud');
      
      // Clear form
      document.getElementById('regName').value = '';
      document.getElementById('regEmail').value = '';
      document.getElementById('regPassword').value = '';
      document.getElementById('regConfirmPassword').value = '';
      document.getElementById('regPhone').value = '';
      document.getElementById('regId').value = '';
      
      alert('‚úì Registration successful! You can now login with your email and password.');
      showLoginForm('member');
    }

    function logout() {
      currentUser = null;
      show('loginPage');
    }

    function show(p) {
      document.getElementById('loginPage').classList.toggle('hidden', p !== 'loginPage');
      document.getElementById('adminPage').classList.toggle('hidden', p !== 'adminPage');
      document.getElementById('memberPage').classList.toggle('hidden', p !== 'memberPage');
    }

    function adminTab(t, e) {
      document.getElementById('overviewTab').classList.toggle('hidden', t !== 'overview');
      document.getElementById('financialsTab').classList.toggle('hidden', t !== 'financials');
      document.getElementById('membersTab').classList.toggle('hidden', t !== 'members');
      document.getElementById('beneficiariesTab').classList.toggle('hidden', t !== 'beneficiaries');
      document.getElementById('paymentsTab').classList.toggle('hidden', t !== 'payments');
      document.getElementById('payoutsTab').classList.toggle('hidden', t !== 'payouts');
      document.getElementById('penaltiesTab').classList.toggle('hidden', t !== 'penalties');
      document.getElementById('attendanceTab').classList.toggle('hidden', t !== 'attendance');
      document.getElementById('minutesTab').classList.toggle('hidden', t !== 'minutes');
      document.getElementById('constitutionTab').classList.toggle('hidden', t !== 'constitution');
      document.getElementById('dataTab').classList.toggle('hidden', t !== 'data');
      document.querySelectorAll('#adminPage .tab').forEach(x => x.classList.remove('active'));
      if (e && e.target) e.target.classList.add('active');
      if (t === 'members') { displayMem(); }
      if (t === 'financials') { initializeFinancialDashboard(); }
      if (t === 'beneficiaries') { populateBenSelect(); loadBeneficiaries(); }
      if (t === 'payments') displayAdminPaymentProofs();
      if (t === 'payouts') displayPayouts();
      if (t === 'penalties') displayPenalties();
      if (t === 'minutes') displayMeetingMinutes();
      if (t === 'constitution') displayConstitution();
      if (t === 'attendance') { 
        // Set today's date if not already set
        const dateInput = document.getElementById('meetingDate');
        if (!dateInput.value) {
          dateInput.value = new Date().toISOString().split('T')[0];
          document.getElementById('meetingTime').value = new Date().toTimeString().slice(0,5);
        }
        showAttendanceList(); 
      }
      if (t === 'data') { updateStorageInfo(); displaySyncHealth(); updateBackupDisplay(); updateAdminUsersDisplay(); updateAuditLogPreview(); }
    }
    
    function updateStorageInfo() {
      // Get attendance data
      const attendanceData = JSON.parse(localStorage.getItem('attendance') || '{}');
      const activeMembers = members.filter(m => m.status === 'Active');
      
      // Update overview cards
      document.getElementById('totalMembers').textContent = members.length;
      document.getElementById('totalMeetings').textContent = Object.keys(attendanceData).length;
      document.getElementById('totalBeneficiaries').textContent = beneficiaries.length;
      document.getElementById('totalPayouts').textContent = payouts.length;
      
      // Update detailed storage info
      document.getElementById('storageMembers').textContent = members.length;
      document.getElementById('storageBeneficiaries').textContent = beneficiaries.length;
      document.getElementById('storagePayouts').textContent = payouts.length;
      document.getElementById('storagePenalties').textContent = penalties.length;
      document.getElementById('storageAttendance').textContent = Object.keys(attendanceData).length;
      document.getElementById('storageActiveMembers').textContent = activeMembers.length;
      
      // Update metadata
      const encrypted = localStorage.getItem(STORAGE_KEY);
      if (encrypted) {
        try {
          const data = decryptData(encrypted);
          if (data && data.lastSaved) {
            document.getElementById('lastSavedTime').textContent = new Date(data.lastSaved).toLocaleString();
          }
          if (data && data.version) {
            document.getElementById('dataVersion').textContent = data.version;
          }
        } catch (e) {
          console.log('Could not read metadata');
        }
      }
      
      // Calculate storage size
      try {
        const totalStorage = JSON.stringify({
          members,
          beneficiaries,
          payouts,
          penalties,
          attendance: attendanceData
        }).length;
        const sizeKB = (totalStorage / 1024).toFixed(2);
        document.getElementById('storageSize').textContent = `${sizeKB} KB`;
      } catch (e) {
        document.getElementById('storageSize').textContent = 'Error calculating';
      }
    }

    function memberTab(t, e) {
      console.log('memberTab called:', t);
      
      try {
        // Safely toggle visibility with null checks
        const profileTab = document.getElementById('memberProfileTab');
        const signatureTab = document.getElementById('memberSignatureTab');
        const contributionsTab = document.getElementById('contributionsTab');
        const beneficiariesTab = document.getElementById('memberBeneficiariesTab');
        const payoutsTab = document.getElementById('memberPayoutsTab');
        const minutesTab = document.getElementById('memberMinutesTab');
        const paymentsTab = document.getElementById('memberPaymentsTab');
        const constitutionTab = document.getElementById('memberConstitutionTab');
        const documentsTab = document.getElementById('documentsTab');
        
        if (profileTab) profileTab.classList.toggle('hidden', t !== 'profile');
        if (signatureTab) signatureTab.classList.toggle('hidden', t !== 'signature');
        if (contributionsTab) contributionsTab.classList.toggle('hidden', t !== 'contributions');
        if (beneficiariesTab) beneficiariesTab.classList.toggle('hidden', t !== 'beneficiaries');
        if (payoutsTab) payoutsTab.classList.toggle('hidden', t !== 'payouts');
        if (minutesTab) minutesTab.classList.toggle('hidden', t !== 'minutes');
        if (paymentsTab) paymentsTab.classList.toggle('hidden', t !== 'payments');
        if (constitutionTab) constitutionTab.classList.toggle('hidden', t !== 'constitution');
        if (documentsTab) documentsTab.classList.toggle('hidden', t !== 'documents');
        
        // Update active tab styling
        document.querySelectorAll('#memberPage .tab').forEach(x => x.classList.remove('active'));
        if (e && e.target) e.target.classList.add('active');
        
        // Execute tab-specific actions
        if (t === 'profile') {
          if (currentUser) updateMember();
        }
        if (t === 'minutes') displayMemberMinutes();
        if (t === 'payments') displayMemberPaymentProofs();
        if (t === 'constitution') displayConstitutionMember();
        if (t === 'beneficiaries') {
          // Refresh tempBeneficiaries from the main beneficiaries array - using fast clone
          tempBeneficiaries = beneficiaries.filter(b => b.memberId === currentUser.id).map(b => fastClone(b));
          console.log('Beneficiaries tab clicked, count:', tempBeneficiaries.length);
          console.log('Beneficiaries data:', tempBeneficiaries);
          // Wait for the tab to be visible before rendering
          setTimeout(() => {
            console.log('Calling displayMemBen after tab is visible');
            displayMemBen();
          }, 50);
        }
        if (t === 'signature') {
          // Load saved signature if exists
          const savedSignatureImg = document.getElementById('savedSignatureImg');
          const savedSignaturePreview = document.getElementById('savedSignaturePreview');
          
          if (currentUser && currentUser.signature) {
            if (savedSignatureImg) savedSignatureImg.src = currentUser.signature;
            if (savedSignaturePreview) savedSignaturePreview.style.display = 'block';
          } else {
            if (savedSignaturePreview) savedSignaturePreview.style.display = 'none';
          }
        }
        if (t === 'payouts') displayMemPayouts();
        
        console.log('memberTab completed successfully');
      } catch (error) {
        console.error('Error in memberTab:', error);
        alert('Error switching tabs: ' + error.message + '\n\nPlease refresh the page (Ctrl+F5) and try again.');
      }
    }

    function updateAdmin() {
      document.getElementById('totalMem').textContent = members.length;
      document.getElementById('activeMem').textContent = members.filter(m => m.status === 'Active').length;
      document.getElementById('suspMem').textContent = members.filter(m => m.status === 'Suspended').length;
      
      // Refresh attendance display if the attendance tab is active
      if (document.getElementById('attendanceTab') && !document.getElementById('attendanceTab').classList.contains('hidden')) {
        const meetingDate = document.getElementById('meetingDate');
        if (meetingDate && meetingDate.value) {
          showAttendanceList();
          console.log('‚úì Attendance list refreshed with latest member signatures');
        }
      }
      
      // Refresh meeting minutes display if the minutes tab is active
      if (document.getElementById('minutesTab') && !document.getElementById('minutesTab').classList.contains('hidden')) {
        displayMeetingMinutes();
        console.log('‚úì Meeting minutes refreshed:', meetingMinutes.length, 'minutes available');
      }
    }

    function updateMember() {
      // Check if currentUser exists and member page elements are in DOM
      if (!currentUser) {
        console.warn('‚ö†Ô∏è updateMember called but currentUser is null');
        return;
      }
      
      // Check if we're on the member page
      const memberPage = document.getElementById('memberPage');
      if (!memberPage || memberPage.classList.contains('hidden')) {
        console.log('‚ÑπÔ∏è updateMember skipped - member page not visible');
        return;
      }
      
      // Safely update elements with null checks
      const memId = document.getElementById('memId');
      if (memId) memId.textContent = currentUser.id;
      
      const memberProfName = document.getElementById('memberProfName');
      if (memberProfName) memberProfName.value = currentUser.name;
      
      const memberProfEmail = document.getElementById('memberProfEmail');
      if (memberProfEmail) memberProfEmail.value = currentUser.email;
      
      const memberProfPhone = document.getElementById('memberProfPhone');
      if (memberProfPhone) memberProfPhone.value = currentUser.phone;
      
      const memberProfIdNumber = document.getElementById('memberProfIdNumber');
      if (memberProfIdNumber) memberProfIdNumber.value = currentUser.idNumber || '';
      
      const profRole = document.getElementById('profRole');
      if (profRole) profRole.value = currentUser.role || 'Member';
      
      const badge = document.getElementById('memStatus');
      if (badge) {
        badge.textContent = currentUser.status;
        badge.className = `badge badge-${currentUser.status === 'Active' ? 'active' : 'suspended'}`;
      }
      
      // Make sure tempBeneficiaries is loaded from the main beneficiaries array - using fast clone
      if (!tempBeneficiaries || tempBeneficiaries.length === 0) {
        tempBeneficiaries = beneficiaries.filter(b => b.memberId === currentUser.id).map(b => fastClone(b));
        console.log('updateMember: loaded', tempBeneficiaries.length, 'beneficiaries');
      }
      
      // Update member minutes display if the tab is active
      if (document.getElementById('memberMinutesTab') && !document.getElementById('memberMinutesTab').classList.contains('hidden')) {
        displayMemberMinutes();
        console.log('‚úì Member minutes refreshed:', meetingMinutes.length, 'minutes available');
      }
    }

    // Optimized table rendering with DOM fragment for better performance
    function displayMem() {
      const startTime = performance.now();
      const cacheKey = `members_table_${members.length}_${Date.now()}`;
      let cached = getFromCache(cacheKey);
      
      if (!cached) {
        const fragment = document.createDocumentFragment();
        
        members.forEach(m => {
          const row = document.createElement('tr');
          const regDate = m.registeredAt ? new Date(m.registeredAt).toLocaleDateString('en-ZA', {year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A';
          const role = m.role || 'Member';
          
          // Get contribution status badge
          const contribStatus = getMemberContributionStatus(m);
          const statusBadge = getStatusBadgeHTML(contribStatus);
          
          row.innerHTML = `<td>${m.id}</td><td>${m.name}</td><td>${m.email}</td><td><span class="badge badge-pending">${role}</span></td><td>${regDate}</td><td><span class="badge badge-${m.status === 'Active' ? 'active' : 'suspended'}">${m.status}</span></td><td>${m.missedPayments}</td><td>${statusBadge}</td><td>
            <button class="btn btn-primary btn-sm" onclick="editMemModal('${m.id}')">Edit</button>
            <button class="btn btn-warning btn-sm" onclick="editMemberRole('${m.id}')">Role</button>
            ${m.status === 'Suspended' ? `<button class="btn btn-success btn-sm" onclick="reactMem('${m.id}')">Reactivate</button>` : ''}
            <button class="btn btn-danger btn-sm" onclick="delMem('${m.id}')">Delete</button>
          </td>`;
          fragment.appendChild(row);
        });
        
        const tableElement = document.getElementById('memTable');
        // Clear and append in one operation
        tableElement.innerHTML = '';
        tableElement.appendChild(fragment);
        
        setCache(cacheKey, true); // Cache the rendering state
        trackPerformance('renderTime', startTime);
      }
    }

    function displayPayouts() {
      const startTime = performance.now();
      const cacheKey = `payouts_table_${payouts.length}_${Date.now()}`;
      let cached = getFromCache(cacheKey);
      
      if (!cached) {
        const fragment = document.createDocumentFragment();
        
        payouts.forEach(p => {
          const row = document.createElement('tr');
          
          // Format recipients display
          let recipientsDisplay = '';
          if (p.recipients && p.recipients.length > 0) {
            recipientsDisplay = p.recipients.map((r, index) => {
              if (r.name && r.phone) {
                return `<div><strong>Recipient ${index + 1}:</strong> ${r.name} (${r.phone})</div>`;
              }
              return '';
            }).filter(r => r !== '').join('');
          }
          
          row.innerHTML = `<td>${p.memberName}</td><td>R ${p.amount}</td><td>${p.reason}</td><td>${recipientsDisplay || '-'}</td><td><span class="badge badge-${p.status === 'Pending' ? 'pending' : 'approved'}">${p.status}</span></td><td>
            ${p.status === 'Pending' ? `<button class="btn btn-success btn-sm" onclick="appPayout('${p.id}')">Approve</button> <button class="btn btn-danger btn-sm" onclick="rejPayout('${p.id}')">Reject</button>` : '-'}
          </td>`;
          fragment.appendChild(row);
        });
        
        const tableElement = document.getElementById('payTable');
        tableElement.innerHTML = '';
        tableElement.appendChild(fragment);
        
        setCache(cacheKey, true);
        trackPerformance('renderTime', startTime);
      }
    }

    function displayPenalties() {
      let html = '';
      penalties.forEach(p => {
        html += `<tr><td>${p.memberName}</td><td>R ${p.amount}</td><td>${p.date}</td><td><span class="badge badge-${p.status === 'Pending' ? 'pending' : 'approved'}">${p.status}</span></td><td>
          <button class="btn btn-success btn-sm" onclick="payPen('${p.id}')">Mark Paid</button>
        </td></tr>`;
      });
      document.getElementById('penTable').innerHTML = html;
    }

    function populateBenSelect() {
      let opts = '<option value="">-- Select --</option>';
      members.forEach(m => opts += `<option value="${m.id}">${m.name}</option>`);
      document.getElementById('memSelectBen').innerHTML = opts;
    }

    function loadBeneficiaries() {
      const id = document.getElementById('memSelectBen').value;
      document.getElementById('addBenBtn').style.display = id ? 'inline-block' : 'none';
      document.getElementById('payoutBenBtn').style.display = id ? 'inline-block' : 'none';
      const bens = beneficiaries.filter(b => b.memberId === id);
      let html = '';
      if (bens.length > 0) {
        bens.forEach(b => {
          html += `<tr><td>${b.name}</td><td>${b.relationship}</td><td>${b.idNum}</td><td>${b.percentage}%</td><td>
            <button class="btn btn-primary btn-sm" onclick="editBen('${b.id}')">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="delBen('${b.id}')">Delete</button>
          </td></tr>`;
        });
      } else if (id) {
        html = '<tr><td colspan="5" style="text-align: center; color: #999;">No beneficiaries added for this member</td></tr>';
      } else {
        html = '<tr><td colspan="5" style="text-align: center; color: #999;">Please select a member</td></tr>';
      }
      document.getElementById('benTableBody').innerHTML = html;
    }

    function displayMemBen() {
      console.log('displayMemBen called with', tempBeneficiaries.length, 'beneficiaries');
      console.log('Beneficiaries data:', JSON.stringify(tempBeneficiaries));
      
      const tbody = document.getElementById('memBenTableBody');
      
      if (!tbody) {
        console.error('Table body not found!');
        return;
      }
      
      let html = '';
      
      if (tempBeneficiaries && tempBeneficiaries.length > 0) {
        tempBeneficiaries.forEach((b, i) => {
          html += '<tr>';
          html += '<td>' + (b.name || 'N/A') + '</td>';
          html += '<td>' + (b.relationship || 'N/A') + '</td>';
          html += '<td>' + (b.idNum || 'N/A') + '</td>';
          html += '<td><strong>' + (b.percentage || 0) + '%</strong></td>';
          html += '<td><button class="btn btn-danger btn-sm" onclick="removeMemBen(' + i + ')">Remove</button></td>';
          html += '</tr>';
        });
      } else {
        html = '<tr><td colspan="5" style="text-align: center; color: #999;">No beneficiaries added yet</td></tr>';
      }
      
      console.log('Generated HTML:', html.substring(0, 200));
      tbody.innerHTML = html;
      console.log('Table updated with', tempBeneficiaries.length, 'rows');
      console.log('Table body HTML after update:', tbody.innerHTML.substring(0, 200));
      
      // Update button visibility
      const addBtn = document.getElementById('addBenMemBtn');
      const saveBtn = document.getElementById('saveBenMemBtn');
      
      if (addBtn) {
        if (tempBeneficiaries.length >= 5) {
          addBtn.classList.add('hidden');
        } else {
          addBtn.classList.remove('hidden');
        }
      }
      
      if (saveBtn) {
        if (tempBeneficiaries.length > 0) {
          saveBtn.classList.remove('hidden');
        } else {
          saveBtn.classList.add('hidden');
        }
      }
    }

    function removeMemBen(idx) {
      tempBeneficiaries.splice(idx, 1);
      displayMemBen();
      showAlert('memberAlert', '‚úì Beneficiary removed', 'success');
    }

    function displayMemPayouts() {
      let html = '';
      payouts.filter(p => p.memberId === currentUser.id).forEach(p => {
        // Format recipients display
        let recipientsDisplay = '-';
        if (p.recipients && p.recipients.length > 0) {
          recipientsDisplay = p.recipients.map((r, index) => {
            if (r.name && r.phone) {
              return `<div style="font-size:0.85em;"><strong>R${index + 1}:</strong> ${r.name} (${r.phone})</div>`;
            }
            return '';
          }).filter(r => r !== '').join('');
        }
        html += `<tr><td>${p.date || 'N/A'}</td><td>R ${p.amount}</td><td>${p.reason}</td><td>${recipientsDisplay}</td><td><span class="badge badge-${p.status === 'Pending' ? 'pending' : 'approved'}">${p.status}</span></td></tr>`;
      });
      document.getElementById('memPayTable').innerHTML = html || '<tr><td colspan="5">No payouts</td></tr>';
    }

    // MODALS
    function openModal(html) {
      document.getElementById('modContent').innerHTML = html;
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
    }

    function addMemberModal() {
      openModal(`
        <h2>Add Member</h2>
        <div class="form-group"><label>Name</label><input type="text" id="newMName"></div>
        <div class="form-group"><label>Email</label><input type="text" id="newMEmail"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="newMPhone"></div>
        <div class="form-group"><label>ID</label><input type="text" id="newMId"></div>
        <button class="btn btn-success" onclick="saveMem()">Save</button>
      `);
    }

    function saveMem() {
      const name = document.getElementById('newMName').value;
      const email = document.getElementById('newMEmail').value;
      const phone = document.getElementById('newMPhone').value;
      const idNum = document.getElementById('newMId').value;
      if (!name || !email || !phone || !idNum) { alert('Fill all'); return; }
      const newId = 'MEM' + String(memberIdCounter).padStart(3, '0');
      memberIdCounter++;
      members.push({ id: newId, name, email, phone, idNum, status: 'Active', missedPayments: 0 });
      saveDataToStorage(); // Auto-save
      closeModal();
      displayMem();
      updateAdmin();
      showAlert('adminAlert', '‚úì Member added!', 'success');
    }

    function editMemModal(id) {
      const m = members.find(x => x.id === id);
      openModal(`
        <h2>Edit Member</h2>
        <div class="form-group"><label>Name</label><input type="text" id="editMName" value="${m.name}"></div>
        <div class="form-group"><label>Email</label><input type="text" id="editMEmail" value="${m.email}"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="editMPhone" value="${m.phone}"></div>
        <div class="form-group"><label>Status</label><select id="editMStatus"><option value="Active" ${m.status === 'Active' ? 'selected' : ''}>Active</option><option value="Suspended" ${m.status === 'Suspended' ? 'selected' : ''}>Suspended</option></select></div>
        <button class="btn btn-primary" onclick="updateMem('${id}')">Update</button>
      `);
    }

    function updateMem(id) {
      const m = members.find(x => x.id === id);
      m.name = document.getElementById('editMName').value;
      m.email = document.getElementById('editMEmail').value;
      m.phone = document.getElementById('editMPhone').value;
      m.status = document.getElementById('editMStatus').value;
      saveDataToStorage(); // Auto-save
      closeModal();
      displayMem();
      showAlert('adminAlert', '‚úì Updated!', 'success');
    }

    function delMem(id) {
      if (confirm('Delete member?')) {
        members = members.filter(m => m.id !== id);
        beneficiaries = beneficiaries.filter(b => b.memberId !== id);
        payouts = payouts.filter(p => p.memberId !== id);
        saveDataToStorage(); // Auto-save
        displayMem();
        updateAdmin();
        showAlert('adminAlert', '‚úì Deleted!', 'success');
      }
    }

    function reactMem(id) {
      const m = members.find(x => x.id === id);
      if (m) {
        m.status = 'Active';
        m.missedPayments = 0;
        saveDataToStorage(); // Auto-save
        displayMem();
        updateAdmin();
        showAlert('adminAlert', '‚úì Reactivated!', 'success');
      }
    }

    function addBenModal() {
      const memId = document.getElementById('memSelectBen').value;
      const m = members.find(x => x.id === memId);
      const count = beneficiaries.filter(b => b.memberId === memId).length;
      if (count >= 5) { alert('Max 5 beneficiaries'); return; }
      openModal(`
        <h2>Add Beneficiary for ${m.name}</h2>
        <div class="form-group"><label>Name</label><input type="text" id="benName"></div>
        <div class="form-group"><label>Relationship</label><select id="benRel"><option>Spouse</option><option>Child</option><option>Parent</option><option>Sibling</option><option>Extended Family</option></select></div>
        <div class="form-group"><label>ID Number</label><input type="text" id="benId"></div>
        <div class="form-group"><label>Percentage (%)</label><input type="number" id="benPerc" min="0" max="100"></div>
        <button class="btn btn-success" onclick="saveBen('${memId}')">Save</button>
      `);
    }

    function saveBen(memId) {
      const name = document.getElementById('benName').value.trim();
      const rel = document.getElementById('benRel').value;
      const idNum = document.getElementById('benId').value.trim();
      const perc = parseInt(document.getElementById('benPerc').value);
      
      // Basic validation
      if (!name || !rel || !idNum || !perc) {
        alert('‚ùå Please fill all fields');
        return;
      }
      
      // Validate South African ID
      const idValidation = validateSouthAfricanID(idNum);
      if (!idValidation.valid) {
        alert(`‚ùå Invalid ID Number: ${idValidation.error}`);
        return;
      }
      
      // Calculate and display age
      const age = calculateAgeFromID(idNum);
      if (age !== null) {
        console.log(`‚úì Beneficiary ${name} - Age: ${age}, Gender: ${getGenderFromID(idNum)}`);
      }
      
      // Validate relationship
      const relValidation = validateRelationship(rel);
      if (!relValidation.valid) {
        alert(`‚ùå ${relValidation.error}`);
        return;
      }
      
      // Check for duplicates
      const dupCheck = checkDuplicateBeneficiary(memId, idNum);
      if (dupCheck.isDuplicate) {
        alert(`‚ùå This beneficiary is already added for this member:\n${dupCheck.beneficiary.name} (${dupCheck.beneficiary.relationship})`);
        return;
      }
      
      // Validate allocation percentage
      if (perc < 1 || perc > 100) {
        alert('‚ùå Percentage must be between 1 and 100');
        return;
      }
      
      const allocValidation = validateBeneficiaryAllocations(memId, perc);
      if (!allocValidation.valid) {
        alert(`‚ùå ${allocValidation.error}\n\nCurrent allocation: ${allocValidation.total - perc}%\nYou can only add up to ${100 - (allocValidation.total - perc)}%`);
        return;
      }
      
      // All validations passed - add beneficiary
      beneficiaries.push({ 
        id: 'B' + Date.now(), 
        memberId: memId, 
        name, 
        relationship: rel, 
        idNum, 
        percentage: perc 
      });
      
      saveDataToStorage(); // Auto-save
      closeModal();
      loadBeneficiaries();
      
      const remaining = allocValidation.remaining;
      let message = `‚úÖ Beneficiary added successfully!\n\nTotal allocated: ${allocValidation.total}%`;
      if (remaining > 0) {
        message += `\nRemaining: ${remaining}%`;
      } else {
        message += `\n‚úì 100% allocation complete`;
      }
      
      showAlert('adminAlert', message, 'success');
    }

    function editBen(id) {
      const b = beneficiaries.find(x => x.id === id);
      openModal(`
        <h2>Edit Beneficiary</h2>
        <div class="form-group"><label>Percentage</label><input type="number" id="editPerc" value="${b.percentage}"></div>
        <button class="btn btn-primary" onclick="updateBen('${id}')">Update</button>
      `);
    }

    function updateBen(id) {
      const b = beneficiaries.find(x => x.id === id);
      b.percentage = parseInt(document.getElementById('editPerc').value);
      saveDataToStorage(); // Auto-save
      closeModal();
      loadBeneficiaries();
      showAlert('adminAlert', '‚úì Updated!', 'success');
    }

    function delBen(id) {
      if (confirm('Delete beneficiary?')) {
        beneficiaries = beneficiaries.filter(b => b.id !== id);
        saveDataToStorage(); // Auto-save
        loadBeneficiaries();
        showAlert('adminAlert', '‚úì Deleted!', 'success');
      }
    }

    function appPayout(id) {
      const p = payouts.find(x => x.id === id);
      if (p) {
        p.status = 'Approved';
        saveDataToStorage(); // Auto-save
        displayPayouts();
        showAlert('adminAlert', '‚úì Payout approved!', 'success');
      }
    }

    function rejPayout(id) {
      const p = payouts.find(x => x.id === id);
      if (p) {
        p.status = 'Rejected';
        saveDataToStorage(); // Auto-save
        displayPayouts();
        showAlert('adminAlert', '‚úì Payout rejected!', 'success');
      }
    }

    // Create payout from beneficiaries tab
    function createPayoutModal() {
      const memberId = document.getElementById('memSelectBen').value;
      if (!memberId) {
        alert('‚ö† Please select a member first');
        return;
      }
      
      const member = members.find(m => m.id === memberId);
      if (!member) return;
      
      const memberBeneficiaries = beneficiaries.filter(b => b.memberId === memberId);
      
      if (memberBeneficiaries.length === 0) {
        alert('‚ö† This member has no beneficiaries. Please add beneficiaries first.');
        return;
      }
      
      const benOptions = memberBeneficiaries.map(b => 
        `<option value="${b.id}">${b.name} (${b.relationship})</option>`
      ).join('');
      
      const html = `
        <h2>Create Payout for ${member.name}</h2>
        <p style="color: #666; margin-bottom: 15px;">Select up to 2 beneficiaries to receive the payout</p>
        
        <div class="form-group">
          <label>Payout Amount (R)</label>
          <input type="number" id="payoutAmount" min="0" placeholder="e.g., 5000">
        </div>
        
        <div class="form-group">
          <label>Reason</label>
          <select id="payoutReason">
            <option>Funeral</option>
            <option>Emergency</option>
            <option>Medical</option>
            <option>Other</option>
          </select>
        </div>
        
        <h3 style="margin-top: 20px; font-size: 16px;">Recipient 1</h3>
        <div class="form-group">
          <label>Select Beneficiary</label>
          <select id="recipient1">
            <option value="">-- Select Beneficiary --</option>
            ${benOptions}
          </select>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" id="recipient1Phone" placeholder="e.g., 0721234567">
        </div>
        
        <h3 style="margin-top: 20px; font-size: 16px;">Recipient 2 (Optional)</h3>
        <div class="form-group">
          <label>Select Beneficiary</label>
          <select id="recipient2">
            <option value="">-- Select Beneficiary --</option>
            ${benOptions}
          </select>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" id="recipient2Phone" placeholder="e.g., 0731234567">
        </div>
        
        <button class="btn btn-primary" onclick="submitBeneficiaryPayout('${memberId}', '${member.name}')">Create Payout</button>
      `;
      openModal(html);
    }

    async function submitBeneficiaryPayout(memberId, memberName) {
      const amount = document.getElementById('payoutAmount').value;
      const reason = document.getElementById('payoutReason').value;
      const recipient1Id = document.getElementById('recipient1').value;
      const recipient1Phone = document.getElementById('recipient1Phone').value;
      const recipient2Id = document.getElementById('recipient2').value;
      const recipient2Phone = document.getElementById('recipient2Phone').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        alert('‚ö† Please enter a valid amount');
        return;
      }
      
      if (!recipient1Id || !recipient1Phone) {
        alert('‚ö† Please select Recipient 1 and provide their phone number');
        return;
      }
      
      if (recipient2Id && !recipient2Phone) {
        alert('‚ö† Please provide phone number for Recipient 2');
        return;
      }
      
      if (recipient1Id === recipient2Id && recipient2Id) {
        alert('‚ö† Please select different beneficiaries for Recipient 1 and 2');
        return;
      }
      
      const recipient1 = beneficiaries.find(b => b.id === recipient1Id);
      const recipient2 = recipient2Id ? beneficiaries.find(b => b.id === recipient2Id) : null;
      
      let recipients = [
        { name: recipient1.name, phone: recipient1Phone }
      ];
      
      if (recipient2) {
        recipients.push({ name: recipient2.name, phone: recipient2Phone });
      }
      
      const newPayout = {
        id: 'PO' + Date.now(),
        memberId: memberId,
        memberName: memberName,
        amount: parseFloat(amount),
        reason: reason,
        recipients: recipients,
        status: 'Pending',
        createdAt: new Date().toISOString()
      };
      
      payouts.push(newPayout);
      await saveDataToStorage(true);
      closeModal();
      showAlert('adminAlert', '‚úì Payout created successfully!', 'success');
      displayPayouts();
    }

    function payPen(id) {
      const p = penalties.find(x => x.id === id);
      if (p) {
        p.status = 'Paid';
        saveDataToStorage(); // Auto-save
        displayPenalties();
        showAlert('adminAlert', '‚úì Marked as paid!', 'success');
      }
    }

    function checkMissed() {
      members.forEach(m => {
        if (m.missedPayments >= 3) m.status = 'Suspended';
      });
      saveDataToStorage(); // Auto-save
      displayMem();
      updateAdmin();
      showAlert('adminAlert', '‚úì Checked! Members with 3+ missed payments suspended', 'success');
    }

    function applyPen() {
      const today = new Date();
      if (today.getDate() >= 8) {
        members.forEach(m => {
          if (m.status === 'Active' && !penalties.find(p => p.memberId === m.id && p.date === today.toISOString().split('T')[0])) {
            penalties.push({
              id: 'PEN' + Date.now(),
              memberId: m.id,
              memberName: m.name,
              amount: 30,
              date: today.toISOString().split('T')[0],
              status: 'Pending'
            });
          }
        });
        saveDataToStorage(); // Auto-save
        displayPenalties();
        showAlert('adminAlert', '‚úì R30 penalty applied to all active members!', 'success');
      } else {
        showAlert('adminAlert', 'Penalties only apply after 8th of month', 'warning');
      }
    }

    // MEMBER FUNCTIONS
    function editMemberProf() {
      try {
        const nameInput = document.getElementById('memberProfName');
        const emailInput = document.getElementById('memberProfEmail');
        const phoneInput = document.getElementById('memberProfPhone');
        const idInput = document.getElementById('memberProfIdNumber');
        const saveBtn = document.getElementById('saveMemberProf');
        
        if (!nameInput || !emailInput || !phoneInput || !idInput || !saveBtn) {
          console.error('‚ùå Profile edit failed - missing form elements');
          alert('‚ö† Error: Profile form not found. Please refresh the page.');
          return;
        }
        
        nameInput.disabled = false;
        emailInput.disabled = false;
        phoneInput.disabled = false;
        idInput.disabled = false;
        saveBtn.classList.remove('hidden');
        
        console.log('‚úì Profile editing enabled');
      } catch (error) {
        console.error('‚ùå Error in editMemberProf:', error);
        alert('‚ö† Error enabling profile edit. Please refresh and try again.');
      }
    }

    async function saveMemberProf() {
      try {
        const nameInput = document.getElementById('memberProfName');
        const emailInput = document.getElementById('memberProfEmail');
        const phoneInput = document.getElementById('memberProfPhone');
        const idInput = document.getElementById('memberProfIdNumber');
        const saveBtn = document.getElementById('saveMemberProf');
        
        if (!nameInput || !emailInput || !phoneInput || !idInput || !saveBtn) {
          alert('‚ö† Error: Form elements not found');
          return;
        }
        
        if (!currentUser) {
          alert('‚ö† Error: No user session found. Please login again.');
          return;
        }
        
        // Validate inputs
        if (!nameInput.value.trim()) {
          alert('‚ö† Name cannot be empty');
          return;
        }
        
        if (!emailInput.value.trim() || !emailInput.value.includes('@')) {
          alert('‚ö† Please enter a valid email address');
          return;
        }
        
        if (!phoneInput.value.trim()) {
          alert('‚ö† Phone number cannot be empty');
          return;
        }
        
        // Update currentUser
        currentUser.name = nameInput.value.trim();
        currentUser.email = emailInput.value.trim();
        currentUser.phone = phoneInput.value.trim();
        currentUser.idNumber = idInput.value.trim();
        
        // Disable fields
        nameInput.disabled = true;
        emailInput.disabled = true;
        phoneInput.disabled = true;
        idInput.disabled = true;
        saveBtn.classList.add('hidden');
        
        // Update in members array
        const memberIndex = members.findIndex(m => m.id === currentUser.id);
        if (memberIndex !== -1) {
          members[memberIndex].name = currentUser.name;
          members[memberIndex].email = currentUser.email;
          members[memberIndex].phone = currentUser.phone;
          members[memberIndex].idNumber = currentUser.idNumber;
          
          console.log('‚úì Member data updated:', currentUser.name);
          
          const cloudSaveSuccess = await saveDataToStorage(true);
          
          if (cloudSaveSuccess === true) {
            showAlert('memberAlert', '‚úÖ Profile updated and synced to cloud!', 'success');
            console.log('‚úì Profile saved to cloud successfully');
          } else {
            showAlert('memberAlert', '‚ö† Profile updated locally but cloud sync failed. Changes saved locally.', 'warning');
            console.warn('‚ö†Ô∏è Cloud sync failed but local save succeeded');
          }
        } else {
          alert('‚ö† Error: Member not found in database');
          console.error('‚ùå Member not found:', currentUser.id);
        }
      } catch (error) {
        console.error('‚ùå Error in saveMemberProf:', error);
        alert('‚ö† Error saving profile. Please try again.');
      }
    }

    function addContribModal() {
      openModal(`
        <h2>Add Contribution</h2>
        <div class="alert alert-warning">Minimum: R 170.00</div>
        <div class="form-group"><label>Amount (R)</label><input type="number" id="contAmt" min="170" value="170"></div>
        <div class="form-group"><label>Method</label><select id="contMeth"><option>Bank Transfer</option><option>EFT</option><option>Cash</option></select></div>
        <div class="form-group"><label>Reference</label><input type="text" id="contRef"></div>
        <button class="btn btn-success" onclick="submitContrib()">Submit</button>
      `);
    }

    function submitContrib() {
      const amt = parseFloat(document.getElementById('contAmt').value);
      if (amt < 170) { alert('Minimum R 170'); return; }
      closeModal();
      showAlert('memberAlert', '‚úì Contribution submitted! Pending verification', 'success');
    }

    function addBenMemModal() {
      if (tempBeneficiaries.length >= 5) { alert('Max 5'); return; }
      openModal(`
        <h2>Add Beneficiary</h2>
        <div class="form-group"><label>Name</label><input type="text" id="memBenName"></div>
        <div class="form-group"><label>Relationship</label><select id="memBenRel"><option>Spouse</option><option>Child</option><option>Parent</option><option>Sibling</option><option>Extended Family</option></select></div>
        <div class="form-group"><label>ID Number</label><input type="text" id="memBenId"></div>
        <div class="form-group"><label>Percentage (%)</label><input type="number" id="memBenPerc" min="0" max="100"></div>
        <button class="btn btn-success" onclick="addMemBen()">Add</button>
      `);
    }

    function addMemBen() {
      const name = document.getElementById('memBenName').value.trim();
      const rel = document.getElementById('memBenRel').value;
      const idNum = document.getElementById('memBenId').value.trim();
      const perc = parseInt(document.getElementById('memBenPerc').value);
      
      // Basic validation
      if (!name || !rel || !idNum || !perc) {
        alert('‚ùå Please fill all fields');
        return;
      }
      
      // Validate South African ID
      const idValidation = validateSouthAfricanID(idNum);
      if (!idValidation.valid) {
        alert(`‚ùå Invalid ID Number: ${idValidation.error}`);
        return;
      }
      
      // Display age and gender info
      const age = calculateAgeFromID(idNum);
      const gender = getGenderFromID(idNum);
      if (age !== null) {
        console.log(`‚úì Adding beneficiary: ${name}, Age: ${age}, Gender: ${gender}`);
      }
      
      // Check for duplicates in temp beneficiaries
      const tempDuplicate = tempBeneficiaries.find(b => b.idNum === idNum);
      if (tempDuplicate) {
        alert(`‚ùå This beneficiary is already added:\n${tempDuplicate.name} (${tempDuplicate.relationship})`);
        return;
      }
      
      // Validate percentage
      if (perc < 1 || perc > 100) {
        alert('‚ùå Percentage must be between 1 and 100');
        return;
      }
      
      // Calculate current total
      const currentTotal = tempBeneficiaries.reduce((sum, b) => sum + (b.percentage || 0), 0);
      const newTotal = currentTotal + perc;
      
      if (newTotal > 100) {
        alert(`‚ùå Total allocation cannot exceed 100%\n\nCurrent total: ${currentTotal}%\nTrying to add: ${perc}%\nWould be: ${newTotal}%\n\nMaximum you can add: ${100 - currentTotal}%`);
        return;
      }
      
      // All validations passed
      tempBeneficiaries.push({ 
        id: 'BT' + Date.now(), 
        memberId: currentUser.id, 
        name, 
        relationship: rel, 
        idNum, 
        percentage: perc 
      });
      
      closeModal();
      displayMemBen();
      document.getElementById('saveBenMemBtn').classList.remove('hidden');
      
      const remaining = 100 - newTotal;
      let message = `‚úÖ Beneficiary added!\n\nTotal: ${newTotal}%`;
      if (remaining > 0) {
        message += `\nRemaining: ${remaining}%`;
      } else {
        message += `\n‚úì 100% allocated - You can now save`;
      }
      
      showAlert('memberAlert', message, 'success');
    }

    function saveBenMem() {
      // Validate total percentage equals 100%
      const total = tempBeneficiaries.reduce((sum, b) => sum + b.percentage, 0);
      if (total !== 100) {
        showAlert('memberAlert', `‚ö† Total allocation must equal 100%. Current total: ${total}%`, 'error');
        return;
      }
      
      // Validate we have at least one beneficiary
      if (tempBeneficiaries.length === 0) {
        showAlert('memberAlert', '‚ö† Please add at least one beneficiary', 'error');
        return;
      }
      
      tempBeneficiaries.forEach(b => {
        if (!beneficiaries.find(x => x.id === b.id)) {
          beneficiaries.push(b);
        }
      });
      saveDataToStorage(); // Auto-save
      document.getElementById('saveBenMemBtn').classList.add('hidden');
      document.getElementById('addBenMemBtn').classList.add('hidden');
      showAlert('memberAlert', '‚úì Beneficiaries locked! Cannot modify', 'success');
    }

    // Initialize on load
    window.addEventListener('load', () => {
      console.log('Window loaded');
    });

    function saveDocs() {
      const payFile = document.getElementById('payFile').files[0];
      const deathFile = document.getElementById('deathFile').files[0];
      const suppFile = document.getElementById('suppFile').files[0];
      if (!payFile && !deathFile && !suppFile) { alert('Select at least one file'); return; }
      showAlert('memberAlert', '‚úì Documents uploaded successfully!', 'success');
      document.getElementById('payFile').value = '';
      document.getElementById('deathFile').value = '';
      document.getElementById('suppFile').value = '';
    }

    function reqPayoutModal() {
      openModal(`
        <h2>Request Payout</h2>
        <p style="color: #666; margin-bottom: 15px;">Specify who can claim this payout (up to 2 people)</p>
        
        <div class="form-group">
          <label>Amount (R)</label>
          <input type="number" id="payoutAmt" min="100" placeholder="e.g., 5000">
        </div>
        
        <div class="form-group">
          <label>Reason</label>
          <select id="payoutReason">
            <option value="">-- Select Reason --</option>
            <option>Funeral</option>
            <option>Emergency</option>
            <option>Medical</option>
            <option>Other</option>
          </select>
        </div>
        
        <h3 style="margin-top: 20px; font-size: 16px; border-top: 1px solid #ddd; padding-top: 15px;">Recipient 1 (Required)</h3>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="recipient1Name" placeholder="e.g., John Doe">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" id="recipient1Phone" placeholder="e.g., 0721234567">
        </div>
        
        <h3 style="margin-top: 20px; font-size: 16px; border-top: 1px solid #ddd; padding-top: 15px;">Recipient 2 (Optional)</h3>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="recipient2Name" placeholder="e.g., Jane Smith">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" id="recipient2Phone" placeholder="e.g., 0731234567">
        </div>
        
        <button class="btn btn-success" onclick="submitPayout()">Submit Request</button>
      `);
    }

    function submitPayout() {
      const amt = document.getElementById('payoutAmt').value;
      const reason = document.getElementById('payoutReason').value;
      const recipient1Name = document.getElementById('recipient1Name').value.trim();
      const recipient1Phone = document.getElementById('recipient1Phone').value.trim();
      const recipient2Name = document.getElementById('recipient2Name').value.trim();
      const recipient2Phone = document.getElementById('recipient2Phone').value.trim();
      
      if (!amt || !reason) { 
        alert('‚ö† Please fill in amount and reason'); 
        return; 
      }
      
      if (!recipient1Name || !recipient1Phone) { 
        alert('‚ö† Please provide Recipient 1 name and phone number'); 
        return; 
      }
      
      if (recipient2Name && !recipient2Phone) {
        alert('‚ö† Please provide phone number for Recipient 2');
        return;
      }
      
      if (recipient2Phone && !recipient2Name) {
        alert('‚ö† Please provide name for Recipient 2');
        return;
      }
      
      // Build recipients array
      let recipients = [
        { name: recipient1Name, phone: recipient1Phone }
      ];
      
      if (recipient2Name && recipient2Phone) {
        recipients.push({ name: recipient2Name, phone: recipient2Phone });
      }
      
      payouts.push({
        id: 'PO' + Date.now(),
        memberId: currentUser.id,
        memberName: currentUser.name,
        amount: parseInt(amt),
        reason: reason,
        recipients: recipients,
        status: 'Pending',
        date: new Date().toISOString().split('T')[0],
        createdAt: new Date().toISOString()
      });
      saveDataToStorage(true); // Auto-save with cloud sync
      closeModal();
      displayMemPayouts();
      showAlert('memberAlert', '‚úì Payout requested! Awaiting admin approval', 'success');
    }

    function showAlert(id, msg, type) {
      const el = document.getElementById(id);
      if (el) {
        el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        setTimeout(() => el.innerHTML = '', 4000);
      }
    }

    // Signature Canvas Setup
    let signatureCanvas;
    let signatureCtx;
    let lastX = 0;
    let lastY = 0;

    function setupSignatureCanvas() {
      signatureCanvas = document.getElementById('signatureCanvas');
      signatureCtx = signatureCanvas.getContext('2d');
      signatureCtx.strokeStyle = '#000';
      signatureCtx.lineWidth = 2;
      signatureCtx.lineCap = 'round';

      signatureCanvas.addEventListener('mousedown', startDrawing);
      signatureCanvas.addEventListener('mousemove', draw);
      signatureCanvas.addEventListener('mouseup', stopDrawing);
      signatureCanvas.addEventListener('mouseout', stopDrawing);

      // Touch events for mobile
      signatureCanvas.addEventListener('touchstart', handleTouch);
      signatureCanvas.addEventListener('touchmove', handleTouch);
      signatureCanvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e) {
      isDrawing = true;
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }

    function draw(e) {
      if (!isDrawing) return;
      signatureCtx.beginPath();
      signatureCtx.moveTo(lastX, lastY);
      signatureCtx.lineTo(e.offsetX, e.offsetY);
      signatureCtx.stroke();
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }

    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = signatureCanvas.getBoundingClientRect();
      const offsetX = touch.clientX - rect.left;
      const offsetY = touch.clientY - rect.top;

      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });

      if (e.type === 'touchstart') {
        startDrawing({ offsetX, offsetY });
      } else if (e.type === 'touchmove') {
        draw({ offsetX, offsetY });
      }
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function clearSignature() {
      signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }

    async function saveSignature() {
      const signature = signatureCanvas.toDataURL();
      if (!currentUser) return;
      
      // Save signature to user data
      const member = members.find(m => m.id === currentUser.id);
      if (member) {
        member.signature = signature;
        // Update currentUser signature as well
        currentUser.signature = signature;
        
        // Show saving status
        showAlert('memberAlert', 'üíæ Saving signature to cloud...', 'info');
        
        // Force immediate cloud sync to ensure signature is saved immediately
        const cloudSaveSuccess = await saveDataToStorage(true);
        
        if (cloudSaveSuccess === true) {
          showAlert('memberAlert', '‚úÖ SIGNATURE SAVED TO CLOUD! You can now see it in attendance register.', 'success');
          console.log('‚úÖ Signature saved to CLOUD for member:', member.name, member.id);
          
          // Display current signature
          document.getElementById('currentSignature').style.display = 'block';
          document.getElementById('savedSignature').src = signature;
        } else {
          // Cloud save failed - show clear error
          showAlert('memberAlert', '‚ùå CLOUD SYNC FAILED! Signature saved locally only. Please save again or contact admin.', 'error');
          console.error('‚ùå Cloud sync FAILED for:', member.name, member.id);
          console.error('Signature saved locally but NOT in cloud - will NOT show in attendance');
          
          // Still display the signature locally
          document.getElementById('currentSignature').style.display = 'block';
          document.getElementById('savedSignature').src = signature;
          
          // Show retry button
          setTimeout(() => {
            showAlert('memberAlert', '‚ö†Ô∏è Click "Save Signature" again to retry cloud sync', 'warning');
          }, 3000);
        }
      }
    }

    function showAttendanceList() {
      // Check if members are loaded
      if (!members || members.length === 0) {
        showAlert('adminAlert', '‚ö† No members found. Please add members first.', 'error');
        return;
      }

      const date = document.getElementById('meetingDate').value;
      if (!date) {
        document.getElementById('meetingDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('meetingTime').value = new Date().toTimeString().slice(0,5);
        // Don't return, continue to show the list
      }

      // Get or create attendance record for the date
      if (!localStorage.getItem('attendance')) {
        localStorage.setItem('attendance', JSON.stringify({}));
      }
      const attendance = JSON.parse(localStorage.getItem('attendance'));
      
      if (!attendance[date]) {
        attendance[date] = {
          date: date,
          time: document.getElementById('meetingTime').value || '09:00',
          type: document.getElementById('meetingType').value || 'general',
          description: document.getElementById('meetingDesc').value || '',
          present: [],
          timeIn: {},
          remarks: {}
        };
      }

      // Show attendance table
      const tbody = document.getElementById('attendanceTableBody');
      tbody.innerHTML = '';

      // Sort members by name
      const sortedMembers = [...members].sort((a, b) => a.name.localeCompare(b.name));

      sortedMembers.forEach((member, index) => {
        const isPresent = attendance[date].present.includes(member.id);
        const timeIn = attendance[date].timeIn[member.id] || '';
        const remarks = attendance[date].remarks[member.id] || '';
        
        // Get the latest member signature
        const latestMember = members.find(m => m.id === member.id);
        const latestSignature = latestMember ? latestMember.signature : member.signature;
        
        const row = document.createElement('tr');
        row.setAttribute('data-member-id', member.id);
        row.setAttribute('data-member-name', member.name.toLowerCase());
        row.setAttribute('data-status', isPresent ? 'present' : 'absent');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${member.name}</td>
          <td>
            <button class="btn ${isPresent ? 'btn-success' : 'btn-danger'} btn-sm" 
                    onclick="toggleAttendance('${member.id}', '${date}', ${!isPresent})" 
                    style="width: 110px;">
              ${isPresent ? '‚úì Present' : '‚úó Absent'}
            </button>
          </td>
          <td>${isPresent ? 
            `<input type="time" value="${timeIn}" 
                    onchange="updateTimeIn('${member.id}', '${date}', this.value)" 
                    style="padding: 5px; border: 1px solid #ccc; border-radius: 5px;">` : 
            '-'}
          </td>
          <td>
            ${isPresent ? 
              `<input type="text" placeholder="Add remarks" value="${remarks}"
                      onchange="updateRemarks('${member.id}', '${date}', this.value)"
                      style="padding: 5px; border: 1px solid #ccc; border-radius: 5px; width: 200px;">` : 
              '-'}
          </td>
          <td style="text-align: center;">
            ${latestSignature ? 
              `<div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <img src="${latestSignature}" 
                     style="max-height: 60px; max-width: 150px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 5px; background: white;"
                     alt="Member signature"
                     title="Latest signature for ${member.name}">
                <span style="font-size: 11px; color: #48bb78;">‚úì Latest</span>
              </div>` : 
              isPresent ? '<span style="color: #e53e3e; font-size: 13px;">‚ö† No signature on file</span>' : 
              '<span style="color: #a0aec0;">-</span>'}
          </td>
        `;
        tbody.appendChild(row);
      });

      // Update counts
      const presentCount = attendance[date].present.length;
      const absentCount = members.length - presentCount;
      const attendanceRate = members.length > 0 ? Math.round((presentCount / members.length) * 100) : 0;
      
      document.getElementById('presentCount').textContent = `Present: ${presentCount}`;
      document.getElementById('absentCount').textContent = `Absent: ${absentCount}`;
      document.getElementById('attendanceRate').textContent = `Attendance Rate: ${attendanceRate}%`;

      // Update meeting details fields
      document.getElementById('meetingTime').value = attendance[date].time || '';
      document.getElementById('meetingType').value = attendance[date].type || 'general';
      document.getElementById('meetingDesc').value = attendance[date].description || '';

      // Save data
      localStorage.setItem('attendance', JSON.stringify(attendance));
    }

    function toggleAttendance(memberId, date, present) {
      const attendance = JSON.parse(localStorage.getItem('attendance'));
      
      if (!attendance[date]) {
        attendance[date] = {
          date: date,
          present: [],
          timeIn: {},
          remarks: {}
        };
      }

      if (present) {
        if (!attendance[date].present.includes(memberId)) {
          attendance[date].present.push(memberId);
          // Auto-set current time
          if (!attendance[date].timeIn) attendance[date].timeIn = {};
          attendance[date].timeIn[memberId] = new Date().toTimeString().slice(0,5);
        }
      } else {
        attendance[date].present = attendance[date].present.filter(id => id !== memberId);
        if (attendance[date].timeIn) delete attendance[date].timeIn[memberId];
        if (attendance[date].remarks) delete attendance[date].remarks[memberId];
      }

      localStorage.setItem('attendance', JSON.stringify(attendance));
      saveDataToStorage(); // Save comprehensive data backup
      showAttendanceList();
      
      // Show confirmation alert
      const member = members.find(m => m.id === memberId);
      if (member) {
        showAlert('adminAlert', 
          `‚úì ${member.name} marked as ${present ? 'present' : 'absent'}`, 
          present ? 'success' : 'warning'
        );
      }
    }

    function updateTimeIn(memberId, date, time) {
      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date].timeIn) attendance[date].timeIn = {};
      attendance[date].timeIn[memberId] = time;
      localStorage.setItem('attendance', JSON.stringify(attendance));
      showAlert('adminAlert', '‚úì Time updated', 'success');
    }

    function updateRemarks(memberId, date, remarks) {
      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date].remarks) attendance[date].remarks = {};
      attendance[date].remarks[memberId] = remarks;
      localStorage.setItem('attendance', JSON.stringify(attendance));
      showAlert('adminAlert', '‚úì Remarks updated', 'success');
    }

    function updateMeetingDetails() {
      const date = document.getElementById('meetingDate').value;
      if (!date) return;

      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date]) return;

      attendance[date].time = document.getElementById('meetingTime').value;
      attendance[date].type = document.getElementById('meetingType').value;
      attendance[date].description = document.getElementById('meetingDesc').value;

      localStorage.setItem('attendance', JSON.stringify(attendance));
      saveDataToStorage(); // Save comprehensive backup
      showAlert('adminAlert', '‚úì Meeting details updated', 'success');
    }

    function markAllPresent() {
      const date = document.getElementById('meetingDate').value;
      if (!date) {
        showAlert('adminAlert', '‚ö† Please select a meeting date first', 'error');
        return;
      }

      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date]) {
        attendance[date] = {
          date: date,
          present: [],
          timeIn: {},
          remarks: {}
        };
      }

      const currentTime = document.getElementById('meetingTime').value || 
                         new Date().toTimeString().slice(0,5);

      members.forEach(member => {
        if (!attendance[date].present.includes(member.id)) {
          attendance[date].present.push(member.id);
        }
        if (!attendance[date].timeIn) attendance[date].timeIn = {};
        attendance[date].timeIn[member.id] = currentTime;
      });

      localStorage.setItem('attendance', JSON.stringify(attendance));
      showAttendanceList();
      showAlert('adminAlert', '‚úì Marked all members as present', 'success');
    }

    function clearAttendance() {
      const date = document.getElementById('meetingDate').value;
      if (!date) {
        showAlert('adminAlert', '‚ö† Please select a meeting date first', 'error');
        return;
      }

      if (!confirm('Clear all attendance for this date?')) return;

      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date]) return;

      attendance[date].present = [];
      attendance[date].timeIn = {};
      attendance[date].remarks = {};

      localStorage.setItem('attendance', JSON.stringify(attendance));
      showAttendanceList();
      showAlert('adminAlert', '‚úì Attendance cleared', 'warning');
    }

    function filterAttendanceMembers() {
      const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const sortBy = document.getElementById('sortBy').value;

      const tbody = document.getElementById('attendanceTableBody');
      let rows = Array.from(tbody.querySelectorAll('tr'));

      // Filter by search term
      rows.forEach(row => {
        const name = row.getAttribute('data-member-name');
        const matchesSearch = name.includes(searchTerm);
        const status = row.getAttribute('data-status');
        
        let matchesFilter = true;
        if (statusFilter === 'present') matchesFilter = status === 'present';
        if (statusFilter === 'absent') matchesFilter = status === 'absent';

        row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
      });

      // Sort rows
      if (sortBy === 'name') {
        rows.sort((a, b) => {
          const nameA = a.getAttribute('data-member-name');
          const nameB = b.getAttribute('data-member-name');
          return nameA.localeCompare(nameB);
        });
      } else if (sortBy === 'status') {
        rows.sort((a, b) => {
          const statusA = a.getAttribute('data-status');
          const statusB = b.getAttribute('data-status');
          return statusB.localeCompare(statusA); // Present first
        });
      }

      // Re-append rows in new order
      rows.forEach((row, index) => {
        if (row.style.display !== 'none') {
          row.querySelector('td').textContent = index + 1;
        }
        tbody.appendChild(row);
      });
    }

    function downloadAttendanceRegister() {
      const date = document.getElementById('meetingDate').value;
      if (!date) {
        showAlert('adminAlert', '‚ö† Please select a meeting date', 'error');
        return;
      }

      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date]) {
        showAlert('adminAlert', '‚ö† No attendance data for selected date', 'error');
        return;
      }

      // Create a printable version
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Attendance Register - ${date}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { text-align: center; color: #333; }
              .date-info { text-align: center; color: #666; margin-bottom: 20px; }
              .meeting-info { background: #f7fafc; padding: 15px; border-radius: 8px; margin: 20px 0; }
              .stats { text-align: center; color: #666; margin: 20px 0; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { padding: 10px; text-align: left; border: 1px solid #ddd; }
              th { background: #f5f5f5; }
              .signature { max-height: 50px; }
              .no-signature { color: #e53e3e; }
              .status { font-weight: bold; }
              .present { color: #48bb78; }
              .absent { color: #f56565; }
              @media print {
                body { -webkit-print-color-adjust: exact; }
                button { display: none; }
              }
            </style>
          </head>
          <body>
            <h1>üèõÔ∏è Sbahle Burial Society</h1>
            <div class="date-info">
              <h2>Attendance Register</h2>
            </div>

            <div class="meeting-info">
              <p><strong>Date:</strong> ${new Date(date).toLocaleDateString()}</p>
              <p><strong>Time:</strong> ${attendance[date].time || 'Not specified'}</p>
              <p><strong>Meeting Type:</strong> ${attendance[date].type?.charAt(0).toUpperCase() + attendance[date].type?.slice(1) || 'General Meeting'}</p>
              ${attendance[date].description ? `<p><strong>Description:</strong> ${attendance[date].description}</p>` : ''}
            </div>
            
            <div class="stats">
              <p><strong>Attendance Summary:</strong></p>
              <p>Total Members: ${members.length} | 
                 Present: ${attendance[date].present.length} | 
                 Absent: ${members.length - attendance[date].present.length} |
                 Attendance Rate: ${Math.round((attendance[date].present.length / members.length) * 100)}%</p>
            </div>

            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Member Name</th>
                  <th>Status</th>
                  <th>Time In</th>
                  <th>Remarks</th>
                  <th>Signature</th>
                </tr>
              </thead>
              <tbody>
      `);

      // Add all members, sorted by name
      const sortedMembers = [...members].sort((a, b) => a.name.localeCompare(b.name));
      sortedMembers.forEach((member, index) => {
        const isPresent = attendance[date].present.includes(member.id);
        const timeIn = attendance[date].timeIn?.[member.id] || '';
        const remarks = attendance[date].remarks?.[member.id] || '';
        
        printWindow.document.write(`
          <tr>
            <td>${index + 1}</td>
            <td>${member.name}</td>
            <td><span class="status ${isPresent ? 'present' : 'absent'}">${isPresent ? '‚úì Present' : '‚úó Absent'}</span></td>
            <td>${isPresent ? timeIn : '-'}</td>
            <td>${isPresent ? remarks : '-'}</td>
            <td>${isPresent ? 
              (member.signature ? 
                `<img src="${member.signature}" class="signature">` : 
                '<span class="no-signature">No signature</span>'
              ) : '-'}
            </td>
          </tr>
        `);
      });

      printWindow.document.write(`
              </tbody>
            </table>
            
            <div style="margin-top: 50px;">
              <div style="float: left; width: 50%;">
                <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
              </div>
              <div style="float: right; width: 50%; text-align: right;">
                <p><strong>Secretary's Signature:</strong> _______________________</p>
                <p><strong>Chairperson's Signature:</strong> _______________________</p>
              </div>
            </div>
            <button onclick="window.print()" style="margin-top: 30px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Print Register</button>
          </body>
        </html>
      `);

      printWindow.document.close();
      showAlert('adminAlert', '‚úì Attendance register opened in new window', 'success');
    }

    // Remove demo login credentials
    window.addEventListener('load', () => {
      const adminEmailInput = document.getElementById('adminEmail');
      const adminPasswordInput = document.getElementById('adminPassword');
      const memberEmailInput = document.getElementById('memberEmail');
      const memberPasswordInput = document.getElementById('memberPassword');
      
      if (adminEmailInput) adminEmailInput.value = '';
      if (adminPasswordInput) adminPasswordInput.value = '';
      if (memberEmailInput) memberEmailInput.value = '';
      if (memberPasswordInput) memberPasswordInput.value = '';

      // Setup signature canvas when member dashboard loads
      if (document.getElementById('signatureCanvas')) {
        setupSignatureCanvas();
      }
    });

    // ===== MEETING MINUTES FUNCTIONS =====
    function addMinutesModal() {
      const html = `
        <h2>Add Meeting Minutes</h2>
        <div class="form-group">
          <label>Meeting Date</label>
          <input type="date" id="minutesDate" value="${new Date().toISOString().split('T')[0]}">
        </div>
        <div class="form-group">
          <label>Subject</label>
          <input type="text" id="minutesSubject" placeholder="e.g., Monthly General Meeting">
        </div>
        <div class="form-group">
          <label>Minutes</label>
          <textarea id="minutesContent" rows="10" placeholder="Enter meeting minutes here..."></textarea>
        </div>
        <div class="form-group">
          <label>üìé Attach Document (Optional - DOC, DOCX only)</label>
          <input type="file" id="minutesAttachment" accept=".doc,.docx" 
            style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
          <small style="color: #666; display: block; margin-top: 5px;">
            Upload meeting agenda, attendance register, or supporting documents
          </small>
        </div>
        <button class="btn btn-primary" onclick="saveMinutes()">Save Minutes</button>
      `;
      openModal(html);
    }

    async function saveMinutes() {
      const date = document.getElementById('minutesDate').value;
      const subject = document.getElementById('minutesSubject').value;
      const content = document.getElementById('minutesContent').value;
      const attachmentInput = document.getElementById('minutesAttachment');
      
      if (!date || !subject || !content) {
        alert('‚ö† Please fill all required fields');
        return;
      }
      
      const newMinutes = {
        id: 'MIN' + String(minutesIdCounter++).padStart(3, '0'),
        date,
        subject,
        content,
        postedBy: 'Admin',
        postedAt: new Date().toISOString()
      };
      
      // Handle file attachment if provided
      if (attachmentInput && attachmentInput.files.length > 0) {
        const file = attachmentInput.files[0];
        
        // Validate file type
        const allowedTypes = [
          'application/msword', // .doc
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document' // .docx
        ];
        
        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(doc|docx)$/i)) {
          alert('‚ö† Only DOC and DOCX files are allowed');
          return;
        }
        
        // Check file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('‚ö† File too large. Maximum size is 10MB');
          return;
        }
        
        // Convert to base64
        try {
          const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
          
          newMinutes.attachment = {
            name: file.name,
            size: file.size,
            type: file.type,
            data: base64,
            uploadedAt: new Date().toISOString()
          };
          
          console.log('‚úì Document attached:', file.name, `(${(file.size / 1024).toFixed(1)} KB)`);
        } catch (error) {
          console.error('‚ùå File upload error:', error);
          alert('‚ö† Error uploading file. Please try again.');
          return;
        }
      }
      
      meetingMinutes.push(newMinutes);
      await saveDataToStorage(true);
      closeModal();
      showAlert('adminAlert', '‚úì Meeting minutes saved and synced to all members!', 'success');
      displayMeetingMinutes();
      
      // Also update member minutes display if any member is viewing
      displayMemberMinutes();
      console.log('‚úì Meeting minutes published:', newMinutes.subject, '- Available to all members');
    }

    function displayMeetingMinutes() {
      const table = document.getElementById('minutesTable');
      if (!table) return;
      
      table.innerHTML = meetingMinutes.map(min => `
        <tr>
          <td>${new Date(min.date).toLocaleDateString()}</td>
          <td>
            ${min.subject}
            ${min.attachment ? `<br><small style="color: #666;">üìé ${min.attachment.name}</small>` : ''}
          </td>
          <td>${min.postedBy}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="viewMinutes('${min.id}')">View</button>
            ${min.attachment ? `<button class="btn btn-sm btn-success" onclick="downloadMinutesAttachment('${min.id}')">üì• Download</button>` : ''}
            <button class="btn btn-sm btn-danger" onclick="deleteMinutes('${min.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function viewMinutes(id) {
      const minutes = meetingMinutes.find(m => m.id === id);
      if (!minutes) return;
      
      const attachmentInfo = minutes.attachment ? `
        <div style="background: #f0f9ff; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #667eea;">
          <p style="margin: 5px 0;"><strong>üìé Attached Document:</strong></p>
          <p style="margin: 5px 0;">üìÑ ${minutes.attachment.name}</p>
          <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
            Size: ${(minutes.attachment.size / 1024).toFixed(1)} KB | 
            Uploaded: ${new Date(minutes.attachment.uploadedAt).toLocaleString()}
          </p>
          <button class="btn btn-sm btn-success" onclick="downloadMinutesAttachment('${minutes.id}')" style="margin-top: 5px;">
            üì• Download Document
          </button>
        </div>
      ` : '';
      
      const html = `
        <h2>${minutes.subject}</h2>
        <p><strong>Date:</strong> ${new Date(minutes.date).toLocaleDateString()}</p>
        <p><strong>Posted By:</strong> ${minutes.postedBy}</p>
        <hr>
        <div style="white-space: pre-wrap;">${minutes.content}</div>
        ${attachmentInfo}
      `;
      openModal(html);
    }

    function downloadMinutesAttachment(id) {
      const minutes = meetingMinutes.find(m => m.id === id);
      if (!minutes || !minutes.attachment) {
        alert('‚ö† No attachment found');
        return;
      }
      
      try {
        // Create download link
        const link = document.createElement('a');
        link.href = minutes.attachment.data;
        link.download = minutes.attachment.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úì Document downloaded:', minutes.attachment.name);
      } catch (error) {
        console.error('‚ùå Download error:', error);
        alert('‚ö† Error downloading file. Please try again.');
      }
    }

    async function deleteMinutes(id) {
      if (!confirm('Delete these meeting minutes?')) return;
      meetingMinutes = meetingMinutes.filter(m => m.id !== id);
      await saveDataToStorage(true);
      showAlert('adminAlert', '‚úì Minutes deleted', 'success');
      displayMeetingMinutes();
    }

    function displayMemberMinutes() {
      const container = document.getElementById('memberMinutesContent');
      if (!container) return;
      
      if (meetingMinutes.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 30px;">No meeting minutes available yet.</p>';
        return;
      }
      
      container.innerHTML = meetingMinutes.map(min => `
        <div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
          <h3 style="margin: 0 0 10px 0; color: #333;">${min.subject}</h3>
          <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
            <strong>Date:</strong> ${new Date(min.date).toLocaleDateString()} | 
            <strong>Posted:</strong> ${new Date(min.postedAt).toLocaleDateString()}
          </p>
          <div style="white-space: pre-wrap; color: #444; margin-bottom: 10px;">${min.content}</div>
          ${min.attachment ? `
            <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
              <p style="margin: 5px 0; color: #333;"><strong>üìé Attached Document:</strong></p>
              <p style="margin: 5px 0; color: #666;">üìÑ ${min.attachment.name} (${(min.attachment.size / 1024).toFixed(1)} KB)</p>
              <button class="btn btn-sm btn-success" onclick="downloadMinutesAttachment('${min.id}')" style="margin-top: 5px;">
                üì• Download Document
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // ===== MEMBER ROLES FUNCTIONS =====
    function editMemberRole(memberId) {
      const member = members.find(m => m.id === memberId);
      if (!member) return;
      
      const html = `
        <h2>Assign Role for ${member.name}</h2>
        <div class="form-group">
          <label>Select Role</label>
          <select id="memberRole">
            <option value="Member" ${(member.role || 'Member') === 'Member' ? 'selected' : ''}>Member</option>
            <option value="Admin" ${member.role === 'Admin' ? 'selected' : ''}>Admin</option>
            <option value="Chairperson" ${member.role === 'Chairperson' ? 'selected' : ''}>Chairperson</option>
            <option value="Secretary General" ${member.role === 'Secretary General' ? 'selected' : ''}>Secretary General</option>
            <option value="Treasurer" ${member.role === 'Treasurer' ? 'selected' : ''}>Treasurer</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="saveRole('${memberId}')">Save Role</button>
      `;
      openModal(html);
    }

    async function saveRole(memberId) {
      const role = document.getElementById('memberRole').value;
      const member = members.find(m => m.id === memberId);
      if (!member) return;
      
      member.role = role;
      await saveDataToStorage(true);
      closeModal();
      showAlert('adminAlert', `‚úì Role updated to ${role}`, 'success');
      displayMem();
    }

    // ===== PAYMENT PROOF FUNCTIONS =====
    function uploadPaymentProofModal() {
      console.log('Upload payment proof modal opened');
      
      if (!currentUser) {
        alert('‚ö† Please log in first');
        return;
      }
      
      const html = `
        <h2>Upload Payment Proof</h2>
        <div class="form-group">
          <label>Amount (R)</label>
          <input type="number" id="proofAmount" min="0" step="0.01" placeholder="e.g., 150.00">
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="proofDescription" placeholder="e.g., Monthly contribution - October">
        </div>
        <div class="form-group">
          <label>Upload File (PDF/JPEG) *</label>
          <input type="file" id="proofFile" accept=".pdf,.jpg,.jpeg,.png" required>
          <small style="color: #666; display: block; margin-top: 5px;">Supported formats: PDF, JPEG, PNG (Max 5MB)</small>
        </div>
        <button class="btn btn-primary" onclick="savePaymentProof()">Upload Proof</button>
      `;
      openModal(html);
    }

    async function savePaymentProof() {
      console.log('Saving payment proof...');
      
      const amount = document.getElementById('proofAmount').value;
      const description = document.getElementById('proofDescription').value;
      const fileInput = document.getElementById('proofFile');
      
      if (!amount || !description) {
        alert('‚ö† Please fill in amount and description');
        return;
      }
      
      if (parseFloat(amount) <= 0) {
        alert('‚ö† Amount must be greater than zero');
        return;
      }
      
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        alert('‚ö† Please select a file to upload');
        return;
      }
      
      const file = fileInput.files[0];
      const maxSize = 5 * 1024 * 1024; // 5MB
      
      if (file.size > maxSize) {
        alert('‚ö† File size exceeds 5MB. Please choose a smaller file.');
        return;
      }
      
      // Check file type
      const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
      if (!allowedTypes.includes(file.type)) {
        alert('‚ö† Invalid file type. Please upload PDF, JPEG, or PNG files only.');
        return;
      }
      
      try {
        // Show loading indicator
        const loadingMsg = document.createElement('div');
        loadingMsg.innerHTML = '<div style="text-align: center; padding: 10px; color: #667eea;">üì§ Uploading file...</div>';
        document.querySelector('.modal-content').appendChild(loadingMsg);
        
        // Convert file to base64
        const fileData = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        const newProof = {
          id: 'PROOF' + String(proofIdCounter++).padStart(3, '0'),
          memberId: currentUser.id,
          memberName: currentUser.name,
          amount: parseFloat(amount),
          description: description.trim(),
          fileName: file.name,
          fileType: file.type,
          fileData: fileData, // Store base64 encoded file
          fileSize: file.size,
          uploadDate: new Date().toISOString(),
          status: 'Pending'
        };
        
        paymentProofs.push(newProof);
        
        const cloudSaveSuccess = await saveDataToStorage(true);
        closeModal();
        
        if (cloudSaveSuccess === true) {
          showAlert('memberAlert', '‚úÖ Payment proof uploaded successfully and saved to cloud!', 'success');
        } else {
          showAlert('memberAlert', '‚ö† Payment proof uploaded locally but cloud sync failed. Please try again.', 'warning');
        }
        
        displayMemberPaymentProofs();
        console.log('Payment proof saved successfully');
      } catch (error) {
        console.error('Error saving payment proof:', error);
        alert('‚ö† Error uploading payment proof. Please try again.');
      }
    }

    function displayMemberPaymentProofs() {
      const table = document.getElementById('memberPaymentProofsTable');
      if (!table) return;
      
      const memberProofs = paymentProofs
        .filter(p => p.memberId === currentUser.id)
        .sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)); // Sort by date, newest first
      
      if (memberProofs.length === 0) {
        table.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #666;">No payment proofs uploaded yet.</td></tr>';
        return;
      }
      
      table.innerHTML = memberProofs.map(proof => {
        const uploadDate = new Date(proof.uploadDate);
        const formattedDate = uploadDate.toLocaleDateString('en-ZA', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        // Determine file icon based on file name
        let fileIcon = '';
        let fileDisplay = '';
        
        if (proof.fileName && proof.fileName !== 'No file attached' && proof.fileName !== 'No file' && proof.fileData) {
          const fileName = proof.fileName.toLowerCase();
          if (fileName.endsWith('.pdf')) {
            fileIcon = 'üìÑ';
          } else if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.png')) {
            fileIcon = 'üñºÔ∏è';
          } else {
            fileIcon = 'üìé';
          }
          fileDisplay = `
            <div style="text-align: center;">
              <span style="font-size: 24px;">${fileIcon}</span><br>
              <small style="color: #666; font-size: 11px; display: block; margin-bottom: 5px;">${proof.fileName}</small>
              <button class="btn btn-sm btn-primary" onclick="viewPaymentProofFile('${proof.id}')" style="font-size: 11px; padding: 3px 8px;">View</button>
              <button class="btn btn-sm" onclick="downloadPaymentProofFile('${proof.id}')" style="font-size: 11px; padding: 3px 8px; background: #48bb78; color: white;">Download</button>
            </div>
          `;
        } else {
          fileDisplay = '<span style="color: #999; font-size: 12px;">No file</span>';
        }
        
        // Status display - show "Successfully Loaded" for uploaded proofs
        let statusBadge = '';
        if (proof.status === 'Approved') {
          statusBadge = '<span class="badge badge-approved">Approved</span>';
        } else if (proof.status === 'Pending') {
          statusBadge = '<span class="badge" style="background: #48bb78; color: white;">Successfully Loaded</span>';
        } else {
          statusBadge = `<span class="badge badge-pending">${proof.status}</span>`;
        }
        
        // Only show delete button if status is not Approved
        let actionButton = '';
        if (proof.status !== 'Approved') {
          actionButton = `<button class="btn btn-danger btn-sm" onclick="deletePaymentProof('${proof.id}')">Delete</button>`;
        } else {
          actionButton = '<span style="color: #999; font-size: 12px;">-</span>';
        }
        
        return `
        <tr>
          <td>${formattedDate}</td>
          <td>R${proof.amount.toFixed(2)}</td>
          <td>${proof.description}</td>
          <td style="text-align: center;">${fileDisplay}</td>
          <td>${statusBadge}</td>
          <td style="text-align: center;">${actionButton}</td>
        </tr>
      `}).join('');
    }

    async function deletePaymentProof(proofId) {
      if (!confirm('‚ö†Ô∏è Are you sure you want to delete this payment proof? This action cannot be undone.')) {
        return;
      }
      
      const proofIndex = paymentProofs.findIndex(p => p.id === proofId);
      
      if (proofIndex === -1) {
        alert('‚ö† Payment proof not found');
        return;
      }
      
      const proof = paymentProofs[proofIndex];
      
      // Check if user owns this proof
      if (proof.memberId !== currentUser.id) {
        alert('‚ö† You can only delete your own payment proofs');
        return;
      }
      
      // Check if proof is already approved
      if (proof.status === 'Approved') {
        alert('‚ö† Cannot delete approved payment proofs. Please contact admin.');
        return;
      }
      
      try {
        paymentProofs.splice(proofIndex, 1);
        await saveDataToStorage(true);
        showAlert('memberAlert', '‚úì Payment proof deleted successfully', 'success');
        displayMemberPaymentProofs();
        console.log('Payment proof deleted:', proofId);
      } catch (error) {
        console.error('Error deleting payment proof:', error);
        alert('‚ö† Error deleting payment proof. Please try again.');
      }
    }

    function viewPaymentProofFile(proofId) {
      const proof = paymentProofs.find(p => p.id === proofId);
      if (!proof || !proof.fileData) {
        alert('‚ö† File not found');
        return;
      }
      
      // Open file in new window/tab
      const newWindow = window.open();
      if (proof.fileType === 'application/pdf') {
        newWindow.document.write(`
          <html>
            <head><title>${proof.fileName}</title></head>
            <body style="margin: 0;">
              <iframe src="${proof.fileData}" style="width: 100%; height: 100vh; border: none;"></iframe>
            </body>
          </html>
        `);
      } else {
        // For images
        newWindow.document.write(`
          <html>
            <head><title>${proof.fileName}</title></head>
            <body style="margin: 0; display: flex; justify-content: center; align-items: center; background: #333;">
              <img src="${proof.fileData}" style="max-width: 100%; max-height: 100vh;" />
            </body>
          </html>
        `);
      }
    }

    function downloadPaymentProofFile(proofId) {
      const proof = paymentProofs.find(p => p.id === proofId);
      if (!proof || !proof.fileData) {
        alert('‚ö† File not found');
        return;
      }
      
      // Create download link
      const link = document.createElement('a');
      link.href = proof.fileData;
      link.download = proof.fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function displayAdminPaymentProofs() {
      const table = document.getElementById('adminPaymentProofsTable');
      if (!table) return;
      
      if (paymentProofs.length === 0) {
        table.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #666;">No payment proofs uploaded yet.</td></tr>';
        return;
      }
      
      const sortedProofs = [...paymentProofs].sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
      
      table.innerHTML = sortedProofs.map(proof => {
        const uploadDate = new Date(proof.uploadDate);
        const formattedDate = uploadDate.toLocaleDateString('en-ZA', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        let fileDisplay = '';
        if (proof.fileName && proof.fileName !== 'No file attached' && proof.fileName !== 'No file' && proof.fileData) {
          const fileName = proof.fileName.toLowerCase();
          let fileIcon = '';
          if (fileName.endsWith('.pdf')) {
            fileIcon = 'üìÑ';
          } else if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.png')) {
            fileIcon = 'üñºÔ∏è';
          } else {
            fileIcon = 'üìé';
          }
          fileDisplay = `
            <div style="text-align: center;">
              <span style="font-size: 20px;">${fileIcon}</span><br>
              <small style="color: #666; font-size: 10px; display: block; margin: 3px 0;">${proof.fileName}</small>
              <button class="btn btn-sm btn-primary" onclick="viewPaymentProofFile('${proof.id}')" style="font-size: 10px; padding: 2px 6px;">View</button>
            </div>
          `;
        } else {
          fileDisplay = '<span style="color: #999; font-size: 11px;">No file</span>';
        }
        
        let statusBadge = '';
        if (proof.status === 'Approved') {
          statusBadge = '<span class="badge badge-approved">Approved</span>';
        } else if (proof.status === 'Pending') {
          statusBadge = '<span class="badge badge-pending">Pending</span>';
        } else {
          statusBadge = `<span class="badge">${proof.status}</span>`;
        }
        
        let actionButtons = '';
        if (proof.status === 'Pending') {
          actionButtons = `
            <button class="btn btn-success btn-sm" onclick="approvePaymentProof('${proof.id}')" style="font-size: 11px; padding: 3px 8px;">Approve</button>
            <button class="btn btn-danger btn-sm" onclick="rejectPaymentProof('${proof.id}')" style="font-size: 11px; padding: 3px 8px;">Reject</button>
          `;
        } else {
          actionButtons = '<span style="color: #999; font-size: 11px;">-</span>';
        }
        
        return `
        <tr>
          <td>${proof.memberName}</td>
          <td style="font-size: 11px;">${formattedDate}</td>
          <td>R${proof.amount.toFixed(2)}</td>
          <td>${proof.description}</td>
          <td>${fileDisplay}</td>
          <td>${statusBadge}</td>
          <td style="text-align: center;">${actionButtons}</td>
        </tr>
      `}).join('');
    }

    async function approvePaymentProof(proofId) {
      const proofIndex = paymentProofs.findIndex(p => p.id === proofId);
      if (proofIndex === -1) {
        alert('‚ö† Payment proof not found');
        return;
      }
      
      paymentProofs[proofIndex].status = 'Approved';
      const cloudSaveSuccess = await saveDataToStorage(true);
      
      if (cloudSaveSuccess === true) {
        showAlert('adminAlert', '‚úÖ Payment proof approved!', 'success');
      } else {
        showAlert('adminAlert', '‚ö† Approval saved locally but cloud sync failed', 'warning');
      }
      
      displayAdminPaymentProofs();
    }

    async function rejectPaymentProof(proofId) {
      const proofIndex = paymentProofs.findIndex(p => p.id === proofId);
      if (proofIndex === -1) {
        alert('‚ö† Payment proof not found');
        return;
      }
      
      const reason = prompt('Reason for rejection (optional):');
      paymentProofs[proofIndex].status = reason ? `Rejected: ${reason}` : 'Rejected';
      
      const cloudSaveSuccess = await saveDataToStorage(true);
      
      if (cloudSaveSuccess === true) {
        showAlert('adminAlert', '‚úÖ Payment proof rejected', 'success');
      } else {
        showAlert('adminAlert', '‚ö† Rejection saved locally but cloud sync failed', 'warning');
      }
      
      displayAdminPaymentProofs();
    }

    // Update updateMember function to show payment proofs
    const originalUpdateMember = updateMember;
    updateMember = function() {
      if (originalUpdateMember) originalUpdateMember();
      
      // Update member role display if exists
      const profRole = document.getElementById('profRole');
      if (profRole && currentUser) {
        profRole.value = currentUser.role || 'Member';
      }
      
      // Update payout collectors display
      displayPayoutCollectors();
    };

    // ===== PAYOUT COLLECTORS FUNCTIONS =====
    function managePayoutCollectorsModal() {
      if (!currentUser) {
        alert('‚ö† Please log in first');
        return;
      }
      
      // Get current collectors for this member
      const memberCollectors = payoutCollectors.find(pc => pc.memberId === currentUser.id);
      const collector1 = memberCollectors?.collectors?.[0] || { name: '', phone: '' };
      const collector2 = memberCollectors?.collectors?.[1] || { name: '', phone: '' };
      
      const html = `
        <h2>Manage Payout Collectors</h2>
        <p style="color: #666; margin-bottom: 20px;">Assign up to 2 people who can collect payouts on your behalf. These details will be used when processing payouts.</p>
        
        <h3 style="margin-top: 20px; font-size: 16px; border-top: 1px solid #ddd; padding-top: 15px;">Collector 1</h3>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="collector1Name" value="${collector1.name}" placeholder="e.g., John Doe">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" id="collector1Phone" value="${collector1.phone}" placeholder="e.g., 0721234567">
        </div>
        
        <h3 style="margin-top: 20px; font-size: 16px; border-top: 1px solid #ddd; padding-top: 15px;">Collector 2 (Optional)</h3>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="collector2Name" value="${collector2.name}" placeholder="e.g., Jane Smith">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" id="collector2Phone" value="${collector2.phone}" placeholder="e.g., 0731234567">
        </div>
        
        <div style="margin-top: 20px;">
          <button class="btn btn-primary" onclick="savePayoutCollectors()">Save Collectors</button>
          ${memberCollectors ? '<button class="btn btn-danger" onclick="clearPayoutCollectors()" style="margin-left: 10px;">Clear All</button>' : ''}
        </div>
      `;
      openModal(html);
    }

    async function savePayoutCollectors() {
      const collector1Name = document.getElementById('collector1Name').value.trim();
      const collector1Phone = document.getElementById('collector1Phone').value.trim();
      const collector2Name = document.getElementById('collector2Name').value.trim();
      const collector2Phone = document.getElementById('collector2Phone').value.trim();
      
      // Validate at least collector 1 has both name and phone OR both are empty (to clear)
      if ((collector1Name && !collector1Phone) || (!collector1Name && collector1Phone)) {
        alert('‚ö† Collector 1: Please provide both name and phone number, or leave both empty');
        return;
      }
      
      // Validate collector 2 if any field is filled
      if ((collector2Name && !collector2Phone) || (!collector2Name && collector2Phone)) {
        alert('‚ö† Collector 2: Please provide both name and phone number, or leave both empty');
        return;
      }
      
      // Build collectors array
      const collectors = [];
      if (collector1Name && collector1Phone) {
        collectors.push({ name: collector1Name, phone: collector1Phone });
      }
      if (collector2Name && collector2Phone) {
        collectors.push({ name: collector2Name, phone: collector2Phone });
      }
      
      try {
        // Find existing record for this member
        const existingIndex = payoutCollectors.findIndex(pc => pc.memberId === currentUser.id);
        
        if (collectors.length === 0) {
          // Remove collectors if none specified
          if (existingIndex !== -1) {
            payoutCollectors.splice(existingIndex, 1);
          }
        } else {
          // Update or add collectors
          if (existingIndex !== -1) {
            payoutCollectors[existingIndex].collectors = collectors;
          } else {
            payoutCollectors.push({
              memberId: currentUser.id,
              memberName: currentUser.name,
              collectors: collectors
            });
          }
        }
        
        await saveDataToStorage(true);
        closeModal();
        showAlert('memberAlert', '‚úì Payout collectors saved successfully!', 'success');
        displayPayoutCollectors();
        console.log('Payout collectors saved for member:', currentUser.id);
      } catch (error) {
        console.error('Error saving payout collectors:', error);
        alert('‚ö† Error saving payout collectors. Please try again.');
      }
    }

    async function clearPayoutCollectors() {
      if (!confirm('‚ö†Ô∏è Are you sure you want to remove all payout collectors?')) {
        return;
      }
      
      const existingIndex = payoutCollectors.findIndex(pc => pc.memberId === currentUser.id);
      if (existingIndex !== -1) {
        payoutCollectors.splice(existingIndex, 1);
        await saveDataToStorage(true);
        closeModal();
        showAlert('memberAlert', '‚úì Payout collectors cleared', 'success');
        displayPayoutCollectors();
      }
    }

    function displayPayoutCollectors() {
      const display = document.getElementById('payoutCollectorsDisplay');
      if (!display || !currentUser) return;
      
      const memberCollectors = payoutCollectors.find(pc => pc.memberId === currentUser.id);
      
      if (!memberCollectors || memberCollectors.collectors.length === 0) {
        display.innerHTML = `
          <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border: 1px dashed #cbd5e0; text-align: center;">
            <p style="color: #718096; margin: 0;">No payout collectors assigned yet.</p>
            <p style="color: #a0aec0; font-size: 13px; margin-top: 5px;">Click "Manage Payout Collectors" to add collectors.</p>
          </div>
        `;
        return;
      }
      
      const collectorsHtml = memberCollectors.collectors.map((collector, index) => `
        <div style="background: #f0fff4; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78; margin-bottom: 10px;">
          <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="font-size: 20px; margin-right: 10px;">üë§</span>
            <strong style="color: #2d3748;">Collector ${index + 1}</strong>
          </div>
          <p style="margin: 5px 0; color: #4a5568;"><strong>Name:</strong> ${collector.name}</p>
          <p style="margin: 5px 0; color: #4a5568;"><strong>Phone:</strong> ${collector.phone}</p>
        </div>
      `).join('');
      
      display.innerHTML = collectorsHtml;
    }

    // ==================== FINANCIAL DASHBOARD FUNCTIONS ====================
    
    // Chart instances (global to allow destruction/recreation)
    let incomeVsExpensesChart = null;
    let monthlyTrendsChart = null;
    let memberContributionChart = null;

    // Initialize Financial Dashboard
    function initializeFinancialDashboard() {
      console.log('üîÑ Initializing Financial Dashboard...');
      updateFinancialDashboard();
    }

    // Refresh Financial Dashboard
    function refreshFinancialDashboard() {
      updateFinancialDashboard();
      showAlert('adminAlert', '‚úì Financial dashboard refreshed!', 'success');
    }

    // Main function to update all financial data and charts
    function updateFinancialDashboard() {
      const period = document.getElementById('financialPeriod').value;
      const financialData = calculateFinancialData(period);
      
      // Update summary cards
      document.getElementById('totalIncome').textContent = `R ${financialData.totalIncome.toFixed(2)}`;
      document.getElementById('totalPayouts').textContent = `R ${financialData.totalPayouts.toFixed(2)}`;
      document.getElementById('totalPenalties').textContent = `R ${financialData.totalPenalties.toFixed(2)}`;
      document.getElementById('netBalance').textContent = `R ${financialData.netBalance.toFixed(2)}`;
      
      // Update charts
      renderIncomeVsExpensesChart(financialData);
      renderMonthlyTrendsChart(financialData);
      renderMemberContributionChart(financialData);
      
      // Update tables
      updateTopContributorsTable(financialData);
      updateRecentPayoutsTable(financialData);
    }

    // Calculate financial data based on period
    function calculateFinancialData(period) {
      const now = new Date();
      let startDate = new Date(0); // Beginning of time for "all"
      
      switch(period) {
        case 'thisYear':
          startDate = new Date(now.getFullYear(), 0, 1);
          break;
        case 'last6months':
          startDate = new Date(now.setMonth(now.getMonth() - 6));
          break;
        case 'last3months':
          startDate = new Date(now.setMonth(now.getMonth() - 3));
          break;
        case 'thisMonth':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
      }

      // Calculate income from approved payment proofs
      let totalIncome = 0;
      let monthlyIncome = {};
      
      members.forEach(member => {
        if (member.paymentProofs && Array.isArray(member.paymentProofs)) {
          member.paymentProofs.forEach(proof => {
            if (proof.status === 'approved') {
              const proofDate = new Date(proof.uploadDate);
              if (proofDate >= startDate) {
                const amount = parseFloat(proof.amount) || 0;
                totalIncome += amount;
                
                // Track monthly income
                const monthKey = `${proofDate.getFullYear()}-${String(proofDate.getMonth() + 1).padStart(2, '0')}`;
                monthlyIncome[monthKey] = (monthlyIncome[monthKey] || 0) + amount;
              }
            }
          });
        }
      });

      // Calculate payouts
      let totalPayouts = 0;
      let recentPayoutsData = [];
      
      payouts.forEach(payout => {
        const payoutDate = new Date(payout.date);
        if (payoutDate >= startDate) {
          const amount = parseFloat(payout.amount) || 0;
          totalPayouts += amount;
          recentPayoutsData.push({
            member: payout.member,
            amount: amount,
            date: payout.date
          });
        }
      });

      // Calculate penalties
      let totalPenalties = 0;
      members.forEach(member => {
        if (member.penalties && Array.isArray(member.penalties)) {
          member.penalties.forEach(penalty => {
            const penaltyDate = new Date(penalty.date);
            if (penaltyDate >= startDate && penalty.status === 'paid') {
              totalPenalties += parseFloat(penalty.amount) || 0;
            }
          });
        }
      });

      // Calculate member contributions
      let memberContributions = {};
      members.forEach(member => {
        let memberTotal = 0;
        if (member.paymentProofs && Array.isArray(member.paymentProofs)) {
          member.paymentProofs.forEach(proof => {
            if (proof.status === 'approved') {
              const proofDate = new Date(proof.uploadDate);
              if (proofDate >= startDate) {
                memberTotal += parseFloat(proof.amount) || 0;
              }
            }
          });
        }
        if (memberTotal > 0) {
          memberContributions[member.name] = memberTotal;
        }
      });

      return {
        totalIncome,
        totalPayouts,
        totalPenalties,
        netBalance: totalIncome - totalPayouts + totalPenalties,
        monthlyIncome,
        recentPayouts: recentPayoutsData.slice(-5).reverse(),
        memberContributions,
        period
      };
    }

    // Render Income vs Expenses Chart
    function renderIncomeVsExpensesChart(data) {
      const ctx = document.getElementById('incomeVsExpensesChart');
      if (!ctx) return;
      
      // Destroy previous chart
      if (incomeVsExpensesChart) {
        incomeVsExpensesChart.destroy();
      }
      
      incomeVsExpensesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Income (Contributions)', 'Payouts', 'Penalties (Income)'],
          datasets: [{
            data: [data.totalIncome, data.totalPayouts, data.totalPenalties],
            backgroundColor: ['#48bb78', '#f56565', '#ed8936'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: { size: 12 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': R ' + context.parsed.toFixed(2);
                }
              }
            }
          }
        }
      });
    }

    // Render Monthly Trends Chart
    function renderMonthlyTrendsChart(data) {
      const ctx = document.getElementById('monthlyTrendsChart');
      if (!ctx) return;
      
      // Destroy previous chart
      if (monthlyTrendsChart) {
        monthlyTrendsChart.destroy();
      }
      
      // Prepare monthly data (last 6 months)
      const months = [];
      const incomeData = [];
      const now = new Date();
      
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const monthLabel = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        
        months.push(monthLabel);
        incomeData.push(data.monthlyIncome[monthKey] || 0);
      }
      
      monthlyTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Monthly Income',
            data: incomeData,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#667eea'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Income: R ' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R ' + value;
                }
              }
            }
          }
        }
      });
    }

    // Render Member Contribution Chart
    function renderMemberContributionChart(data) {
      const ctx = document.getElementById('memberContributionChart');
      if (!ctx) return;
      
      // Destroy previous chart
      if (memberContributionChart) {
        memberContributionChart.destroy();
      }
      
      // Sort members by contribution
      const sortedMembers = Object.entries(data.memberContributions)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Top 10
      
      const memberNames = sortedMembers.map(m => m[0]);
      const contributions = sortedMembers.map(m => m[1]);
      
      memberContributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: memberNames,
          datasets: [{
            label: 'Total Contribution',
            data: contributions,
            backgroundColor: '#667eea',
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Contributed: R ' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R ' + value;
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    // Update Top Contributors Table
    function updateTopContributorsTable(data) {
      const tbody = document.getElementById('topContributorsTable');
      if (!tbody) return;
      
      const sorted = Object.entries(data.memberContributions)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">No contributions yet</td></tr>';
        return;
      }
      
      tbody.innerHTML = sorted.map(([name, amount]) => {
        const member = members.find(m => m.name === name);
        const status = member ? getMemberContributionStatus(member) : 'unknown';
        const badge = getStatusBadgeHTML(status);
        
        return `
          <tr>
            <td>${name}</td>
            <td><strong>R ${amount.toFixed(2)}</strong></td>
            <td>${badge}</td>
          </tr>
        `;
      }).join('');
    }

    // Update Recent Payouts Table
    function updateRecentPayoutsTable(data) {
      const tbody = document.getElementById('recentPayoutsTable');
      if (!tbody) return;
      
      if (data.recentPayouts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">No recent payouts</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.recentPayouts.map(payout => `
        <tr>
          <td>${payout.member}</td>
          <td><strong style="color: #f56565;">R ${payout.amount.toFixed(2)}</strong></td>
          <td>${new Date(payout.date).toLocaleDateString()}</td>
        </tr>
      `).join('');
    }

    // Export Financial Report as PDF (using browser print)
    function exportFinancialReport() {
      const period = document.getElementById('financialPeriod').value;
      const periodText = document.getElementById('financialPeriod').selectedOptions[0].text;
      const data = calculateFinancialData(period);
      
      // Create printable report
      const reportWindow = window.open('', '', 'width=800,height=600');
      reportWindow.document.write(`
        <html>
        <head>
          <title>Financial Report - ${periodText}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 30px; }
            h1 { color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
            h2 { color: #333; margin-top: 25px; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
            .summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
            .summary-card { background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; }
            .summary-card h3 { font-size: 14px; color: #718096; margin-bottom: 5px; }
            .summary-card .value { font-size: 24px; font-weight: bold; color: #2d3748; }
            table { width: 100%; border-collapse: collapse; margin: 15px 0; }
            th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
            th { background: #667eea; color: white; }
            .footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #e2e8f0; color: #718096; font-size: 12px; }
            @media print { .no-print { display: none; } }
          </style>
        </head>
        <body>
          <h1>Sbahle Burial Society - Financial Report</h1>
          <p><strong>Period:</strong> ${periodText}</p>
          <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
          
          <div class="summary">
            <div class="summary-card">
              <h3>Total Income</h3>
              <div class="value" style="color: #48bb78;">R ${data.totalIncome.toFixed(2)}</div>
            </div>
            <div class="summary-card">
              <h3>Total Payouts</h3>
              <div class="value" style="color: #f56565;">R ${data.totalPayouts.toFixed(2)}</div>
            </div>
            <div class="summary-card">
              <h3>Total Penalties</h3>
              <div class="value" style="color: #ed8936;">R ${data.totalPenalties.toFixed(2)}</div>
            </div>
            <div class="summary-card">
              <h3>Net Balance</h3>
              <div class="value" style="color: #667eea;">R ${data.netBalance.toFixed(2)}</div>
            </div>
          </div>
          
          <h2>Top Contributors</h2>
          <table>
            <thead><tr><th>Member</th><th>Total Contributed</th></tr></thead>
            <tbody>
              ${Object.entries(data.memberContributions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([name, amount]) => `<tr><td>${name}</td><td>R ${amount.toFixed(2)}</td></tr>`)
                .join('')}
            </tbody>
          </table>
          
          <h2>Recent Payouts</h2>
          <table>
            <thead><tr><th>Member</th><th>Amount</th><th>Date</th></tr></thead>
            <tbody>
              ${data.recentPayouts.map(p => `
                <tr><td>${p.member}</td><td>R ${p.amount.toFixed(2)}</td><td>${new Date(p.date).toLocaleDateString()}</td></tr>
              `).join('')}
            </tbody>
          </table>
          
          <div class="footer">
            <p><strong>Sbahle Burial Society</strong> | Generated by Financial Dashboard System v2.7.0</p>
            <p>This report is confidential and for internal use only.</p>
          </div>
          
          <div class="no-print" style="margin-top: 20px;">
            <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Print Report</button>
            <button onclick="window.close()" style="padding: 10px 20px; background: #e2e8f0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px;">Close</button>
          </div>
        </body>
        </html>
      `);
      reportWindow.document.close();
    }

    // ==================== MULTI-ADMIN SUPPORT FUNCTIONS ====================
    
    // Admin users, audit log, and current admin session are initialized at the top of script
    // (See global variables section around line 2873)
    
    // Role permissions configuration
    const ROLE_PERMISSIONS = {
      fulladmin: {
        label: 'Full Admin',
        color: '#22543d',
        bgColor: '#c6f6d5',
        permissions: ['*'] // All permissions
      },
      secretary: {
        label: 'Secretary',
        color: '#2c5282',
        bgColor: '#bee3f8',
        permissions: [
          'view_members', 'add_members', 'edit_members',
          'view_attendance', 'manage_attendance',
          'view_minutes', 'add_minutes', 'edit_minutes',
          'view_financials' // Read-only
        ]
      },
      treasurer: {
        label: 'Treasurer',
        color: '#744210',
        bgColor: '#feebc8',
        permissions: [
          'view_financials', 'manage_payments', 'approve_payments',
          'view_payouts', 'create_payouts',
          'view_penalties', 'manage_penalties',
          'view_members' // Read-only
        ]
      }
    };
    
    // Check if current admin has permission
    function hasPermission(permission) {
      if (!currentAdmin) return false;
      const role = ROLE_PERMISSIONS[currentAdmin.role];
      if (!role) return false;
      return role.permissions.includes('*') || role.permissions.includes(permission);
    }
    
    // Log admin action to audit trail
    function logAdminAction(action, details) {
      const logEntry = {
        id: 'log-' + Date.now(),
        timestamp: new Date().toISOString(),
        admin: currentAdmin ? currentAdmin.username : 'system',
        role: currentAdmin ? currentAdmin.role : 'system',
        action,
        details
      };
      
      auditLog.unshift(logEntry); // Add to beginning
      
      // Keep only last 500 entries
      if (auditLog.length > 500) {
        auditLog = auditLog.slice(0, 500);
      }
      
      localStorage.setItem('auditLog', JSON.stringify(auditLog));
      
      // Update preview if visible
      updateAuditLogPreview();
    }
    
    // Update admin users display
    function updateAdminUsersDisplay() {
      const tbody = document.getElementById('adminUsersTable');
      if (!tbody) return;
      
      if (adminUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No admin users</td></tr>';
        return;
      }
      
      tbody.innerHTML = adminUsers.map(admin => {
        const role = ROLE_PERMISSIONS[admin.role];
        const isCurrentAdmin = currentAdmin && currentAdmin.id === admin.id;
        
        return `
          <tr style="${isCurrentAdmin ? 'background: #f0f9ff;' : ''}">
            <td>
              <strong>${admin.username}</strong>
              ${isCurrentAdmin ? '<span style="color: #0ea5e9; font-size: 11px; margin-left: 5px;">(You)</span>' : ''}
            </td>
            <td>
              <span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background: ${role.bgColor}; color: ${role.color}; font-weight: 600;">
                ${role.label.toUpperCase()}
              </span>
            </td>
            <td>${new Date(admin.createdDate).toLocaleDateString()}</td>
            <td>${admin.lastLogin ? new Date(admin.lastLogin).toLocaleString() : '<span style="color: #999;">Never</span>'}</td>
            <td>
              ${hasPermission('*') && admin.id !== 'admin-1' ? `
                <button class="btn btn-warning btn-sm" onclick="editAdminModal('${admin.id}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteAdmin('${admin.id}')">Delete</button>
              ` : '<span style="color: #999; font-size: 11px;">Protected</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // Show Add Admin Modal
    function showAddAdminModal() {
      if (!hasPermission('*')) {
        alert('‚ö† Only Full Admins can add new administrators');
        return;
      }
      
      openModal(`
        <h2>Add New Administrator</h2>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="newAdminUsername" placeholder="Enter username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="newAdminPassword" placeholder="Create password">
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="newAdminPasswordConfirm" placeholder="Confirm password">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="newAdminRole">
            <option value="fulladmin">Full Admin - Complete access</option>
            <option value="secretary">Secretary - Members & meetings</option>
            <option value="treasurer">Treasurer - Financial management</option>
          </select>
        </div>
        <div style="background: #fef3c7; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px;">
          <strong>‚ö†Ô∏è Important:</strong> The new admin will be able to login immediately with these credentials.
        </div>
        <button class="btn btn-success" onclick="saveNewAdmin()">Create Admin</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      `);
    }
    
    // Save New Admin
    function saveNewAdmin() {
      const username = document.getElementById('newAdminUsername').value.trim();
      const password = document.getElementById('newAdminPassword').value;
      const passwordConfirm = document.getElementById('newAdminPasswordConfirm').value;
      const role = document.getElementById('newAdminRole').value;
      
      // Validation
      if (!username || !password || !role) {
        alert('‚ö† Please fill all fields');
        return;
      }
      
      if (username.length < 3) {
        alert('‚ö† Username must be at least 3 characters');
        return;
      }
      
      if (password.length < 6) {
        alert('‚ö† Password must be at least 6 characters');
        return;
      }
      
      if (password !== passwordConfirm) {
        alert('‚ö† Passwords do not match');
        return;
      }
      
      // Check for duplicate username
      if (adminUsers.find(a => a.username.toLowerCase() === username.toLowerCase())) {
        alert('‚ö† Username already exists');
        return;
      }
      
      // Create new admin
      const newAdmin = {
        id: 'admin-' + Date.now(),
        username,
        password, // In production, hash this
        role,
        createdDate: new Date().toISOString(),
        lastLogin: null
      };
      
      adminUsers.push(newAdmin);
      localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
      
      // Log action
      logAdminAction('ADD_ADMIN', `Created new ${ROLE_PERMISSIONS[role].label} user: ${username}`);
      
      // Update display
      updateAdminUsersDisplay();
      closeModal();
      showAlert('adminAlert', `‚úì Admin user "${username}" created successfully!`, 'success');
      
      // Sync to cloud
      if (cloudStorageAvailable) {
        syncToCloud();
      }
    }
    
    // Edit Admin Modal
    function editAdminModal(adminId) {
      const admin = adminUsers.find(a => a.id === adminId);
      if (!admin) return;
      
      openModal(`
        <h2>Edit Administrator</h2>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="editAdminUsername" value="${admin.username}">
        </div>
        <div class="form-group">
          <label>New Password (leave blank to keep current)</label>
          <input type="password" id="editAdminPassword" placeholder="Enter new password or leave blank">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="editAdminRole">
            <option value="fulladmin" ${admin.role === 'fulladmin' ? 'selected' : ''}>Full Admin - Complete access</option>
            <option value="secretary" ${admin.role === 'secretary' ? 'selected' : ''}>Secretary - Members & meetings</option>
            <option value="treasurer" ${admin.role === 'treasurer' ? 'selected' : ''}>Treasurer - Financial management</option>
          </select>
        </div>
        <button class="btn btn-success" onclick="saveEditedAdmin('${adminId}')">Save Changes</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      `);
    }
    
    // Save Edited Admin
    function saveEditedAdmin(adminId) {
      const admin = adminUsers.find(a => a.id === adminId);
      if (!admin) return;
      
      const username = document.getElementById('editAdminUsername').value.trim();
      const password = document.getElementById('editAdminPassword').value;
      const role = document.getElementById('editAdminRole').value;
      
      if (!username) {
        alert('‚ö† Username cannot be empty');
        return;
      }
      
      // Check for duplicate username (excluding current admin)
      if (adminUsers.find(a => a.id !== adminId && a.username.toLowerCase() === username.toLowerCase())) {
        alert('‚ö† Username already exists');
        return;
      }
      
      // Update admin
      admin.username = username;
      admin.role = role;
      if (password) {
        admin.password = password; // In production, hash this
      }
      
      localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
      
      // Log action
      logAdminAction('EDIT_ADMIN', `Updated ${ROLE_PERMISSIONS[role].label} user: ${username}`);
      
      // Update display
      updateAdminUsersDisplay();
      closeModal();
      showAlert('adminAlert', `‚úì Admin user "${username}" updated successfully!`, 'success');
      
      // Sync to cloud
      if (cloudStorageAvailable) {
        syncToCloud();
      }
    }
    
    // Delete Admin
    function deleteAdmin(adminId) {
      const admin = adminUsers.find(a => a.id === adminId);
      if (!admin) return;
      
      if (adminId === 'admin-1') {
        alert('‚ö† Cannot delete the main admin account');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete admin user "${admin.username}"?\n\nThis action cannot be undone.`)) {
        return;
      }
      
      // Remove admin
      adminUsers = adminUsers.filter(a => a.id !== adminId);
      localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
      
      // Log action
      logAdminAction('DELETE_ADMIN', `Deleted admin user: ${admin.username}`);
      
      // Update display
      updateAdminUsersDisplay();
      showAlert('adminAlert', `‚úì Admin user "${admin.username}" deleted`, 'success');
      
      // Sync to cloud
      if (cloudStorageAvailable) {
        syncToCloud();
      }
    }
    
    // Update current admin display
    function updateCurrentAdminDisplay() {
      const display = document.getElementById('currentAdminDisplay');
      const roleDisplay = document.getElementById('currentAdminRole');
      
      if (!display || !roleDisplay || !currentAdmin) return;
      
      const role = ROLE_PERMISSIONS[currentAdmin.role];
      display.textContent = `${currentAdmin.username} (${role.label})`;
      roleDisplay.textContent = role.label.toUpperCase();
      roleDisplay.style.background = role.bgColor;
      roleDisplay.style.color = role.color;
    }
    
    // Update audit log preview (last 5 actions)
    function updateAuditLogPreview() {
      const preview = document.getElementById('auditLogPreview');
      if (!preview) return;
      
      if (auditLog.length === 0) {
        preview.innerHTML = '<div style="color: #999; text-align: center;">No recent actions</div>';
        return;
      }
      
      const recentLogs = auditLog.slice(0, 5);
      preview.innerHTML = recentLogs.map(log => {
        const time = new Date(log.timestamp).toLocaleString();
        const role = ROLE_PERMISSIONS[log.role];
        
        return `
          <div style="padding: 8px; border-bottom: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
              <strong style="font-size: 11px;">${log.admin}</strong>
              <span style="font-size: 10px; color: #666;">${time}</span>
            </div>
            <div style="font-size: 11px; color: #4a5568;">${log.action}: ${log.details}</div>
          </div>
        `;
      }).join('');
    }
    
    // Show full audit log in modal
    function showFullAuditLog() {
      if (!hasPermission('*')) {
        alert('‚ö† Only Full Admins can view the complete audit log');
        return;
      }
      
      const logsHtml = auditLog.length === 0 ? 
        '<p style="text-align: center; color: #999;">No audit log entries</p>' :
        `
          <div style="max-height: 400px; overflow-y: auto;">
            ${auditLog.map(log => {
              const time = new Date(log.timestamp).toLocaleString();
              return `
                <div style="padding: 10px; border-bottom: 1px solid #e2e8f0; font-size: 12px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <strong>${log.admin}</strong>
                    <span style="color: #666;">${time}</span>
                  </div>
                  <div><strong>Action:</strong> ${log.action}</div>
                  <div><strong>Details:</strong> ${log.details}</div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      
      openModal(`
        <h2>Complete Audit Log</h2>
        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">All administrator actions are logged for security and accountability.</p>
        ${logsHtml}
        <button class="btn btn-primary" onclick="exportAuditLog()">üì• Export Log</button>
        <button class="btn" onclick="closeModal()">Close</button>
      `);
    }
    
    // Export audit log as JSON
    function exportAuditLog() {
      const dataStr = JSON.stringify(auditLog, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `audit-log-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      
      logAdminAction('EXPORT_AUDIT_LOG', 'Exported complete audit log');
      showAlert('adminAlert', '‚úì Audit log exported successfully!', 'success');
    }
    
    // Enhanced loginAdmin function (replaces existing)
    function loginAdminEnhanced() {
      const username = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      
      // Find admin user
      const admin = adminUsers.find(a => a.username === username && a.password === password);
      
      if (!admin) {
        alert('‚ùå Invalid username or password');
        return;
      }
      
      // Update last login
      admin.lastLogin = new Date().toISOString();
      localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
      
      // Set current admin
      currentAdmin = admin;
      currentUser = { type: 'admin', role: admin.role };
      
      // Log login
      logAdminAction('LOGIN', `Logged in as ${ROLE_PERMISSIONS[admin.role].label}`);
      
      // Show admin page
      show('adminPage');
      updateAdmin();
      updateCurrentAdminDisplay();
      updateAdminUsersDisplay();
      updateAuditLogPreview();
      
      // Update sync status
      if (cloudStorageAvailable) {
        updateSyncStatus('default');
      } else {
        updateSyncStatus('offline');
      }
    }
    
    // Initialize multi-admin system on page load
    setTimeout(() => {
      // Replace loginAdmin with enhanced version
      window.loginAdmin = loginAdminEnhanced;
      
      console.log('‚úì Multi-Admin system initialized');
    }, 100);

  </script>
</body>
</html>