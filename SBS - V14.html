<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome to Sbahle Burial Society</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="sbs-init.js"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <!-- Firebase Analytics -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyBih1niP4hscomYJuQ7CW2bOgfmtmYWAUo",
      authDomain: "sbahle-burial-society.firebaseapp.com",
      databaseURL: "https://sbahle-burial-society-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sbahle-burial-society",
      storageBucket: "sbahle-burial-society.firebasestorage.app",
      messagingSenderId: "431934828714",
      appId: "1:431934828714:web:0cc3869eb4bc8c22ec20d3",
      measurementId: "G-XXVHXPXM58"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
  </script>
  <style>
        /* Moved from inline styles */
        #cloudSyncStatus {
          position: fixed;
          top: 10px;
          right: 10px;
          z-index: 9999;
          background: #e2e8f0;
          padding: 8px 16px;
          border-radius: 6px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          font-size: 14px;
          display: none;
          align-items: center;
          gap: 8px;
        }
        #loadingSpinner {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 10000;
          display: none;
          background: rgba(255,255,255,0.8);
          padding: 40px 60px;
          border-radius: 12px;
          box-shadow: 0 2px 16px rgba(0,0,0,0.15);
          font-size: 22px;
        }
        #loadingSpinner span:first-child {
          font-size: 32px;
        }
        .center-text { text-align: center; }
        .justify-center { justify-content: center; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      min-height: 100vh;
      padding: 0;
      background: linear-gradient(120deg, #2563eb 0%, #1e3a8a 100%);
      background-attachment: fixed;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Focus login card in center with shadow */
    #loginPage.card {
      background: rgba(255,255,255,0.97);
      border-radius: 18px;
      box-shadow: 0 8px 40px 0 rgba(30,58,138,0.18), 0 1.5px 8px 0 rgba(30,58,138,0.10);
      max-width: 400px;
      margin: 48px auto;
      padding: 40px 32px 32px 32px;
      position: relative;
      z-index: 2;
    }
    /* Blue accent for login tabs */
    .tabs .tab {
      background: #e0e7ff;
      color: #1e3a8a;
      border: none;
      border-radius: 6px 6px 0 0;
      margin: 0 2px;
      padding: 10px 24px;
      font-weight: 600;
      transition: background 0.2s, color 0.2s;
    }
    .tabs .tab.active, .tabs .tab:focus {
      background: #2563eb;
      color: #fff;
    }
    /* Subtle background overlay for depth */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30,58,138,0.08);
      pointer-events: none;
      z-index: 0;
    }
    /* Optional: Add a subtle overlay for depth */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.07);
      pointer-events: none;
      z-index: 0;
    }
    /* Optional: Add a subtle overlay for depth */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.07);
      pointer-events: none;
      z-index: 0;
    }
    .container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card { background: #fff; border-radius: 10px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .hidden { display: none !important; }
    
    /* Tab visibility fixes - override hidden class when tabs should be visible */
    #membersTab:not(.hidden), #beneficiariesTab:not(.hidden), #payoutsTab:not(.hidden), #penaltiesTab:not(.hidden) {
      display: block !important;
      min-height: 500px !important;
      padding: 20px !important;
      background: white !important;
      border: 1px solid #ddd !important;
      margin-top: 10px !important;
      overflow: visible !important;
    }
    
    /* Force table layout */
    #membersTab table, #beneficiariesTab table, #payoutsTab table, #penaltiesTab table {
      display: table !important;
      width: 100% !important;
      table-layout: fixed !important;
      border-collapse: collapse !important;
    }
    
    #membersTab tbody, #beneficiariesTab tbody, #payoutsTab tbody, #penaltiesTab tbody {
      display: table-row-group !important;
    }
    
    #membersTab tr, #beneficiariesTab tr, #payoutsTab tr, #penaltiesTab tr {
      display: table-row !important;
      height: 45px !important;
      border-bottom: 1px solid #ddd !important;
    }
    
    #membersTab td, #beneficiariesTab td, #payoutsTab td, #penaltiesTab td,
    #membersTab th, #beneficiariesTab th, #payoutsTab th, #penaltiesTab th {
      display: table-cell !important;
      padding: 12px 8px !important;
      vertical-align: middle !important;
      border: 1px solid #ddd !important;
      background: white !important;
    }
    h1 { color: #333; margin-bottom: 20px; }
    h2 { color: #333; margin: 15px 0; font-size: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
<<<<<<< HEAD
    .tab { padding: 8px 15px; background: #e2e8f0; border: none; cursor: pointer; font-weight: 600; border-radius: 5px; }
    .tab.active { background: #667eea; color: white; }
=======
    .tab { padding: 8px 15px; background: #e2e8f0; border: none; cursor: pointer; font-weight: 600; border-radius: 5px; color: #222; }
    .tab.active { background: #2B3674; color: #fff; }
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 3px; color: #333; font-weight: bold; font-size: 14px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
    input:disabled { background: #f0f0f0; }
    .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; margin-right: 5px; margin-bottom: 5px; font-size: 13px; }
<<<<<<< HEAD
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #48bb78; color: white; }
    .btn-danger { background: #f56565; color: white; }
    .btn-warning { background: #ed8936; color: white; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .alert { padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px; }
    .alert-success { background: #c6f6d5; color: #22543d; border-left: 4px solid #48bb78; }
    .alert-error { background: #fed7d7; color: #742a2a; border-left: 4px solid #f56565; }
    .alert-warning { background: #feebc8; color: #7c2d12; border-left: 4px solid #ed8936; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    thead { background: #667eea; color: white; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    tbody tr:hover { background: #f7f7f7; }
    .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block; }
    .badge-active { background: #c6f6d5; color: #22543d; }
    .badge-suspended { background: #fed7d7; color: #742a2a; }
    .badge-pending { background: #feebc8; color: #744210; }
    .badge-approved { background: #bee3f8; color: #2c5282; }
    .stat { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
=======
    .btn-primary { background: #2B3674; color: #fff; }
    .btn-success { background: #217A3B; color: #fff; }
    .btn-danger { background: #B91C1C; color: #fff; }
    .btn-warning { background: #B45309; color: #fff; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .alert { padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px; }
    .alert-success { background: #E6F4EA; color: #14532D; border-left: 4px solid #217A3B; }
    .alert-error { background: #FDE2E1; color: #7F1D1D; border-left: 4px solid #B91C1C; }
    .alert-warning { background: #FFF7E6; color: #78350F; border-left: 4px solid #B45309; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    thead { background: #2B3674; color: #fff; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    tbody tr:hover { background: #f7f7f7; }
    .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block; }
    .badge-active { background: #E6F4EA; color: #14532D; }
    .badge-suspended { background: #FDE2E1; color: #7F1D1D; }
    .badge-pending { background: #FFF7E6; color: #78350F; }
    .badge-approved { background: #E0E7FF; color: #3730A3; }
    .stat { background: linear-gradient(135deg, #2B3674 0%, #764ba2 100%); color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
    .stat h3 { font-size: 12px; margin-bottom: 8px; }
    .stat .value { font-size: 24px; font-weight: bold; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 10px; padding: 25px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .close { float: right; font-size: 20px; cursor: pointer; color: #999; }
    .close:hover { color: #000; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .ben-card { background: #f7f7f7; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 3px solid #667eea; display: block !important; visibility: visible !important; }
    canvas { border: 1px solid #ccc; border-radius: 5px; display: block; margin-bottom: 10px; cursor: crosshair; }
    .file-input { margin-bottom: 10px; }
<<<<<<< HEAD
    .file-label { display: block; padding: 10px; background: #e2e8f0; border: 2px dashed #667eea; border-radius: 5px; text-align: center; cursor: pointer; font-size: 13px; }
    .file-label:hover { background: #cbd5e0; }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } .header { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
=======
    .file-label { display: block; padding: 10px; background: #e2e8f0; border: 2px dashed #2B3674; border-radius: 5px; text-align: center; cursor: pointer; font-size: 13px; color: #222; }
    .file-label:hover { background: #cbd5e0; }
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr !important; }
      .header { flex-direction: column !important; align-items: flex-start !important; gap: 10px; }
      .container { padding: 5px !important; }
      .card { padding: 10px !important; border-radius: 6px !important; }
      h1, h2 { font-size: 18px !important; }
      .tabs { flex-direction: column !important; gap: 2px !important; }
      .tab, .btn { width: 100% !important; font-size: 15px !important; margin-right: 0 !important; margin-bottom: 8px !important; }
      table, th, td { font-size: 12px !important; }
      .form-group { margin-bottom: 8px !important; }
      .modal-content { max-width: 98vw !important; padding: 10px !important; }
      .file-label { font-size: 12px !important; }
      .stat { font-size: 13px !important; }
      .badge { font-size: 10px !important; }
      #cloudSyncStatus, #loadingSpinner { left: 50% !important; right: auto !important; transform: translate(-50%, 0) !important; min-width: 180px !important; font-size: 13px !important; }
    }
  </style>
</head>
<body>
  <div id="cloudSyncStatus" style="position:fixed;top:10px;right:10px;z-index:9999;background:#e2e8f0;padding:8px 16px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:14px;display:none;align-items:center;gap:8px;">
    <span id="cloudSyncIcon">‚òÅÔ∏è</span> <span id="cloudSyncText">Syncing...</span>
  </div>
  <div id="loadingSpinner" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10000;display:none;background:rgba(255,255,255,0.8);padding:40px 60px;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.15);font-size:22px;">
    <span style="font-size:32px;">‚è≥</span> <span id="spinnerText">Loading...</span>
  </div>
  <div class="container">
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="card">
      <h1 style="text-align: center;">üèõÔ∏è Sbahle Burial Society</h1>
      <div class="tabs" style="justify-content: center;">
<<<<<<< HEAD
        <button class="tab active" onclick="showLoginForm('admin')">Admin</button>
        <button class="tab" onclick="showLoginForm('member')">Member</button>
        <button class="tab" onclick="showLoginForm('register')">Register</button>
=======
        <button class="tab active" onclick="showLoginForm('admin')" aria-label="Show Admin Login Form" tabindex="0">Admin</button>
        <button class="tab" onclick="showLoginForm('member')" aria-label="Show Member Login Form" tabindex="0">Member</button>
        <button class="tab" onclick="showLoginForm('register')" aria-label="Show Register Form" tabindex="0">Register</button>
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
      </div>
      <div id="alertMsg"></div>

      <div id="adminForm">
<<<<<<< HEAD
        <h2>Admin Login</h2>
        <div class="form-group"><label>Email</label><input type="text" id="adminEmail" value="admin"></div>
        <div class="form-group"><label>Password</label><input type="password" id="adminPassword" value="admin123"></div>
        <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
      </div>

      <div id="memberForm" class="hidden">
        <h2>Member Login</h2>
        <div class="form-group"><label>Email</label><input type="text" id="memberEmail" value="member@test.com"></div>
        <button class="btn btn-primary" onclick="loginMember()">Login</button>
      </div>

      <div id="registerForm" class="hidden">
        <h2>Register Member</h2>
        <div class="form-group"><label>Name</label><input type="text" id="regName"></div>
        <div class="form-group"><label>Email</label><input type="text" id="regEmail"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="regPhone"></div>
        <div class="form-group"><label>ID Number</label><input type="text" id="regId"></div>
        <button class="btn btn-success" onclick="registerMember()">Register</button>
=======
        <h2 id="adminLoginHeading">Admin Login</h2>
        <div class="form-group"><label for="adminEmail">Email</label><input type="text" id="adminEmail" value="admin" aria-labelledby="adminLoginHeading adminEmailLabel"></div>
        <div class="form-group"><label for="adminPassword">Password</label><input type="password" id="adminPassword" value="admin123" aria-labelledby="adminLoginHeading adminPasswordLabel"></div>
        <button class="btn btn-primary" onclick="loginAdmin()" aria-label="Login as Admin" tabindex="0">Login</button>
      </div>

      <div id="memberForm" class="hidden">
        <h2 id="memberLoginHeading">Member Login</h2>
        <div class="form-group"><label for="memberEmail">Email</label><input type="text" id="memberEmail" value="member@test.com" aria-labelledby="memberLoginHeading memberEmailLabel"></div>
        <button class="btn btn-primary" onclick="loginMember()" aria-label="Login as Member" tabindex="0">Login</button>
      </div>

      <div id="registerForm" class="hidden">
        <h2 id="registerHeading">Register Member</h2>
        <div class="form-group"><label for="regName">Name</label><input type="text" id="regName" aria-labelledby="registerHeading regNameLabel"></div>
        <div class="form-group"><label for="regEmail">Email</label><input type="text" id="regEmail" aria-labelledby="registerHeading regEmailLabel"></div>
        <div class="form-group"><label for="regPhone">Phone</label><input type="text" id="regPhone" aria-labelledby="registerHeading regPhoneLabel"></div>
        <div class="form-group"><label for="regId">ID Number</label><input type="text" id="regId" aria-labelledby="registerHeading regIdLabel"></div>
        <button class="btn btn-success" onclick="registerMember()" aria-label="Register Member" tabindex="0">Register</button>
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
      </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminPage" class="card hidden">
      <div class="header">
<<<<<<< HEAD
        <h1>Admin Dashboard</h1>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="adminTab('overview', event)">Overview</button>
        <button class="tab" onclick="adminTab('members', event)">Members</button>
        <button class="tab" onclick="adminTab('beneficiaries', event)">Beneficiaries</button>
        <button class="tab" onclick="adminTab('attendance', event)">Attendance</button>
        <button class="tab" onclick="adminTab('payouts', event)">Payouts</button>
        <button class="tab" onclick="adminTab('penalties', event)">Penalties</button>
        <button class="tab" onclick="adminTab('data', event)">Data Management</button>
=======
        <h1 id="adminDashboardHeading">Admin Dashboard</h1>
        <button class="btn btn-danger" onclick="logout()" aria-label="Logout from Admin Dashboard" tabindex="0">Logout</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="adminTab('overview', event)" aria-label="Show Overview Tab" tabindex="0">Overview</button>
        <button class="tab" onclick="adminTab('members', event)" aria-label="Show Members Tab" tabindex="0">Members</button>
        <button class="tab" onclick="adminTab('beneficiaries', event)" aria-label="Show Beneficiaries Tab" tabindex="0">Beneficiaries</button>
        <button class="tab" onclick="adminTab('attendance', event)" aria-label="Show Attendance Tab" tabindex="0">Attendance</button>
        <button class="tab" onclick="adminTab('payouts', event)" aria-label="Show Payouts Tab" tabindex="0">Payouts</button>
        <button class="tab" onclick="adminTab('penalties', event)" aria-label="Show Penalties Tab" tabindex="0">Penalties</button>
        <button class="tab" onclick="adminTab('data', event)" aria-label="Show Data Management Tab" tabindex="0">Data Management</button>
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
      </div>
      <div id="adminAlert"></div>

      <div id="overviewTab">
        <div class="stat"><h3>Total Members</h3><div class="value" id="totalMem">5</div></div>
        <div class="stat"><h3>Active Members</h3><div class="value" id="activeMem">4</div></div>
        <div class="stat"><h3>Suspended</h3><div class="value" id="suspMem">1</div></div>
<<<<<<< HEAD
        <button class="btn btn-warning" onclick="checkMissed()">Check Missed Payments</button>
        <button class="btn btn-warning" onclick="applyPen()">Apply R30 Penalties</button>
=======
        <button class="btn btn-warning" onclick="checkMissed()" aria-label="Check Missed Payments" tabindex="0">Check Missed Payments</button>
        <button class="btn btn-warning" onclick="applyPen()" aria-label="Apply R30 Penalties" tabindex="0">Apply R30 Penalties</button>
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
      </div>

      <!-- Attendance Tab -->
      <div id="attendanceTab" class="hidden">
        <h2>Meeting Attendance</h2>
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p><strong>üìã Manage meeting attendance and track member participation</strong></p>
            <p style="margin-top: 10px; color: #4a5568;">Track attendance, manage meetings, and generate reports</p>
          </div>

          <!-- Meeting Details Section -->
          <div class="grid-2" style="gap: 15px;">
            <div class="form-group" style="margin: 0;">
              <label>Meeting Date</label>
              <input type="date" id="meetingDate" onchange="showAttendanceList()">
            </div>
            <div class="form-group" style="margin: 0;">
              <label>Meeting Time</label>
              <input type="time" id="meetingTime" onchange="updateMeetingDetails()">
            </div>
          </div>
        
          <div class="grid-2" style="gap: 15px; margin-top: 15px;">
            <div class="form-group" style="margin: 0;">
              <label>Meeting Type</label>
              <select id="meetingType" onchange="updateMeetingDetails()">
                <option value="general">General Meeting</option>
                <option value="committee">Committee Meeting</option>
                <option value="special">Special Meeting</option>
                <option value="emergency">Emergency Meeting</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0;">
              <label>Meeting Description</label>
              <textarea id="meetingDesc" rows="2" onchange="updateMeetingDetails()" 
                        placeholder="Brief description of meeting agenda/purpose"></textarea>
            </div>
          </div>

          <!-- Search and Filter Section -->
          <div style="background: #edf2f7; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <div class="grid-2" style="gap: 15px;">
              <div class="form-group" style="margin: 0;">
                <input type="text" id="memberSearch" 
                       placeholder="Search members..." 
                       onkeyup="filterMembers()"
                       style="margin: 0;">
              </div>
              <div style="display: flex; gap: 10px;">
                <select id="statusFilter" onchange="filterMembers()" style="width: auto;">
                  <option value="all">All Status</option>
                  <option value="present">Present Only</option>
                  <option value="absent">Absent Only</option>
                  <option value="nosig">No Signature</option>
                </select>
                <select id="sortBy" onchange="filterMembers()" style="width: auto;">
                  <option value="name">Sort by Name</option>
                  <option value="time">Sort by Time In</option>
                  <option value="status">Sort by Status</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Attendance Stats -->
          <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span id="presentCount" class="badge badge-active" style="margin-right: 10px;">Present: 0</span>
                <span id="absentCount" class="badge badge-suspended" style="margin-right: 10px;">Absent: 0</span>
                <span id="attendanceRate" class="badge badge-approved">Attendance Rate: 0%</span>
              </div>
              <div>
                <button class="btn btn-primary btn-sm" onclick="markAllPresent()">Mark All Present</button>
                <button class="btn btn-warning btn-sm" onclick="clearAttendance()">Clear All</button>
                <button class="btn btn-success" onclick="downloadAttendanceRegister()" id="downloadRegisterBtn">
                  <span style="margin-right: 5px;">üì•</span> Download Register
                </button>
              </div>
            </div>
        </div>

        <!-- Attendance List -->
        <div class="table-container" style="margin-top: 20px;">
          <table class="table" style="width: 100%;">
            <thead>
              <tr>
                <th>Member Name</th>
                <th>Status</th>
                  <th>Time</th>
                  <th>Signature</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="attendanceList">
            </tbody>
          </table>
      </div>

      <div id="membersTab" class="hidden" style="min-height: 400px;">
        <h2>Members</h2>
        <button class="btn btn-success" onclick="addMemberModal()">+ Add Member</button>
        <div style="overflow-x: auto; margin-top: 20px; min-height: 300px;">
          <table style="width: 100%; border-collapse: collapse; display: table; background: white;">
            <thead style="display: table-header-group; background: #667eea; color: white;">
              <tr style="display: table-row;">
                <!-- ID column removed -->
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Name</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Email</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Status</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Missed</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Actions</th>
              </tr>
            </thead>
            <tbody id="memTable" style="display: table-row-group; background: white;"></tbody>
          </table>
        </div>
      </div>

      <div id="beneficiariesTab" class="hidden" style="min-height: 400px;">
        <h2>Beneficiaries</h2>
        <div class="form-group">
          <label>Select Member</label>
          <select id="memSelectBen" onchange="loadBeneficiaries()">
            <option value="">-- Select --</option>
          </select>
        </div>
        <button class="btn btn-success" id="addBenBtn" style="display:none;" onclick="addBenModal()">+ Add Beneficiary</button>
        <div style="overflow-x: auto; margin-top: 20px;">
          <table id="benTable" style="width: 100%; border-collapse: collapse; display: table;">
            <thead style="display: table-header-group; background: #667eea; color: white;">
              <tr style="display: table-row;">
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Name</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Relationship</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">ID</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">%</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Actions</th>
              </tr>
            </thead>
            <tbody id="benTableBody" style="display: table-row-group;"></tbody>
          </table>
        </div>
      </div>

      <div id="payoutsTab" class="hidden" style="min-height: 400px;">
        <h2>Payouts</h2>
        <div style="overflow-x: auto; margin-top: 20px;">
          <table style="width: 100%; border-collapse: collapse; display: table;">
            <thead style="display: table-header-group; background: #667eea; color: white;">
              <tr style="display: table-row;">
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Member</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Amount</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Reason</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Status</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Actions</th>
              </tr>
            </thead>
            <tbody id="payTable" style="display: table-row-group;"></tbody>
          </table>
        </div>
        <div style="margin-top: 40px;">
          <h2>Member Contributions (Admin Review)</h2>
          <button class="btn btn-primary" onclick="exportContributionsCSV()">Export Contributions CSV</button>
          <div style="overflow-x: auto; margin-top: 20px;">
            <table style="width: 100%; border-collapse: collapse; display: table;">
              <thead style="display: table-header-group; background: #667eea; color: white;">
                <tr style="display: table-row;">
                  <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Date</th>
                  <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Amount</th>
                  <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Method</th>
                  <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Reference</th>
                  <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Status</th>
                  <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Actions</th>
                </tr>
              </thead>
              <tbody id="adminContributionsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="penaltiesTab" class="hidden" style="min-height: 400px;">
        <h2>Penalties</h2>
        <div style="overflow-x: auto; margin-top: 20px;">
          <table style="width: 100%; border-collapse: collapse; display: table;">
            <thead style="display: table-header-group; background: #667eea; color: white;">
              <tr style="display: table-row;">
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Member</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Amount</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Date</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Status</th>
                <th style="display: table-cell; padding: 12px; border: 1px solid #ddd;">Actions</th>
              </tr>
            </thead>
            <tbody id="penTable" style="display: table-row-group;"></tbody>
          </table>
        </div>
      </div>

        <div id="dataTab" class="hidden">
          
          <!-- Location and Device Info -->
          <div style="display: flex; gap: 10px; font-size: 12px; color: #666;">
            <div id="locationInfo">üìç Location: <span>Not detected</span></div>
            <div id="deviceInfo">üì± Device: <span>Unknown</span></div>
          </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 20px 0; display: none;">
          <h3 style="margin-bottom: 15px;">üìä Attendance Analytics</h3>
          <div class="grid-2" style="gap: 15px;">
            <div style="background: white; padding: 15px; border-radius: 8px;">
              <h4>Monthly Attendance Trend</h4>
              <canvas id="attendanceTrendChart" height="200"></canvas>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px;">
              <h4>Member Participation</h4>
              <canvas id="memberParticipationChart" height="200"></canvas>
            </div>
          </div>
          <button class="btn btn-primary" onclick="toggleAnalytics()" style="margin-top: 10px;">
            Hide Analytics
          </button>
        </div>
        
        <!-- Analytics Toggle -->
        <button class="btn btn-primary" onclick="toggleAnalytics()" id="showAnalyticsBtn">
          Show Analytics
        </button>

        <!-- Attendance Table -->
        <div id="attendanceSheet">
          <table id="attendanceTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Member Name</th>
                <th>Status</th>
                <th>Time In</th>
                <th>Remarks</th>
                <th>Signature</th>
              </tr>
            </thead>
            <tbody id="attendanceTableBody">
              <!-- Members will be listed here -->
            </tbody>
          </table>
        </div>

        <!-- Attendance History -->
        <div style="margin-top: 30px;">
          <h3>Recent Meetings</h3>
          <table id="meetingHistoryTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Attendance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="meetingHistoryBody">
              <!-- Meeting history will be listed here -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="dataTab" class="hidden">
        <h2>Data Management</h2>
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
          <p style="margin-bottom: 10px;"><strong>üîí Secure Storage:</strong> All data is encrypted and stored locally in your browser.</p>
          <p style="margin-bottom: 0;"><strong>üíæ Auto-Save:</strong> Data is automatically saved after every change.</p>
        </div>
        
        <div style="display: grid; gap: 15px;">
          <div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
            <h3 style="margin-bottom: 10px; font-size: 16px;">üì• Export Data</h3>
            <p style="color: #666; font-size: 13px; margin-bottom: 10px;">Download a backup of all system data as a JSON file.</p>
            <button class="btn btn-primary" onclick="exportData()">Export Data Backup</button>
          </div>
          
          <div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
            <h3 style="margin-bottom: 10px; font-size: 16px;">üì§ Import Data</h3>
            <p style="color: #666; font-size: 13px; margin-bottom: 10px;">Restore data from a previously exported backup file.</p>
            <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;">
            <button class="btn btn-success" onclick="document.getElementById('importFile').files[0] && importData(document.getElementById('importFile').files[0])">Import Data</button>
          </div>
          
          <div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
            <h3 style="margin-bottom: 10px; font-size: 16px;">üíæ Manual Save</h3>
            <p style="color: #666; font-size: 13px; margin-bottom: 10px;">Force save all current data (normally happens automatically).</p>
            <button class="btn btn-primary" onclick="saveDataToStorage() && showAlert('adminAlert', '‚úì Data saved successfully!', 'success')">Save Now</button>
          </div>
          
          <div style="background: #fff4e6; padding: 15px; border: 1px solid #ed8936; border-radius: 8px;">
            <h3 style="margin-bottom: 10px; font-size: 16px;">‚ö† Clear All Data</h3>
            <p style="color: #666; font-size: 13px; margin-bottom: 10px;">Permanently delete all data and reset the system.</p>
            <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
          </div>
          
          <div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
            <h3 style="margin-bottom: 10px; font-size: 16px;">üìä Storage Info</h3>
            <p style="color: #666; font-size: 13px;"><strong>Members:</strong> <span id="storageMembers">0</span></p>
            <p style="color: #666; font-size: 13px;"><strong>Beneficiaries:</strong> <span id="storageBeneficiaries">0</span></p>
            <p style="color: #666; font-size: 13px;"><strong>Payouts:</strong> <span id="storagePayouts">0</span></p>
            <p style="color: #666; font-size: 13px; margin-bottom: 0;"><strong>Penalties:</strong> <span id="storagePenalties">0</span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- MEMBER DASHBOARD -->
    <div id="memberPage" class="card hidden">
      <div class="header">
        <h1 id="memberDashboardHeading">Member Dashboard</h1>
        <button class="btn btn-danger" onclick="logout()" aria-label="Logout from Member Dashboard" tabindex="0">Logout</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="memberTab('profile', event)" aria-label="Show Profile Tab" tabindex="0">Profile</button>
        <button class="tab" onclick="memberTab('signature', event)" aria-label="Show Signature Tab" tabindex="0">Signature</button>
        <button class="tab" onclick="memberTab('contributions', event)" aria-label="Show Contributions Tab" tabindex="0">Contributions</button>
        <button class="tab" onclick="memberTab('beneficiaries', event)" aria-label="Show Beneficiaries Tab" tabindex="0">Beneficiaries</button>
        <button class="tab" onclick="memberTab('documents', event)" aria-label="Show Documents Tab" tabindex="0">Documents</button>
      </div>
      <div id="memberAlert"></div>

      <div id="memberProfileTab">
        <h2>Profile</h2>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="profName" disabled>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="text" id="profEmail" disabled>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="text" id="profPhone" disabled>
        </div>
        <button class="btn btn-warning" onclick="editProf()">Edit Profile</button>
        <button class="btn btn-success hidden" id="saveProf" onclick="saveProf()">Save</button>
      </div>

      <div id="memberSignatureTab" class="hidden">
        <h2>Digital Signature</h2>
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
          <p><strong>‚úçÔ∏è Draw your signature below:</strong></p>
        </div>
        <canvas id="signatureCanvas" width="600" height="200"></canvas>
        <div style="margin-bottom: 15px;">
          <button class="btn btn-warning" onclick="clearSignature()">Clear</button>
          <button class="btn btn-success" onclick="saveSignature()">Save Signature</button>
        </div>
        <div id="currentSignature" style="display:none;">
          <h3>Your Current Signature:</h3>
          <img id="savedSignature" style="max-width: 100%; border: 1px solid #ddd; border-radius: 5px;">
        </div>
      </div>
      <div class="header">
        <h1>Member Dashboard</h1>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="memberTab('profile', event)">Profile</button>
        <button class="tab" onclick="memberTab('contributions', event)">Contributions</button>
        <button class="tab" onclick="memberTab('beneficiaries', event)">Beneficiaries</button>
        <button class="tab" onclick="memberTab('documents', event)">Documents</button>
        <button class="tab" onclick="memberTab('signature', event)">Signature</button>
        <button class="tab" onclick="memberTab('payouts', event)">Payouts</button>
      </div>
      <div id="memberAlert"></div>

      <div id="profileTab">
        <h2>My Profile</h2>
        <p><strong>Member ID:</strong> <span id="memId">MEM001</span></p>
        <p><strong>Status:</strong> <span id="memStatus" class="badge badge-active">Active</span></p>
        <div class="form-group"><label>Name</label><input type="text" id="profName" disabled></div>
        <div class="form-group"><label>Email</label><input type="text" id="profEmail" disabled></div>
        <div class="form-group"><label>Phone</label><input type="text" id="profPhone" disabled></div>
        <button class="btn btn-primary" onclick="editProf()">Edit</button>
        <button class="btn btn-success hidden" id="saveProf" onclick="saveProf()">Save</button>
      </div>

      <div id="contributionsTab" class="hidden">
        <h2>Contributions - R 170/Month Required</h2>
        <form id="memberContributionForm" onsubmit="submitMemberContribution(event)" style="margin-bottom: 24px; background: #f8fafc; padding: 18px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(30,58,138,0.06);">
          <div class="form-group"><label for="contribDate">Date</label><input type="date" id="contribDate" required></div>
          <div class="form-group"><label for="contribAmt">Amount (R)</label><input type="number" id="contribAmt" min="170" value="170" required></div>
          <div class="form-group"><label for="contribMeth">Method</label><select id="contribMeth" required><option>Bank Transfer</option><option>EFT</option><option>Cash</option></select></div>
          <div class="form-group"><label for="contribRef">Reference</label><input type="text" id="contribRef" required></div>
          <button class="btn btn-success" type="submit">Submit Contribution</button>
        </form>
        <table>
          <thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Status</th></tr></thead>
          <tbody id="memberContributionsTableBody">
            <tr><td colspan="4" style="text-align:center; color:#999;">No contributions yet</td></tr>
          </tbody>
        </table>
      </div>
    // --- Member Contribution Form Logic ---
    function submitMemberContribution(e) {
      e.preventDefault();
      const date = document.getElementById('contribDate').value;
      const amt = parseFloat(document.getElementById('contribAmt').value);
      const meth = document.getElementById('contribMeth').value;
      const ref = document.getElementById('contribRef').value;
      if (!date || !amt || amt < 170 || !meth || !ref) {
        alert('Please fill in all fields and ensure amount is at least R 170.');
        return;
      }
      // Save to localStorage (per member)
      let contribs = JSON.parse(localStorage.getItem('memberContributions') || '[]');
      contribs.push({ date, amt, meth, ref, status: 'Pending' });
      localStorage.setItem('memberContributions', JSON.stringify(contribs));
      renderMemberContributions();
      document.getElementById('memberContributionForm').reset();
      showAlert('memberAlert', '‚úì Contribution submitted! Pending verification', 'success');
    }

    // Admin: Render all member contributions for review
    function renderAdminContributions() {
      let contribs = JSON.parse(localStorage.getItem('memberContributions') || '[]');
      const tbody = document.getElementById('adminContributionsTableBody');
      if (!tbody) return;
      if (contribs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">No contributions yet</td></tr>';
        return;
      }
      tbody.innerHTML = contribs.map((c, i) => `
        <tr>
          <td>${c.date}</td>
          <td>R ${c.amt}</td>
          <td>${c.meth}</td>
          <td>${c.ref}</td>
          <td><span class="badge badge-${c.status === 'Pending' ? 'pending' : 'approved'}">${c.status}</span></td>
          <td>
            ${c.status === 'Pending' ? `<button class='btn btn-success btn-sm' onclick='approveContribution(${i})'>Approve</button> <button class='btn btn-danger btn-sm' onclick='rejectContribution(${i})'>Reject</button>` : '-'}
          </td>
        </tr>
      `).join('');
    }

    function approveContribution(idx) {
      let contribs = JSON.parse(localStorage.getItem('memberContributions') || '[]');
      contribs[idx].status = 'Approved';
      localStorage.setItem('memberContributions', JSON.stringify(contribs));
      renderAdminContributions();
      showAlert('adminAlert', '‚úì Contribution approved!', 'success');
    }

    function rejectContribution(idx) {
      let contribs = JSON.parse(localStorage.getItem('memberContributions') || '[]');
      contribs[idx].status = 'Rejected';
      localStorage.setItem('memberContributions', JSON.stringify(contribs));
      renderAdminContributions();
      showAlert('adminAlert', '‚úì Contribution rejected!', 'success');
    }

    function exportContributionsCSV() {
      let contribs = JSON.parse(localStorage.getItem('memberContributions') || '[]');
      if (contribs.length === 0) { showAlert('adminAlert', 'No contributions to export', 'warning'); return; }
      let csv = 'Date,Amount,Method,Reference,Status\n';
      csv += contribs.map(c => `${c.date},${c.amt},${c.meth},${c.ref},${c.status}`).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `contributions_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showAlert('adminAlert', '‚úì Contributions exported as CSV!', 'success');
    }

    function renderMemberContributions() {
      let contribs = JSON.parse(localStorage.getItem('memberContributions') || '[]');
      const tbody = document.getElementById('memberContributionsTableBody');
      if (!tbody) return;
      if (contribs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No contributions yet</td></tr>';
        return;
      }
      tbody.innerHTML = contribs.map(c => `<tr><td>${c.date}</td><td>R ${c.amt}</td><td>${c.meth}</td><td><span class="badge badge-pending">${c.status}</span></td></tr>`).join('');
    }

    // Render contributions on tab show
    document.addEventListener('DOMContentLoaded', function() {
      renderMemberContributions();
    });

      <div id="memberBeneficiariesTab" class="hidden">
        <h2>My Beneficiaries</h2>
        <p style="color: #666; margin-bottom: 15px;">You can add up to 5 beneficiaries. Total allocation must equal 100%.</p>
        <button class="btn btn-success" id="addBenMemBtn" onclick="addBenMemModal()">+ Add Beneficiary</button>
        <button class="btn btn-primary hidden" id="saveBenMemBtn" onclick="saveBenMem()">Save & Lock</button>
        
        <table style="margin-top: 20px;">
          <thead>
            <tr>
              <th>Name</th>
              <th>Relationship</th>
              <!-- ID Number column removed -->
              <th>Allocation %</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="memBenTableBody">
            <tr><td colspan="4" style="text-align: center; color: #999;">No beneficiaries added yet</td></tr>
          </tbody>
        </table>
      </div>

      <div id="documentsTab" class="hidden">
        <h2 id="uploadDocsHeading">Upload Documents</h2>
        <div class="file-input">
          <label for="payFile">Proof of Payment (PDF/JPEG)</label>
          <input type="file" id="payFile" accept=".pdf,.jpg,.jpeg" aria-labelledby="uploadDocsHeading payFileLabel">
        </div>
        <div class="file-input">
          <label for="deathFile">Death Certificate (PDF/JPEG)</label>
          <input type="file" id="deathFile" accept=".pdf,.jpg,.jpeg" aria-labelledby="uploadDocsHeading deathFileLabel">
        </div>
        <div class="file-input">
          <label for="suppFile">Supporting Documents (PDF/JPEG)</label>
          <input type="file" id="suppFile" accept=".pdf,.jpg,.jpeg" aria-labelledby="uploadDocsHeading suppFileLabel">
        </div>
        <button class="btn btn-success" onclick="saveDocs()" aria-label="Save Uploaded Documents" tabindex="0">Save Documents</button>
      </div>

      <div id="signatureTab" class="hidden">
        <h2>Digital Signature</h2>
        <p style="font-size: 13px; color: #666;">Draw your signature below:</p>
        <canvas id="sigCanvas" width="500" height="150"></canvas>
        <button class="btn btn-secondary" onclick="clearSig()">Clear</button>
        <button class="btn btn-success" onclick="saveSig()">Save Signature</button>
      </div>

      <div id="memberPayoutsTab" class="hidden">
        <h2>Request Payout</h2>
        <button class="btn btn-success" onclick="reqPayoutModal()">+ Request Payout</button>
        <table>
          <thead><tr><th>Date</th><th>Amount</th><th>Reason</th><th>Status</th></tr></thead>
          <tbody id="memPayTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal">
<<<<<<< HEAD
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
=======
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <span class="close" onclick="closeModal()" aria-label="Close Modal" tabindex="0">&times;</span>
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
      <div id="modContent"></div>
    </div>
  </div>

  <script>
<<<<<<< HEAD
=======
            // --- Keyboard Navigation for Tabs and Modal ---
            document.addEventListener('DOMContentLoaded', function() {
              // Tab navigation (left/right arrows)
              function handleTabKeydown(e) {
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                  const tabs = Array.from(e.currentTarget.parentNode.querySelectorAll('.tab'));
                  const idx = tabs.indexOf(e.currentTarget);
                  let nextIdx = e.key === 'ArrowRight' ? idx + 1 : idx - 1;
                  if (nextIdx < 0) nextIdx = tabs.length - 1;
                  if (nextIdx >= tabs.length) nextIdx = 0;
                  tabs[nextIdx].focus();
                  e.preventDefault();
                }
                if (e.key === 'Enter' || e.key === ' ') {
                  e.currentTarget.click();
                }
              }
              document.querySelectorAll('.tab').forEach(tab => {
                tab.setAttribute('tabindex', '0');
                tab.addEventListener('keydown', handleTabKeydown);
              });

              // Modal close with Escape key
              document.addEventListener('keydown', function(e) {
                const modal = document.getElementById('modal');
                if (modal && modal.classList.contains('show') && e.key === 'Escape') {
                  closeModal();
                }
              });

              // Modal close button keyboard
              const closeBtn = document.querySelector('.modal .close');
              if (closeBtn) {
                closeBtn.setAttribute('tabindex', '0');
                closeBtn.addEventListener('keydown', function(e) {
                  if (e.key === 'Enter' || e.key === ' ') {
                    closeModal();
                  }
                });
              }

              // Main action buttons: Enter/Space triggers click
              document.querySelectorAll('button, [role="button"]').forEach(btn => {
                btn.setAttribute('tabindex', '0');
                btn.addEventListener('keydown', function(e) {
                  if ((e.key === 'Enter' || e.key === ' ') && !e.repeat) {
                    e.preventDefault();
                    btn.click();
                  }
                });
              });
            });
        // --- Loading Spinner ---
        function showSpinner(msg) {
          const el = document.getElementById('loadingSpinner');
          const text = document.getElementById('spinnerText');
          if (!el || !text) return;
          text.textContent = msg || 'Loading...';
          el.style.display = 'block';
        }
        function hideSpinner() {
          const el = document.getElementById('loadingSpinner');
          if (el) el.style.display = 'none';
        }
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
    // ===== DATA STORAGE SYSTEM =====
    const STORAGE_KEY = 'sbahle_burial_society_data';
    const ADMIN_CREDENTIALS = { username: 'admin', password: 'admin123' }; // In production, hash this!
    
    // Global variables
    window.members = [];
    window.currentUser = null;
    
    // Initialize demo data
    function initializeDemoData() {
      // Initialize demo members if not exists
      if (!localStorage.getItem('members')) {
        const demoMembers = [
          { id: 'MEM001', name: 'Thabo Mkhize', email: 'member@test.com', phone: '0721234567', idNum: '8712345678901', status: 'Active', missedPayments: 0 },
          { id: 'MEM002', name: 'Nomsa Dlamini', email: 'nomsa@test.com', phone: '0731234567', idNum: '9012345678901', status: 'Active', missedPayments: 0 },
          { id: 'MEM003', name: 'Sipho Ndlela', email: 'sipho@test.com', phone: '0741234567', idNum: '7812345678901', status: 'Suspended', missedPayments: 3 }
        ];
        localStorage.setItem('members', JSON.stringify(demoMembers));
      }
      
      // Load members from localStorage
      window.members = JSON.parse(localStorage.getItem('members')) || [];
      
      // Initialize other data arrays
      window.beneficiaries = [
        { id: 'B1', memberId: 'MEM001', name: 'Aisha Mkhize', relationship: 'Spouse', percentage: 50 },
        { id: 'B2', memberId: 'MEM001', name: 'Omuhle Mkhize', relationship: 'Child', percentage: 50 }
      ];
      window.payouts = [
        { id: 'PO1', memberId: 'MEM001', memberName: 'Thabo Mkhize', amount: 5000, reason: 'Funeral', status: 'Pending' }
      ];
      window.penalties = [
        { id: 'PEN1', memberId: 'MEM002', memberName: 'Nomsa Dlamini', amount: 30, date: '2025-03-10', status: 'Pending' }
      ];
      window.tempBeneficiaries = [];
      window.isDrawing = false;
      window.memberIdCounter = 4;
      
      // Initialize attendance storage
      if (!localStorage.getItem('attendance')) {
        localStorage.setItem('attendance', JSON.stringify({}));
      }
    }
    
    // Simple encryption/decryption (for basic security - use proper encryption in production)
    function encryptData(data) {
      try {
        const jsonStr = JSON.stringify(data);
        return btoa(jsonStr); // Base64 encoding (basic obfuscation)
      } catch (e) {
        console.error('Encryption error:', e);
        return null;
      }
    }
    
    function decryptData(encrypted) {
      try {
        const jsonStr = atob(encrypted);
        return JSON.parse(jsonStr);
      } catch (e) {
        console.error('Decryption error:', e);
        return null;
      }
    }
    
    // Save all data to localStorage
    function saveDataToStorage() {
      try {
        const data = {
          members: window.members || [],
          beneficiaries: window.beneficiaries || [],
          payouts: window.payouts || [],
          penalties: window.penalties || [],
          memberIdCounter: window.memberIdCounter || 4,
          lastSaved: new Date().toISOString()
        };
        const encrypted = encryptData(data);
        localStorage.setItem(STORAGE_KEY, encrypted);
        console.log('‚úì Data saved to secure storage at', data.lastSaved);
        return true;
      } catch (e) {
        console.error('Failed to save data:', e);
        showAlert('adminAlert', '‚ö† Failed to save data', 'error');
        return false;
      }
    }
    
    // Load data from localStorage
    function loadDataFromStorage() {
      try {
        const encrypted = localStorage.getItem(STORAGE_KEY);
        if (encrypted) {
          const data = decryptData(encrypted);
          if (data) {
            window.members = data.members || [];
            window.beneficiaries = data.beneficiaries || [];
            window.payouts = data.payouts || [];
            window.penalties = data.penalties || [];
            window.memberIdCounter = data.memberIdCounter || 4;
            console.log('‚úì Data loaded from storage. Last saved:', data.lastSaved);
            return true;
          }
        }
        console.log('No saved data found, initializing demo data');
        initializeDemoData();
        return false;
      } catch (e) {
        console.error('Failed to load data:', e);
        console.log('Error loading data, initializing demo data');
        initializeDemoData();
        return false;
      }
    }
    
    // Export data to JSON file
    function exportData() {
<<<<<<< HEAD
      try {
        const data = {
          members,
          beneficiaries,
          payouts,
          penalties,
          memberIdCounter,
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sbahle_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showAlert('adminAlert', '‚úì Data exported successfully!', 'success');
      } catch (e) {
        console.error('Export error:', e);
        showAlert('adminAlert', '‚ö† Failed to export data', 'error');
      }
=======
      showSpinner('Exporting data...');
      setTimeout(() => {
        try {
          const data = {
            members,
            beneficiaries,
            payouts,
            penalties,
            memberIdCounter,
            exportDate: new Date().toISOString(),
            version: '1.0'
          };
          const jsonStr = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `sbahle_backup_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showAlert('adminAlert', '‚úì Data exported successfully!', 'success');
        } catch (e) {
          console.error('Export error:', e);
          showAlert('adminAlert', '‚ö† Failed to export data', 'error');
        }
        hideSpinner();
      }, 600);
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
    }
    
    // Import data from JSON file
    function importData(file) {
<<<<<<< HEAD
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (confirm('This will replace all current data. Are you sure?')) {
            window.members = data.members || [];
            window.beneficiaries = data.beneficiaries || [];
            window.payouts = data.payouts || [];
            window.penalties = data.penalties || [];
            window.memberIdCounter = data.memberIdCounter || 4;
            saveDataToStorage();
            updateAdmin();
            showAlert('adminAlert', '‚úì Data imported successfully!', 'success');
          }
        } catch (err) {
          console.error('Import error:', err);
          showAlert('adminAlert', '‚ö† Invalid data file', 'error');
        }
=======
      showSpinner('Importing data...');
      const reader = new FileReader();
      reader.onload = function(e) {
        setTimeout(() => {
          try {
            const data = JSON.parse(e.target.result);
            if (confirm('This will replace all current data. Are you sure?')) {
              window.members = data.members || [];
              window.beneficiaries = data.beneficiaries || [];
              window.payouts = data.payouts || [];
              window.penalties = data.penalties || [];
              window.memberIdCounter = data.memberIdCounter || 4;
              saveDataToStorage();
              updateAdmin();
              showAlert('adminAlert', '‚úì Data imported successfully!', 'success');
            }
          } catch (err) {
            console.error('Import error:', err);
            showAlert('adminAlert', '‚ö† Invalid data file', 'error');
          }
          hideSpinner();
        }, 600);
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
      };
      reader.readAsText(file);
    }
    
    // Clear all data (with confirmation)
    function clearAllData() {
      if (confirm('‚ö† WARNING: This will delete ALL data permanently. Are you sure?')) {
        if (confirm('This action cannot be undone. Continue?')) {
<<<<<<< HEAD
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
=======
          showSpinner('Clearing all data...');
          setTimeout(() => {
            localStorage.removeItem(STORAGE_KEY);
            hideSpinner();
            location.reload();
          }, 800);
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
        }
      }
    }
    
    // Initialize data immediately and also on page load
    initializeDemoData();
    
    // CANVAS
    window.addEventListener('load', function() {
      // Initialize demo data first
      initializeDemoData();
      
      const canvas = document.getElementById('sigCanvas');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        
        canvas.addEventListener('mousedown', (e) => { 
          isDrawing = true;
          const rect = canvas.getBoundingClientRect();
          ctx.beginPath();
          ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        });
        canvas.addEventListener('mousemove', (e) => {
          if (!isDrawing) return;
          const rect = canvas.getBoundingClientRect();
          ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
          ctx.stroke();
        });
        canvas.addEventListener('mouseup', () => { isDrawing = false; });
        canvas.addEventListener('mouseleave', () => { isDrawing = false; });
        
        // Touch support for mobile
        canvas.addEventListener('touchstart', (e) => {
          e.preventDefault();
          isDrawing = true;
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.beginPath();
          ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        });
        canvas.addEventListener('touchmove', (e) => {
          e.preventDefault();
          if (!isDrawing) return;
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
          ctx.stroke();
        });
        canvas.addEventListener('touchend', (e) => {
          e.preventDefault();
          isDrawing = false;
        });
      }
    });

    function clearSig() {
      const canvas = document.getElementById('sigCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function saveSig() {
      const signature = signatureCanvas.toDataURL();
      if (!currentUser) return;
      
      // Save signature to user data
      const member = members.find(m => m.id === currentUser.id);
      if (member) {
        member.signature = signature;
        saveDataToStorage();
        showAlert('memberAlert', '‚úì Signature saved successfully!', 'success');
        
        // Display current signature
        document.getElementById('currentSignature').style.display = 'block';
        document.getElementById('savedSignature').src = signature;
      }
    }

    // LOGIN
    function showLoginForm(type) {
      document.getElementById('adminForm').classList.toggle('hidden', type !== 'admin');
      document.getElementById('memberForm').classList.toggle('hidden', type !== 'member');
      document.getElementById('registerForm').classList.toggle('hidden', type !== 'register');
      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tabs .tab')[type === 'admin' ? 0 : type === 'member' ? 1 : 2].classList.add('active');
    }

    function loginAdmin() {
      if (document.getElementById('adminEmail').value === 'admin' && document.getElementById('adminPassword').value === 'admin123') {
        currentUser = { type: 'admin' };
        show('adminPage');
        updateAdmin();
      } else alert('Invalid');
    }

    function loginMember() {
      const m = (window.members || []).find(x => x.email === document.getElementById('memberEmail').value);
      if (m) {
        window.currentUser = m;
        // Load beneficiaries for this member from the main beneficiaries array
        window.tempBeneficiaries = JSON.parse(JSON.stringify((window.beneficiaries || []).filter(b => b.memberId === m.id)));
        console.log('Member logged in:', m.id);
        console.log('Filtered beneficiaries:', window.tempBeneficiaries);
        show('memberPage');
        updateMember();
      } else alert('Not found');
    }

    function registerMember() {
      const name = document.getElementById('regName').value;
      const email = document.getElementById('regEmail').value;
      const phone = document.getElementById('regPhone').value;
      const idNum = document.getElementById('regId').value;
      if (!name || !email || !phone || !idNum) { alert('Fill all'); return; }
      const newId = 'MEM' + String(memberIdCounter).padStart(3, '0');
      memberIdCounter++;
      members.push({ id: newId, name, email, phone, idNum, status: 'Active', missedPayments: 0 });
      saveDataToStorage(); // Auto-save
      alert('Registered!');
      showLoginForm('member');
    }

    function logout() {
      currentUser = null;
      show('loginPage');
    }

    function show(p) {
      document.getElementById('loginPage').classList.toggle('hidden', p !== 'loginPage');
      document.getElementById('adminPage').classList.toggle('hidden', p !== 'adminPage');
      document.getElementById('memberPage').classList.toggle('hidden', p !== 'memberPage');
    }

    function adminTab(t, e) {
      // Hide all tabs
      document.getElementById('overviewTab').classList.toggle('hidden', t !== 'overview');
      document.getElementById('membersTab').classList.toggle('hidden', t !== 'members');
      document.getElementById('beneficiariesTab').classList.toggle('hidden', t !== 'beneficiaries');
      document.getElementById('attendanceTab').classList.toggle('hidden', t !== 'attendance');
      document.getElementById('payoutsTab').classList.toggle('hidden', t !== 'payouts');
      document.getElementById('penaltiesTab').classList.toggle('hidden', t !== 'penalties');
      document.getElementById('dataTab').classList.toggle('hidden', t !== 'data');
      
      // Update active tab button
      document.querySelectorAll('#adminPage .tab').forEach(x => x.classList.remove('active'));
      if (e && e.target) e.target.classList.add('active');
      
      // Load content for active tab
      if (t === 'overview') { updateAdmin(); }
      if (t === 'members') { displayMem(); }
      if (t === 'beneficiaries') { populateBenSelect(); loadBeneficiaries(); }
      if (t === 'attendance') { showAttendanceList(); }
      if (t === 'payouts') { displayPayouts(); }
        if (t === 'payouts') { renderAdminContributions(); }
      if (t === 'penalties') { displayPenalties(); }
      if (t === 'data') { updateStorageInfo(); }
    }
    
    function updateStorageInfo() {
      document.getElementById('storageMembers').textContent = window.members ? window.members.length : 0;
      document.getElementById('storageBeneficiaries').textContent = window.beneficiaries ? window.beneficiaries.length : 0;
      document.getElementById('storagPayouts').textContent = window.payouts ? window.payouts.length : 0;
      document.getElementById('storagePenalties').textContent = window.penalties ? window.penalties.length : 0;
    }

    function memberTab(t, e) {
      document.getElementById('profileTab').classList.toggle('hidden', t !== 'profile');
      document.getElementById('contributionsTab').classList.toggle('hidden', t !== 'contributions');
      document.getElementById('memberBeneficiariesTab').classList.toggle('hidden', t !== 'beneficiaries');
      document.getElementById('documentsTab').classList.toggle('hidden', t !== 'documents');
      document.getElementById('signatureTab').classList.toggle('hidden', t !== 'signature');
      document.getElementById('memberPayoutsTab').classList.toggle('hidden', t !== 'payouts');
      document.querySelectorAll('#memberPage .tab').forEach(x => x.classList.remove('active'));
      if (e && e.target) e.target.classList.add('active');
      if (t === 'profile') { updateMember(); }
      if (t === 'contributions') { /* Contributions tab - static content */ }
      if (t === 'beneficiaries') {
        // Refresh tempBeneficiaries from the main beneficiaries array
        window.tempBeneficiaries = JSON.parse(JSON.stringify((window.beneficiaries || []).filter(b => b.memberId === currentUser.id)));
        console.log('Beneficiaries tab clicked, count:', tempBeneficiaries.length);
        console.log('Beneficiaries data:', tempBeneficiaries);
        // Wait for the tab to be visible before rendering
        setTimeout(() => {
          console.log('Calling displayMemBen after tab is visible');
          displayMemBen();
        }, 50);
      }
      if (t === 'payouts') displayMemPayouts();
    }

    function updateAdmin() {
      const membersList = window.members || [];
      document.getElementById('totalMem').textContent = membersList.length;
      document.getElementById('activeMem').textContent = membersList.filter(m => m.status === 'Active').length;
      document.getElementById('suspMem').textContent = membersList.filter(m => m.status === 'Suspended').length;
    }

    function updateMember() {
      document.getElementById('memId').textContent = currentUser.id;
      document.getElementById('profName').value = currentUser.name;
      document.getElementById('profEmail').value = currentUser.email;
      document.getElementById('profPhone').value = currentUser.phone;
      const badge = document.getElementById('memStatus');
      badge.textContent = currentUser.status;
      badge.className = `badge badge-${currentUser.status === 'Active' ? 'active' : 'suspended'}`;
      // Make sure tempBeneficiaries is loaded from the main beneficiaries array
      if (!window.tempBeneficiaries || window.tempBeneficiaries.length === 0) {
        window.tempBeneficiaries = JSON.parse(JSON.stringify((window.beneficiaries || []).filter(b => b.memberId === currentUser.id)));
        console.log('updateMember: loaded', window.tempBeneficiaries.length, 'beneficiaries');
      }
    }

    function displayMem() {
      let html = '';
      (window.members || []).forEach(m => {
        html += `<tr style="display: table-row; height: 45px; border-bottom: 1px solid #ddd; background: white;">
          <td style="display
      (window.payouts || []).forEach(p => {
        html += `<tr style="display: table-row; height: 45px; border-bottom: 1px solid #ddd; background: white;">
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;">${p.memberName}</td>
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;">R ${p.amount}</td>
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;">${p.reason}</td>
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;"><span class="badge badge-${p.status === 'Pending' ? 'pending' : 'approved'}">${p.status}</span></td>
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;">
            ${p.status === 'Pending' ? `<button class="btn btn-success btn-sm" onclick="appPayout('${p.id}')">Approve</button> <button class="btn btn-danger btn-sm" onclick="rejPayout('${p.id}')">Reject</button>` : '-'}
          </td>
        </tr>`;
      });
      document.getElementById('payTable').innerHTML = html;
    }

    function displayPenalties() {
      let html = '';
      (window.penalties || []).forEach(p => {
        html += `<tr style="display: table-row; height: 45px; border-bottom: 1px solid #ddd; background: white;">
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;">${p.memberName}</td>
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;">R ${p.amount}</td>
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;">${p.date}</td>
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;"><span class="badge badge-${p.status === 'Pending' ? 'pending' : 'approved'}">${p.status}</span></td>
          <td style="display: table-cell; padding: 12px; border: 1px solid #ddd;">
            <button class="btn btn-success btn-sm" onclick="payPen('${p.id}')">Mark Paid</button>
          </td>
        </tr>`;
      });
      document.getElementById('penTable').innerHTML = html;
    }

    function populateBenSelect() {
      let opts = '<option value="">-- Select --</option>';
      (window.members || []).forEach(m => opts += `<option value="${m.id}">${m.name}</option>`);
      document.getElementById('memSelectBen').innerHTML = opts;
    }

    function loadBeneficiaries() {
      const id = document.getElementById('memSelectBen').value;
      document.getElementById('addBenBtn').style.display = id ? 'block' : 'none';
      const bens = (window.beneficiaries || []).filter(b => b.memberId === id);
      let html = '';
      if (bens.length > 0) {
        bens.forEach(b => {
          html += `<tr><td>${b.name}</td><td>${b.relationship}</td><td>${b.idNum}</td><td>${b.percentage}%</td><td>
            <button class="btn btn-primary btn-sm" onclick="editBen('${b.id}')">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="delBen('${b.id}')">Delete</button>
          </td></tr>`;
        });
      } else if (id) {
        html = '<tr><td colspan="5" style="text-align: center; color: #999;">No beneficiaries added for this member</td></tr>';
      } else {
        html = '<tr><td colspan="5" style="text-align: center; color: #999;">Please select a member</td></tr>';
      }
      document.getElementById('benTableBody').innerHTML = html;
    }

    function displayMemBen() {
      const tempBens = window.tempBeneficiaries || [];
      const tbody = document.getElementById('memBenTableBody');
      
      if (!tbody) return;
      
      let html = '';
      
      if (tempBens && tempBens.length > 0) {
        tempBens.forEach((b, i) => {
          html += '<tr>';
          html += '<td>' + (b.name || 'N/A') + '</td>';
          html += '<td>' + (b.relationship || 'N/A') + '</td>';
          html += '<td>' + (b.idNum || 'N/A') + '</td>';
          html += '<td><strong>' + (b.percentage || 0) + '%</strong></td>';
          html += '<td><button class="btn btn-danger btn-sm" onclick="removeMemBen(' + i + ')">Remove</button></td>';
          html += '</tr>';
        });
      } else {
        html = '<tr><td colspan="5" style="text-align: center; color: #999;">No beneficiaries added yet</td></tr>';
      }
      
      tbody.innerHTML = html;
      
      // Update button visibility
      const addBtn = document.getElementById('addBenMemBtn');
      const saveBtn = document.getElementById('saveBenMemBtn');
      
      if (addBtn) {
        if (tempBeneficiaries.length >= 5) {
          addBtn.classList.add('hidden');
        } else {
          addBtn.classList.remove('hidden');
        }
      }
      
      if (saveBtn) {
        if (tempBeneficiaries.length > 0) {
          saveBtn.classList.remove('hidden');
        } else {
          saveBtn.classList.add('hidden');
        }
      }
    }

    function removeMemBen(idx) {
      tempBeneficiaries.splice(idx, 1);
      displayMemBen();
      showAlert('memberAlert', '‚úì Beneficiary removed', 'success');
    }

    function displayMemPayouts() {
      let html = '';
      (window.payouts || []).filter(p => p.memberId === currentUser.id).forEach(p => {
        html += `<tr><td>${p.date || 'N/A'}</td><td>R ${p.amount}</td><td>${p.reason}</td><td><span class="badge badge-${p.status === 'Pending' ? 'pending' : 'approved'}">${p.status}</span></td></tr>`;
      });
      document.getElementById('memPayTable').innerHTML = html || '<tr><td colspan="4">No payouts</td></tr>';
    }

    // MODALS
    function openModal(html) {
      document.getElementById('modContent').innerHTML = html;
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
    }

    function addMemberModal() {
      openModal(`
        <h2>Add Member</h2>
        <div class="form-group"><label>Name</label><input type="text" id="newMName"></div>
        <div class="form-group"><label>Email</label><input type="text" id="newMEmail"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="newMPhone"></div>
        <div class="form-group"><label>ID</label><input type="text" id="newMId"></div>
        <button class="btn btn-success" onclick="saveMem()">Save</button>
      `);
    }

    function saveMem() {
      const name = document.getElementById('newMName').value;
      const email = document.getElementById('newMEmail').value;
      const phone = document.getElementById('newMPhone').value;
      const idNum = document.getElementById('newMId').value;
      if (!name || !email || !phone || !idNum) { alert('Fill all'); return; }
      const newId = 'MEM' + String(memberIdCounter).padStart(3, '0');
      memberIdCounter++;
      members.push({ id: newId, name, email, phone, idNum, status: 'Active', missedPayments: 0 });
      saveDataToStorage(); // Auto-save
      closeModal();
      displayMem();
      updateAdmin();
      showAlert('adminAlert', '‚úì Member added!', 'success');
    }

    function editMemModal(id) {
      const m = members.find(x => x.id === id);
      openModal(`
        <h2>Edit Member</h2>
        <div class="form-group"><label>Name</label><input type="text" id="editMName" value="${m.name}"></div>
        <div class="form-group"><label>Email</label><input type="text" id="editMEmail" value="${m.email}"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="editMPhone" value="${m.phone}"></div>
        <div class="form-group"><label>Status</label><select id="editMStatus"><option value="Active" ${m.status === 'Active' ? 'selected' : ''}>Active</option><option value="Suspended" ${m.status === 'Suspended' ? 'selected' : ''}>Suspended</option></select></div>
        <button class="btn btn-primary" onclick="updateMem('${id}')">Update</button>
      `);
    }

    function updateMem(id) {
      const m = members.find(x => x.id === id);
      m.name = document.getElementById('editMName').value;
      m.email = document.getElementById('editMEmail').value;
      m.phone = document.getElementById('editMPhone').value;
      m.status = document.getElementById('editMStatus').value;
<<<<<<< HEAD
      saveDataToStorage(); // Auto-save
      closeModal();
      displayMem();
      showAlert('adminAlert', '‚úì Updated!', 'success');
=======
      showSyncStatus('Updating cloud...');
      window.firebaseUpdateMember(m)
        .then(() => {
          closeModal();
          displayMem();
          showAlert('adminAlert', '‚úì Updated (cloud sync)!', 'success');
          showSyncStatus('Cloud synced', true);
        })
        .catch(err => {
          showAlert('adminAlert', 'Cloud sync failed, saving locally.', 'error');
          saveDataToStorage();
          closeModal();
          displayMem();
          showSyncStatus('Saved locally', false);
        });
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
    }

    function delMem(id) {
      if (confirm('Delete member?')) {
<<<<<<< HEAD
        window.members = members.filter(m => m.id !== id);
        window.beneficiaries = beneficiaries.filter(b => b.memberId !== id);
        window.payouts = payouts.filter(p => p.memberId !== id);
        saveDataToStorage(); // Auto-save
        displayMem();
        updateAdmin();
        showAlert('adminAlert', '‚úì Deleted!', 'success');
=======
        showSyncStatus('Deleting from cloud...');
        window.firebaseDeleteMember(id)
          .then(() => {
            displayMem();
            updateAdmin();
            showAlert('adminAlert', '‚úì Deleted (cloud sync)!', 'success');
            showSyncStatus('Cloud synced', true);
          })
          .catch(err => {
            showAlert('adminAlert', 'Cloud sync failed, deleting locally.', 'error');
            window.members = members.filter(m => m.id !== id);
            window.beneficiaries = beneficiaries.filter(b => b.memberId !== id);
            window.payouts = payouts.filter(p => p.memberId !== id);
            saveDataToStorage();
            displayMem();
            updateAdmin();
            showSyncStatus('Deleted locally', false);
          });
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
      }
    }

    function reactMem(id) {
      const m = members.find(x => x.id === id);
      if (m) {
        m.status = 'Active';
        m.missedPayments = 0;
<<<<<<< HEAD
        saveDataToStorage(); // Auto-save
        displayMem();
        updateAdmin();
        showAlert('adminAlert', '‚úì Reactivated!', 'success');
      }
=======
        showSyncStatus('Reactivating in cloud...');
        window.firebaseUpdateMember(m)
          .then(() => {
            displayMem();
            updateAdmin();
            showAlert('adminAlert', '‚úì Reactivated (cloud sync)!', 'success');
            showSyncStatus('Cloud synced', true);
          })
          .catch(err => {
            showAlert('adminAlert', 'Cloud sync failed, saving locally.', 'error');
            saveDataToStorage();
            displayMem();
            updateAdmin();
            showSyncStatus('Saved locally', false);
          });
      }
        // --- Cloud Sync Status Indicator ---
        function showSyncStatus(msg, ok) {
          const el = document.getElementById('cloudSyncStatus');
          const icon = document.getElementById('cloudSyncIcon');
          const text = document.getElementById('cloudSyncText');
          if (!el || !icon || !text) return;
          el.style.display = 'flex';
          text.textContent = msg;
          icon.textContent = ok === undefined ? '‚òÅÔ∏è' : (ok ? '‚úÖ' : '‚ö†Ô∏è');
          setTimeout(() => { el.style.display = 'none'; }, 2000);
        }
>>>>>>> d27854a (Allow any ID number length for beneficiaries)
    }

    function addBenModal() {
      const memId = document.getElementById('memSelectBen').value;
      const m = members.find(x => x.id === memId);
      const count = beneficiaries.filter(b => b.memberId === memId).length;
      if (count >= 5) { alert('Max 5 beneficiaries'); return; }
      openModal(`
        <h2>Add Beneficiary for ${m.name}</h2>
        <div class="form-group"><label>Name</label><input type="text" id="benName"></div>
        <div class="form-group"><label>Relationship</label><select id="benRel"><option>Spouse</option><option>Child</option><option>Parent</option><option>Sibling</option></select></div>
        <div class="form-group"><label>Percentage (%)</label><input type="number" id="benPerc" min="0" max="100"></div>
        <button class="btn btn-success" onclick="saveBen('${memId}')">Save</button>
      `);
    }

    function saveBen(memId) {
      const name = document.getElementById('benName').value;
      const rel = document.getElementById('benRel').value;
      const perc = document.getElementById('benPerc').value;
      if (!name || !rel || !perc) { alert('Fill all'); return; }
      beneficiaries.push({ id: 'B' + Date.now(), memberId: memId, name, relationship: rel, percentage: parseInt(perc) });
      saveDataToStorage(); // Auto-save
      closeModal();
      loadBeneficiaries();
      showAlert('adminAlert', '‚úì Beneficiary added!', 'success');
    }

    function editBen(id) {
      const b = beneficiaries.find(x => x.id === id);
      openModal(`
        <h2>Edit Beneficiary</h2>
        <div class="form-group"><label>Percentage</label><input type="number" id="editPerc" value="${b.percentage}"></div>
        <button class="btn btn-primary" onclick="updateBen('${id}')">Update</button>
      `);
    }

    function updateBen(id) {
      const b = beneficiaries.find(x => x.id === id);
      b.percentage = parseInt(document.getElementById('editPerc').value);
      saveDataToStorage(); // Auto-save
      closeModal();
      loadBeneficiaries();
      showAlert('adminAlert', '‚úì Updated!', 'success');
    }

    function delBen(id) {
      if (confirm('Delete beneficiary?')) {
        beneficiaries = beneficiaries.filter(b => b.id !== id);
        saveDataToStorage(); // Auto-save
        loadBeneficiaries();
        showAlert('adminAlert', '‚úì Deleted!', 'success');
      }
    }

    function appPayout(id) {
      const p = payouts.find(x => x.id === id);
      if (p) {
        p.status = 'Approved';
        saveDataToStorage(); // Auto-save
        displayPayouts();
        showAlert('adminAlert', '‚úì Payout approved!', 'success');
      }
    }

    function rejPayout(id) {
      const p = payouts.find(x => x.id === id);
      if (p) {
        p.status = 'Rejected';
        saveDataToStorage(); // Auto-save
        displayPayouts();
        showAlert('adminAlert', '‚úì Payout rejected!', 'success');
      }
    }

    function payPen(id) {
      const p = penalties.find(x => x.id === id);
      if (p) {
        p.status = 'Paid';
        saveDataToStorage(); // Auto-save
        displayPenalties();
        showAlert('adminAlert', '‚úì Marked as paid!', 'success');
      }
    }

    function checkMissed() {
      members.forEach(m => {
        if (m.missedPayments >= 3) m.status = 'Suspended';
      });
      saveDataToStorage(); // Auto-save
      displayMem();
      updateAdmin();
      showAlert('adminAlert', '‚úì Checked! Members with 3+ missed payments suspended', 'success');
    }

    function applyPen() {
      const today = new Date();
      if (today.getDate() >= 8) {
        members.forEach(m => {
          if (m.status === 'Active' && !penalties.find(p => p.memberId === m.id && p.date === today.toISOString().split('T')[0])) {
            penalties.push({
              id: 'PEN' + Date.now(),
              memberId: m.id,
              memberName: m.name,
              amount: 30,
              date: today.toISOString().split('T')[0],
              status: 'Pending'
            });
          }
        });
        saveDataToStorage(); // Auto-save
        displayPenalties();
        showAlert('adminAlert', '‚úì R30 penalty applied to all active members!', 'success');
      } else {
        showAlert('adminAlert', 'Penalties only apply after 8th of month', 'warning');
      }
    }

    // MEMBER FUNCTIONS
    function editProf() {
      document.getElementById('profName').disabled = false;
      document.getElementById('profEmail').disabled = false;
      document.getElementById('profPhone').disabled = false;
      document.getElementById('saveProf').classList.remove('hidden');
    }

    function saveProf() {
      currentUser.name = document.getElementById('profName').value;
      currentUser.email = document.getElementById('profEmail').value;
      currentUser.phone = document.getElementById('profPhone').value;
      document.getElementById('profName').disabled = true;
      document.getElementById('profEmail').disabled = true;
      document.getElementById('profPhone').disabled = true;
      document.getElementById('saveProf').classList.add('hidden');
      showAlert('memberAlert', '‚úì Profile updated!', 'success');
    }

    function addContribModal() {
      openModal(`
        <h2>Add Contribution</h2>
        <div class="alert alert-warning">Minimum: R 170.00</div>
        <div class="form-group"><label>Amount (R)</label><input type="number" id="contAmt" min="170" value="170"></div>
        <div class="form-group"><label>Method</label><select id="contMeth"><option>Bank Transfer</option><option>EFT</option><option>Cash</option></select></div>
        <div class="form-group"><label>Reference</label><input type="text" id="contRef"></div>
        <button class="btn btn-success" onclick="submitContrib()">Submit</button>
      `);
    }

    function submitContrib() {
      const amt = parseFloat(document.getElementById('contAmt').value);
      if (amt < 170) { alert('Minimum R 170'); return; }
      closeModal();
      showAlert('memberAlert', '‚úì Contribution submitted! Pending verification', 'success');
    }

    function addBenMemModal() {
      if (tempBeneficiaries.length >= 5) { alert('Max 5'); return; }
      openModal(`
        <h2>Add Beneficiary</h2>
        <div class="form-group"><label>Name</label><input type="text" id="memBenName"></div>
        <div class="form-group"><label>Relationship</label><select id="memBenRel"><option>Spouse</option><option>Child</option><option>Parent</option><option>Sibling</option></select></div>
        <div class="form-group"><label>Percentage (%)</label><input type="number" id="memBenPerc" min="0" max="100"></div>
        <button class="btn btn-success" onclick="addMemBen()">Add</button>
      `);
    }

    function addMemBen() {
      const name = document.getElementById('memBenName').value;
      const rel = document.getElementById('memBenRel').value;
      const perc = document.getElementById('memBenPerc').value;
      if (!name || !rel || !perc) { alert('Fill all'); return; }
      tempBeneficiaries.push({ id: 'BT' + Date.now(), memberId: currentUser.id, name, relationship: rel, percentage: parseInt(perc) });
      closeModal();
      displayMemBen();
      document.getElementById('saveBenMemBtn').classList.remove('hidden');
      showAlert('memberAlert', '‚úì Beneficiary added! Click Save to lock', 'success');
    }

    function saveBenMem() {
      // Validate total percentage equals 100%
      const total = tempBeneficiaries.reduce((sum, b) => sum + b.percentage, 0);
      if (total !== 100) {
        showAlert('memberAlert', `‚ö† Total allocation must equal 100%. Current total: ${total}%`, 'error');
        return;
      }
      
      // Validate we have at least one beneficiary
      if (tempBeneficiaries.length === 0) {
        showAlert('memberAlert', '‚ö† Please add at least one beneficiary', 'error');
        return;
      }
      
      tempBeneficiaries.forEach(b => {
        if (!beneficiaries.find(x => x.id === b.id)) {
          beneficiaries.push(b);
        }
      });
      saveDataToStorage(); // Auto-save
      document.getElementById('saveBenMemBtn').classList.add('hidden');
      document.getElementById('addBenMemBtn').classList.add('hidden');
      showAlert('memberAlert', '‚úì Beneficiaries locked! Cannot modify', 'success');
    }

    function saveDocs() {
      const payFile = document.getElementById('payFile').files[0];
      const deathFile = document.getElementById('deathFile').files[0];
      const suppFile = document.getElementById('suppFile').files[0];
      if (!payFile && !deathFile && !suppFile) { alert('Select at least one file'); return; }
      showAlert('memberAlert', '‚úì Documents uploaded successfully!', 'success');
      document.getElementById('payFile').value = '';
      document.getElementById('deathFile').value = '';
      document.getElementById('suppFile').value = '';
    }

    function reqPayoutModal() {
      openModal(`
        <h2>Request Payout</h2>
        <div class="form-group"><label>Amount (R)</label><input type="number" id="payoutAmt" min="100"></div>
        <div class="form-group"><label>Reason</label><input type="text" id="payoutReason"></div>
        <button class="btn btn-success" onclick="submitPayout()">Submit Request</button>
      `);
    }

    function submitPayout() {
      const amt = document.getElementById('payoutAmt').value;
      const reason = document.getElementById('payoutReason').value;
      if (!amt || !reason) { alert('Fill all'); return; }
      payouts.push({
        id: 'PO' + Date.now(),
        memberId: currentUser.id,
        memberName: currentUser.name,
        amount: parseInt(amt),
        reason: reason,
        status: 'Pending',
        date: new Date().toISOString().split('T')[0]
      });
      saveDataToStorage(); // Auto-save
      closeModal();
      displayMemPayouts();
      showAlert('memberAlert', '‚úì Payout requested! Awaiting admin approval', 'success');
    }

    function showAlert(id, msg, type) {
      const el = document.getElementById(id);
      if (el) {
        el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        setTimeout(() => el.innerHTML = '', 4000);
      }
    }

    // Signature Canvas Setup
    let signatureCanvas;
    let signatureCtx;
    let lastX = 0;
    let lastY = 0;

    function setupSignatureCanvas() {
      signatureCanvas = document.getElementById('signatureCanvas');
      signatureCtx = signatureCanvas.getContext('2d');
      signatureCtx.strokeStyle = '#000';
      signatureCtx.lineWidth = 2;
      signatureCtx.lineCap = 'round';

      signatureCanvas.addEventListener('mousedown', startDrawing);
      signatureCanvas.addEventListener('mousemove', draw);
      signatureCanvas.addEventListener('mouseup', stopDrawing);
      signatureCanvas.addEventListener('mouseout', stopDrawing);

      // Touch events for mobile
      signatureCanvas.addEventListener('touchstart', handleTouch);
      signatureCanvas.addEventListener('touchmove', handleTouch);
      signatureCanvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e) {
      isDrawing = true;
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }

    function draw(e) {
      if (!isDrawing) return;
      signatureCtx.beginPath();
      signatureCtx.moveTo(lastX, lastY);
      signatureCtx.lineTo(e.offsetX, e.offsetY);
      signatureCtx.stroke();
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }

    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = signatureCanvas.getBoundingClientRect();
      const offsetX = touch.clientX - rect.left;
      const offsetY = touch.clientY - rect.top;

      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });

      if (e.type === 'touchstart') {
        startDrawing({ offsetX, offsetY });
      } else if (e.type === 'touchmove') {
        draw({ offsetX, offsetY });
      }
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function clearSignature() {
      signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }

    function saveSignature() {
      const signature = signatureCanvas.toDataURL();
      if (!currentUser) return;
      
      // Save signature to user data
      const member = members.find(m => m.id === currentUser.id);
      if (member) {
        member.signature = signature;
        saveDataToStorage();
        showAlert('memberAlert', '‚úì Signature saved successfully!', 'success');
        
        // Display current signature
        document.getElementById('currentSignature').style.display = 'block';
        document.getElementById('savedSignature').src = signature;
      }
    }

    // Device and Location Detection
    function detectDeviceAndLocation() {
      // Device detection
      const userAgent = navigator.userAgent;
      let deviceInfo = 'Desktop';
      if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {
        deviceInfo = 'Mobile';
      } else if (/iPad|Macintosh/i.test(userAgent) && navigator.maxTouchPoints > 0) {
        deviceInfo = 'Tablet';
      }
      document.querySelector('#deviceInfo span').textContent = `${deviceInfo} - ${navigator.platform}`;

      // Location detection
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude } = position.coords;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
              .then(response => response.json())
              .then(data => {
                const location = data.display_name.split(',')[0];
                document.querySelector('#locationInfo span').textContent = location;
              })
              .catch(() => {
                document.querySelector('#locationInfo span').textContent = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
              });
          },
          () => {
            document.querySelector('#locationInfo span').textContent = 'Location access denied';
          }
        );
      }
    }

    // Search and Filter Functions
    function filterMembers() {
      const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const sortBy = document.getElementById('sortBy').value;
      const date = document.getElementById('meetingDate').value;
      const attendance = JSON.parse(localStorage.getItem('attendance'));

      let filteredMembers = [...members];

      // Apply search filter
      if (searchTerm) {
        filteredMembers = filteredMembers.filter(member => 
          member.name.toLowerCase().includes(searchTerm) ||
          member.id.toLowerCase().includes(searchTerm)
        );
      }

      // Apply status filter
      if (statusFilter !== 'all' && attendance[date]) {
        filteredMembers = filteredMembers.filter(member => {
          const isPresent = attendance[date].present.includes(member.id);
          if (statusFilter === 'present') return isPresent;
          if (statusFilter === 'absent') return !isPresent;
          if (statusFilter === 'nosig') return isPresent && !member.signature;
          return true;
        });
      }

      // Apply sorting
      filteredMembers.sort((a, b) => {
        if (sortBy === 'name') {
          return a.name.localeCompare(b.name);
        } else if (sortBy === 'time' && attendance[date]) {
          const timeA = attendance[date].timeIn?.[a.id] || '';
          const timeB = attendance[date].timeIn?.[b.id] || '';
          return timeB.localeCompare(timeA);
        } else if (sortBy === 'status' && attendance[date]) {
          const statusA = attendance[date].present.includes(a.id);
          const statusB = attendance[date].present.includes(b.id);
          return statusB - statusA;
        }
        return 0;
      });

      // Update table
      updateAttendanceTable(filteredMembers);
    }

    function updateAttendanceTable(filteredMembers) {
      const date = document.getElementById('meetingDate').value;
      const attendance = JSON.parse(localStorage.getItem('attendance'));
      const tbody = document.getElementById('attendanceTableBody');
      tbody.innerHTML = '';

      filteredMembers.forEach((member, index) => {
        const isPresent = attendance[date].present.includes(member.id);
        const timeIn = attendance[date].timeIn[member.id] || '';
        const remarks = attendance[date].remarks[member.id] || '';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${member.name}</td>
          <td>
            <button class="btn ${isPresent ? 'btn-success' : 'btn-danger'}" 
                    onclick="toggleAttendance('${member.id}', '${date}', ${!isPresent})" 
                    style="width: 100px;">
              ${isPresent ? '‚úì Present' : '‚úó Absent'}
            </button>
          </td>
          <td>${isPresent ? 
            `<input type="time" value="${timeIn}" 
                    onchange="updateTimeIn('${member.id}', '${date}', this.value)">` : 
            '-'}
          </td>
          <td>
            ${isPresent ? 
              `<input type="text" placeholder="Add remarks" value="${remarks}"
                      onchange="updateRemarks('${member.id}', '${date}', this.value)">` : 
              '-'}
          </td>
          <td>
            ${member.signature ? 
              `<img src="${member.signature}" style="max-height: 50px;">` : 
              isPresent ? '<span style="color: #e53e3e;">No signature</span>' : '-'}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Analytics Functions
    function toggleAnalytics() {
      const analyticsSection = document.getElementById('analyticsSection');
      const showAnalyticsBtn = document.getElementById('showAnalyticsBtn');
      
      if (analyticsSection.style.display === 'none') {
        analyticsSection.style.display = 'block';
        showAnalyticsBtn.style.display = 'none';
        generateAttendanceAnalytics();
      } else {
        analyticsSection.style.display = 'none';
        showAnalyticsBtn.style.display = 'block';
      }
    }

    function generateAttendanceAnalytics() {
      const attendance = JSON.parse(localStorage.getItem('attendance')) || {};
      const dates = Object.keys(attendance).sort();
      
      // Monthly Trend Data
      const monthlyData = {};
      dates.forEach(date => {
        const month = date.substring(0, 7); // YYYY-MM
        if (!monthlyData[month]) {
          monthlyData[month] = {
            total: 0,
            present: 0
          };
        }
        monthlyData[month].total += members.length;
        monthlyData[month].present += attendance[date].present.length;
      });

      // Member Participation Data
      const memberData = {};
      members.forEach(member => {
        memberData[member.id] = {
          name: member.name,
          attended: 0,
          total: dates.length
        };
      });

      dates.forEach(date => {
        attendance[date].present.forEach(memberId => {
          if (memberData[memberId]) {
            memberData[memberId].attended++;
          }
        });
      });

      // Draw Charts
      drawAttendanceTrendChart(monthlyData);
      drawMemberParticipationChart(memberData);
    }

    function drawAttendanceTrendChart(monthlyData) {
      const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
      const months = Object.keys(monthlyData);
      const rates = months.map(month => 
        (monthlyData[month].present / monthlyData[month].total) * 100
      );

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: months.map(m => m.substring(5) + '/' + m.substring(0, 4)),
          datasets: [{
            label: 'Monthly Attendance Rate (%)',
            data: rates,
            borderColor: '#667eea',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function drawMemberParticipationChart(memberData) {
      const ctx = document.getElementById('memberParticipationChart').getContext('2d');
      const members = Object.values(memberData);
      const rates = members.map(m => (m.attended / m.total) * 100);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: members.map(m => m.name),
          datasets: [{
            label: 'Participation Rate (%)',
            data: rates,
            backgroundColor: '#667eea'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function showAttendanceList() {
      // Initialize members if not already done
      if (!members || members.length === 0) {
        initializeDemoData();
      }
      
      // Detect device and location
      detectDeviceAndLocation();

      const date = document.getElementById('meetingDate').value;
      if (!date) {
        document.getElementById('meetingDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('meetingTime').value = new Date().toTimeString().slice(0,5);
        showAlert('adminAlert', 'Today\'s date has been automatically selected', 'success');
        return;
      }

      showSpinner('Syncing attendance...');
      window.firebaseGetAttendance(date)
        .then(attendance => {
          hideSpinner();
          if (!attendance) {
            attendance = {
              date: date,
              time: document.getElementById('meetingTime').value || '09:00',
              type: document.getElementById('meetingType').value || 'general',
              description: document.getElementById('meetingDesc').value || '',
              present: [],
              timeIn: {},
              remarks: {}
            };
          }
          
          // Show attendance table
          const tbody = document.getElementById('attendanceTableBody');
          tbody.innerHTML = '';

          // Sort members by name
          const sortedMembers = [...members].sort((a, b) => a.name.localeCompare(b.name));

          sortedMembers.forEach((member, index) => {
            const isPresent = attendance.present.includes(member.id);
            const timeIn = attendance.timeIn?.[member.id] || '';
            const remarks = attendance.remarks?.[member.id] || '';
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${member.name}</td>
              <td>
                <button class="btn ${isPresent ? 'btn-success' : 'btn-danger'}" 
                        onclick="toggleAttendance('${member.id}', '${date}', ${!isPresent})" 
                        style="width: 100px;">
                  ${isPresent ? '‚úì Present' : '‚úó Absent'}
                </button>
              </td>
              <td>${isPresent ? 
                `<input type="time" value="${timeIn}" 
                        onchange="updateTimeIn('${member.id}', '${date}', this.value)">` : 
                '-'}
              </td>
              <td>
                ${isPresent ? 
                  `<input type="text" placeholder="Add remarks" value="${remarks}"
                          onchange="updateRemarks('${member.id}', '${date}', this.value)">` : 
                  '-'}
              </td>
              <td>
                ${member.signature ? 
                  `<img src="${member.signature}" style="max-height: 50px;">` : 
                  isPresent ? '<span style="color: #e53e3e;">No signature</span>' : '-'}
              </td>
            `;
            tbody.appendChild(row);
          });

          // Update counts
          const presentCount = attendance.present.length;
          const absentCount = members.length - presentCount;
          const attendanceRate = Math.round((presentCount / members.length) * 100);
          
          document.getElementById('presentCount').textContent = `Present: ${presentCount}`;
          document.getElementById('absentCount').textContent = `Absent: ${absentCount}`;
          document.getElementById('attendanceRate').textContent = `Attendance Rate: ${attendanceRate}%`;

          // Update meeting details fields
          document.getElementById('meetingTime').value = attendance.time || '';
          document.getElementById('meetingType').value = attendance.type || 'general';
          document.getElementById('meetingDesc').value = attendance.description || '';

          // Show meeting history
          showMeetingHistory();

          // Save data
          localStorage.setItem('attendance', JSON.stringify(attendance));
        })
        .catch(err => {
          hideSpinner();
          showAlert('adminAlert', 'Cloud sync failed, loading local data.', 'error');
          // fallback to local
          const attendance = JSON.parse(localStorage.getItem('attendance'));
          if (!attendance[date]) {
            attendance[date] = {
              date: date,
              time: document.getElementById('meetingTime').value || '09:00',
              type: document.getElementById('meetingType').value || 'general',
              description: document.getElementById('meetingDesc').value || '',
              present: [],
              timeIn: {},
              remarks: {}
            };
          }

          // Show attendance table
          const tbody = document.getElementById('attendanceTableBody');
          tbody.innerHTML = '';

          // Sort members by name
          const sortedMembers = [...members].sort((a, b) => a.name.localeCompare(b.name));

          sortedMembers.forEach((member, index) => {
            const isPresent = attendance[date].present.includes(member.id);
            const timeIn = attendance[date].timeIn?.[member.id] || '';
            const remarks = attendance[date].remarks?.[member.id] || '';
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${member.name}</td>
              <td>
                <button class="btn ${isPresent ? 'btn-success' : 'btn-danger'}" 
                        onclick="toggleAttendance('${member.id}', '${date}', ${!isPresent})" 
                        style="width: 100px;">
                  ${isPresent ? '‚úì Present' : '‚úó Absent'}
                </button>
              </td>
              <td>${isPresent ? 
                `<input type="time" value="${timeIn}" 
                        onchange="updateTimeIn('${member.id}', '${date}', this.value)">` : 
                '-'}
              </td>
              <td>
                ${isPresent ? 
                  `<input type="text" placeholder="Add remarks" value="${remarks}"
                          onchange="updateRemarks('${member.id}', '${date}', this.value)">` : 
                  '-'}
              </td>
              <td>
                ${member.signature ? 
                  `<img src="${member.signature}" style="max-height: 50px;">` : 
                  isPresent ? '<span style="color: #e53e3e;">No signature</span>' : '-'}
              </td>
            `;
            tbody.appendChild(row);
          });

          // Update counts
          const presentCount = attendance[date].present.length;
          const absentCount = members.length - presentCount;
          const attendanceRate = Math.round((presentCount / members.length) * 100);
          
          document.getElementById('presentCount').textContent = `Present: ${presentCount}`;
          document.getElementById('absentCount').textContent = `Absent: ${absentCount}`;
          document.getElementById('attendanceRate').textContent = `Attendance Rate: ${attendanceRate}%`;

          // Update meeting details fields
          document.getElementById('meetingTime').value = attendance[date].time || '';
          document.getElementById('meetingType').value = attendance[date].type || 'general';
          document.getElementById('meetingDesc').value = attendance[date].description || '';

          // Show meeting history
          showMeetingHistory();
        });
    }

    function updateTimeIn(memberId, date, time) {
      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date].timeIn) attendance[date].timeIn = {};
      attendance[date].timeIn[memberId] = time;
      localStorage.setItem('attendance', JSON.stringify(attendance));
    }

    function updateRemarks(memberId, date, remarks) {
      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date].remarks) attendance[date].remarks = {};
      attendance[date].remarks[memberId] = remarks;
      localStorage.setItem('attendance', JSON.stringify(attendance));
    }

    function updateMeetingDetails() {
      const date = document.getElementById('meetingDate').value;
      if (!date) return;

      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date]) return;

      attendance[date].time = document.getElementById('meetingTime').value;
      attendance[date].type = document.getElementById('meetingType').value;
      attendance[date].description = document.getElementById('meetingDesc').value;

      localStorage.setItem('attendance', JSON.stringify(attendance));
      showAlert('adminAlert', '‚úì Meeting details updated', 'success');
    }

    function markAllPresent() {
      const date = document.getElementById('meetingDate').value;
      if (!date) return;

      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date]) return;

      const currentTime = document.getElementById('meetingTime').value || 
                         new Date().toTimeString().slice(0,5);

      members.forEach(member => {
        if (!attendance[date].present.includes(member.id)) {
          attendance[date].present.push(member.id);
        }
        if (!attendance[date].timeIn) attendance[date].timeIn = {};
        attendance[date].timeIn[member.id] = currentTime;
      });

      localStorage.setItem('attendance', JSON.stringify(attendance));
      showAttendanceList();
      showAlert('adminAlert', '‚úì Marked all members as present', 'success');
    }

    function clearAttendance() {
      const date = document.getElementById('meetingDate').value;
      if (!date) return;

      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date]) return;

      attendance[date].present = [];
      attendance[date].timeIn = {};
      attendance[date].remarks = {};

      localStorage.setItem('attendance', JSON.stringify(attendance));
      showAttendanceList();
      showAlert('adminAlert', '‚úì Attendance cleared', 'warning');
    }

    function showMeetingHistory() {
      const attendance = JSON.parse(localStorage.getItem('attendance')) || {};
      const tbody = document.getElementById('meetingHistoryBody');
      tbody.innerHTML = '';

      // Get dates and sort them in reverse chronological order
      const dates = Object.keys(attendance).sort().reverse();
      
      dates.slice(0, 5).forEach(date => {
        const meeting = attendance[date];
        const presentCount = meeting.present.length;
        const attendanceRate = Math.round((presentCount / members.length) * 100);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${new Date(date).toLocaleDateString()}</td>
          <td>${meeting.type || 'General Meeting'}</td>
          <td>${presentCount}/${members.length} (${attendanceRate}%)</td>
          <td>
            <button class="btn btn-primary btn-sm" 
                    onclick="document.getElementById('meetingDate').value='${date}'; showAttendanceList();">
              View
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function toggleAttendance(memberId, date, present) {
      const attendance = JSON.parse(localStorage.getItem('attendance'));
      
      if (!attendance[date]) {
        attendance[date] = {
          date: date,
          present: []
        };
      }

      if (present) {
        if (!attendance[date].present.includes(memberId)) {
          attendance[date].present.push(memberId);
        }
      } else {
        attendance[date].present = attendance[date].present.filter(id => id !== memberId);
      }

      localStorage.setItem('attendance', JSON.stringify(attendance));
      showAttendanceList(); // Refresh the display
      
      // Show confirmation alert
      const member = members.find(m => m.id === memberId);
      if (member) {
        showAlert('adminAlert', 
          `‚úì ${member.name} marked as ${present ? 'present' : 'absent'}`, 
          present ? 'success' : 'warning'
        );
      }
    }

    function downloadAttendanceRegister() {
      const date = document.getElementById('meetingDate').value;
      if (!date) {
        showAlert('adminAlert', '‚ö† Please select a meeting date', 'error');
        return;
      }

      const attendance = JSON.parse(localStorage.getItem('attendance'));
      if (!attendance[date]) {
        showAlert('adminAlert', '‚ö† No attendance data for selected date', 'error');
        return;
      }

      // Create a printable version
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Attendance Register - ${date}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { text-align: center; color: #333; }
              .date-info { text-align: center; color: #666; margin-bottom: 20px; }
              .meeting-info { background: #f7fafc; padding: 15px; border-radius: 8px; margin: 20px 0; }
              .stats { text-align: center; color: #666; margin: 20px 0; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { padding: 10px; text-align: left; border: 1px solid #ddd; }
              th { background: #f5f5f5; }
              .signature { max-height: 50px; }
              .no-signature { color: #e53e3e; }
              .status { font-weight: bold; }
              .present { color: #48bb78; }
              .absent { color: #f56565; }
              @media print {
                body { -webkit-print-color-adjust: exact; }
                button { display: none; }
              }
            </style>
          </head>
          <body>
            <h1>üèõÔ∏è Sbahle Burial Society</h1>
            <div class="date-info">
              <h2>Attendance Register</h2>
            </div>

            <div class="meeting-info">
              <p><strong>Date:</strong> ${new Date(date).toLocaleDateString()}</p>
              <p><strong>Time:</strong> ${attendance[date].time || 'Not specified'}</p>
              <p><strong>Meeting Type:</strong> ${attendance[date].type?.charAt(0).toUpperCase() + attendance[date].type?.slice(1) || 'General Meeting'}</p>
              ${attendance[date].description ? `<p><strong>Description:</strong> ${attendance[date].description}</p>` : ''}
            </div>
            
            <div class="stats">
              <p><strong>Attendance Summary:</strong></p>
              <p>Total Members: ${members.length} | 
                 Present: ${attendance[date].present.length} | 
                 Absent: ${members.length - attendance[date].present.length} |
                 Attendance Rate: ${Math.round((attendance[date].present.length / members.length) * 100)}%</p>
            </div>

            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Member Name</th>
                  <th>Status</th>
                  <th>Time In</th>
                  <th>Remarks</th>
                  <th>Signature</th>
                </tr>
              </thead>
              <tbody>
      `);

      // Add all members, sorted by name
      const sortedMembers = [...members].sort((a, b) => a.name.localeCompare(b.name));
      sortedMembers.forEach((member, index) => {
        const isPresent = attendance[date].present.includes(member.id);
        const timeIn = attendance[date].timeIn?.[member.id] || '';
        const remarks = attendance[date].remarks?.[member.id] || '';
        
        printWindow.document.write(`
          <tr>
            <td>${index + 1}</td>
            <td>${member.name}</td>
            <td><span class="status ${isPresent ? 'present' : 'absent'}">${isPresent ? '‚úì Present' : '‚úó Absent'}</span></td>
            <td>${isPresent ? timeIn : '-'}</td>
            <td>${isPresent ? remarks : '-'}</td>
            <td>${isPresent ? 
              (member.signature ? 
                `<img src="${member.signature}" class="signature">` : 
                '<span class="no-signature">No signature</span>'
              ) : '-'}
            </td>
          </tr>
        `);
      });

      printWindow.document.write(`
              </tbody>
            </table>
            
            <div style="margin-top: 50px;">
              <div style="float: left; width: 50%;">
                <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
              </div>
              <div style="float: right; width: 50%; text-align: right;">
                <p><strong>Secretary's Signature:</strong> _______________________</p>
                <p><strong>Chairperson's Signature:</strong> _______________________</p>
              </div>
            </div>
          </body>
        </html>
      `);

      printWindow.document.close();
      setTimeout(() => {
        printWindow.print();
        showAlert('adminAlert', '‚úì Preparing attendance register for download...', 'success');
      }, 500);
    }

    // Remove demo login credentials


  </script>
</body>
</html>